<div class="dialog-backdrop"
     (mousedown)="backdropHandler.onMouseDown($event)"
     (click)="backdropHandler.onClick($event)">
  <div class="dialog-panel dialog-panel--lg p-5" (click)="$event.stopPropagation()">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">
        {{ editVersion() ? 'Verzió szerkesztése' : 'Új verzió' }}
      </h3>
      <button class="close-btn" (click)="close.emit()">
        <lucide-icon [name]="ICONS.X" [size]="18" />
      </button>
    </div>

    <div class="form-fields">
      <!-- Drop zone -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Minta képek</label>
        <div
          class="drop-zone"
          tabindex="0"
          [class.drop-zone--active]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave()"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
          (paste)="onPaste($event)"
        >
          <lucide-icon [name]="ICONS.UPLOAD" [size]="32" class="drop-icon" />
          <p class="drop-text">Húzd ide a képeket, kattints a tallózáshoz, vagy illeszd be (Ctrl+V)</p>
          <p class="drop-hint">JPEG, PNG, WebP - max 10 MB / kép</p>
        </div>
        <input
          #fileInput
          type="file"
          accept="image/jpeg,image/png,image/webp"
          multiple
          class="hidden"
          (change)="onFileSelected($event)"
        />
      </div>

      <!-- Thumbnail grid -->
      @if (totalImageCount() > 0) {
        <div class="thumb-grid">
          <!-- Meglévő képek (edit mód) -->
          @for (img of facade.existingImages(); track img.id; let i = $index) {
            <div class="thumb-item" (click)="openLightbox(i)">
              <img [src]="img.thumbUrl" [alt]="'Kép ' + (i + 1)"  loading="lazy" />
              <button class="thumb-remove" (click)="$event.stopPropagation(); facade.removeExistingImage(img.id)">
                <lucide-icon [name]="ICONS.X" [size]="12" />
              </button>
            </div>
          }
          <!-- Új képek -->
          @for (url of facade.previewUrls(); track url; let i = $index) {
            <div class="thumb-item thumb-item--new" (click)="openLightbox(facade.existingImages().length + i)">
              <img [src]="url" alt="Új kép"  loading="lazy" />
              <span class="thumb-new-badge">Új</span>
              <button class="thumb-remove" (click)="$event.stopPropagation(); facade.removeNewFile(i)">
                <lucide-icon [name]="ICONS.X" [size]="12" />
              </button>
            </div>
          }
        </div>
      }

      <!-- Leírás -->
      <div>
        <ps-textarea
          label="Leírás"
          [rows]="3"
          [(ngModel)]="facade.description"
          placeholder="Verzió leírása..."
          [maxLength]="2000"
        />
        <div class="textarea-footer">
          <button
            class="ai-btn"
            [disabled]="facade.generatingSummary() || !facade.description.trim()"
            (click)="facade.generateSummary(facade.description)"
          >
            <lucide-icon [name]="ICONS.SPARKLES" [size]="14" />
            {{ facade.generatingSummary() ? 'Generálás...' : 'Összefoglaló' }}
          </button>
        </div>
      </div>

      <!-- AI összefoglaló preview -->
      @if (facade.showSummary()) {
        <div class="summary-preview">
          <ps-textarea
            label="AI összefoglaló"
            [rows]="2"
            [(ngModel)]="facade.summaryText"
          />
          <div class="summary-actions" style="margin: -4px; margin-top: 8px;">
            <button
              class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg text-xs transition-colors"
              style="margin: 4px;"
              (click)="facade.dismissSummary()"
            >Elvetés</button>
            <button
              class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg text-xs transition-colors"
              style="margin: 4px;"
              (click)="facade.applySummary()"
            >Használat leírásként</button>
          </div>
        </div>
      }
    </div>

    <div class="flex justify-end mt-5" style="margin: -4px; margin-top: 20px;">
      <button
        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg text-sm transition-colors"
        style="margin: 4px;"
        (click)="close.emit()"
      >Mégse</button>
      <button
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-medium rounded-lg text-sm transition-colors"
        style="margin: 4px;"
        [disabled]="facade.saving() || !facade.isValid()"
        (click)="save()"
      >{{ facade.saving() ? 'Mentés...' : 'Mentés' }}</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
@if (lightboxOpen()) {
  <app-samples-lightbox
    [samples]="lightboxItems()"
    [currentIndex]="lightboxIndex()"
    (close)="lightboxOpen.set(false)"
    (navigate)="lightboxIndex.set($event)"
  />
}
