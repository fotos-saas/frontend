@if (loading()) {
  <div class="flex items-center justify-center py-12">
    <div class="w-8 h-8 border-3 border-gray-200 border-t-primary rounded-full animate-spin"></div>
  </div>
} @else {
  <div class="settings-section">
    <div class="section-header section-header--with-info">
      <lucide-icon [name]="ICONS.IMAGE" [size]="20" />
      <h3>Képválasztás beállítások</h3>
      <app-info-box storageKey="settings-tab" title="Beállítások">
        Itt szabhatod testre a projekt működését: retusálható képek száma, módosítási időablak és export beállítások.
        Ha nem adsz meg egyedi értéket, a globális beállítások érvényesülnek.
      </app-info-box>
    </div>

    <div class="setting-card">
      <div class="setting-row">
        <div class="setting-info">
          <span class="setting-label">Retusálható képek száma</span>
          <span class="setting-description">
            Hány képet választhat ki egy diák retusálásra ebben a projektben.
          </span>
        </div>
      </div>

      <ps-toggle
        label="Egyedi limit beállítása erre a projektre"
        [ngModel]="useCustomLimit()"
        (ngModelChange)="toggleCustomLimit()"
      />

      @if (useCustomLimit()) {
        <ps-input
          type="number"
          label="Maximum képek száma"
          min="1"
          max="20"
          [ngModel]="customLimit()"
          (ngModelChange)="customLimit.set($event)"
        />
      }

      <div class="info-row">
        <lucide-icon [name]="ICONS.INFO" [size]="14" class="info-icon" />
        <span>
          Globális alapérték: <strong>{{ globalDefault() }} kép</strong>
          @if (useCustomLimit()) {
            &middot; Érvényes érték: <strong>{{ customLimit() }} kép</strong>
          }
        </span>
      </div>

    </div>

    <!-- Free Edit Window Setting -->
    <div class="setting-card">
      <div class="setting-row">
        <div class="setting-info">
          <span class="setting-label">Ingyenes módosítási időablak</span>
          <span class="setting-description">
            Mennyi ideig módosíthatja a diák a véglegesített választását díjmentesen.
          </span>
        </div>
      </div>

      <ps-toggle
        label="Egyedi érték beállítása erre a projektre"
        [ngModel]="useCustomEditWindow()"
        (ngModelChange)="toggleCustomEditWindow()"
      />

      @if (useCustomEditWindow()) {
        <ps-input
          type="number"
          label="Időablak (óra)"
          min="1"
          max="168"
          [ngModel]="customEditWindowHours()"
          (ngModelChange)="customEditWindowHours.set($event)"
        />
      }

      <div class="info-row">
        <lucide-icon [name]="ICONS.INFO" [size]="14" class="info-icon" />
        <span>
          Globális alapérték: <strong>{{ globalDefaultEditWindow() }} óra</strong>
          @if (useCustomEditWindow()) {
            &middot; Érvényes érték: <strong>{{ customEditWindowHours() }} óra</strong>
          }
        </span>
      </div>
    </div>

    <!-- Export beállítások -->
    <div class="section-header section-header--mt">
      <lucide-icon [name]="ICONS.DOWNLOAD" [size]="20" />
      <h3>Export beállítások</h3>
    </div>

    <div class="setting-card">
      <div class="setting-row">
        <div class="setting-info">
          <span class="setting-label">Letöltési beállítások</span>
          <span class="setting-description">
            ZIP tartalom, fájlnév stratégia és párbeszédablak beállítások erre a projektre.
          </span>
        </div>
      </div>

      <ps-toggle
        label="Egyedi export beállítás erre a projektre"
        [ngModel]="useCustomExport()"
        (ngModelChange)="toggleCustomExport()"
      />

      @if (useCustomExport()) {
        <div class="sub-settings">
          <ps-select
            label="ZIP tartalom"
            [options]="zipContentOptions"
            [ngModel]="exportZipContent()"
            (ngModelChange)="exportZipContent.set($event)"
          />
          <ps-select
            label="Fájlnév stratégia"
            [options]="fileNamingOptions"
            [ngModel]="exportFileNaming()"
            (ngModelChange)="exportFileNaming.set($event)"
          />
          <ps-toggle
            label="Mindig kérdezzen rá letöltésnél"
            [ngModel]="exportAlwaysAsk()"
            (ngModelChange)="exportAlwaysAsk.set($event)"
          />
        </div>
      }

      <div class="info-row">
        <lucide-icon [name]="ICONS.INFO" [size]="14" class="info-icon" />
        <span>
          Globális: <strong>{{ globalDefaultZipContent() === 'all' ? 'Összes kép' : globalDefaultZipContent() === 'retouch_only' ? 'Csak retusált' : globalDefaultZipContent() === 'tablo_only' ? 'Csak tablókép' : 'Retusált + Tablókép' }}</strong>
        </span>
      </div>
    </div>

    <!-- Közös Mentés gomb -->
    <div class="action-row">
      <button
        class="save-btn"
        [disabled]="saving()"
        (click)="save()"
      >
        @if (saving()) {
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
        }
        Mentés
      </button>
    </div>

    <!-- Portré háttércsere beállítások (lazy loaded) -->
    @defer (on viewport) {
      <app-portrait-settings [projectId]="projectId()" />
    } @placeholder {
      <div class="py-8 text-center text-slate-400 text-sm">
        Görgess lejjebb a portré beállításokhoz...
      </div>
    }
  </div>
}
