<div class="marketplace-page page-card">
  <div class="page-header">
    <h1>Marketplace</h1>
    <p class="page-subtitle">Válaszd ki a számodra szükséges modulokat, vagy válassz egy kész csomagot.</p>
  </div>

  <!-- Összesítő -->
  <div class="summary-bar">
    <div class="summary-item">
      <span class="summary-label">Aktív modulok</span>
      <span class="summary-value">{{ activeModulesCount() }}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">Havi modul költség</span>
      <span class="summary-value">{{ formatPrice(monthlyModuleCost()) }}</span>
    </div>
    @if (activePackage(); as pkg) {
      <div class="summary-item">
        <span class="summary-label">Aktív csomag</span>
        <span class="summary-value summary-value--package">{{ pkg }}</span>
      </div>
    }
  </div>

  <!-- Csomagok -->
  @if (packages().length > 0) {
    <section class="packages-section">
      <h2>Kész csomagok</h2>
      <div class="packages-grid">
        @for (pkg of packages(); track pkg.key) {
          <div class="package-card" [class.package-card--active]="pkg.is_active" [class.package-card--popular]="pkg.popular">
            @if (pkg.popular) {
              <div class="popular-badge">Legnépszerűbb</div>
            }
            <h3>{{ pkg.name }}</h3>
            <div class="package-price">{{ pkg.monthly_price | number:'1.0-0':'hu' }} Ft<span>/hó</span></div>
            <div class="package-modules">{{ pkg.included_modules.length }} modul</div>
            @if (pkg.is_active) {
              <button class="btn btn--outline btn--danger" (click)="cancelPackage(pkg.key)">Lemondás</button>
            } @else {
              <button class="btn btn--primary" (click)="activatePackage(pkg.key)">{{ pkg.cta_button }}</button>
            }
          </div>
        }
      </div>
    </section>
  }

  <!-- Kategória szűrő -->
  <div class="category-filter">
    @for (cat of categories; track cat.key) {
      <button
        class="category-btn"
        [class.category-btn--active]="selectedCategory() === cat.key"
        (click)="selectCategory(cat.key)">
        {{ cat.label }}
      </button>
    }
  </div>

  <!-- Modulok grid -->
  @if (loading()) {
    <div class="loading-grid">
      @for (i of [1,2,3,4,5,6]; track i) {
        <div class="skeleton-card"></div>
      }
    </div>
  } @else {
    <div class="modules-grid">
      @for (module of filteredModules(); track module.key) {
        <div class="module-card" [class.module-card--active]="['active', 'package', 'trial', 'free'].includes(module.partner_status)">
          <div class="module-header">
            <lucide-icon [name]="module.icon" [size]="24" />
            <span class="module-status {{ getStatusClass(module.partner_status) }}">
              {{ getStatusLabel(module.partner_status) }}
            </span>
          </div>

          <h3 class="module-name">{{ module.name }}</h3>
          <p class="module-tagline">{{ module.tagline }}</p>

          <div class="module-price">
            @if (module.type === 'free') {
              <span class="price-free">Ingyenes</span>
            } @else if (module.type === 'per_use') {
              <span class="price-per-use">{{ module.per_use_price }} Ft/{{ module.per_use_unit }}</span>
            } @else {
              <span class="price-monthly">{{ formatPrice(module.monthly_price) }}</span>
            }
          </div>

          <div class="module-actions">
            @switch (module.partner_status) {
              @case ('inactive') {
                @if (module.type !== 'free') {
                  <button class="btn btn--primary btn--sm" (click)="activateModule(module.key)">Aktiválás</button>
                }
              }
              @case ('active') {
                <button class="btn btn--outline btn--sm" (click)="pauseModule(module.key)">Szünet</button>
                <button class="btn btn--outline btn--danger btn--sm" (click)="cancelModule(module.key)">Lemondás</button>
              }
              @case ('paused') {
                <button class="btn btn--primary btn--sm" (click)="resumeModule(module.key)">Folytatás</button>
                <button class="btn btn--outline btn--danger btn--sm" (click)="cancelModule(module.key)">Lemondás</button>
              }
              @case ('canceling') {
                <span class="canceling-text">Lejár: {{ module.cancels_at | date:'yyyy. MMM d.' }}</span>
              }
              @default {
                <!-- free, package, trial → nincs művelet -->
              }
            }
          </div>

          @if (module.popular) {
            <div class="popular-dot"></div>
          }
        </div>
      }
    </div>
  }
</div>
