@if (isOpen()) {
  <div class="chatbot-panel" role="complementary" aria-label="Tabi segito">
    <!-- Header -->
    <header class="chatbot-panel__header">
      <div class="header-left">
        <lucide-icon [name]="ICONS.MESSAGE_CIRCLE" [size]="20" />
        <h2>Tabi</h2>
      </div>
      <div class="header-actions">
        <button
          class="icon-btn"
          matTooltip="Uj beszelgetes"
          (click)="startNewConversation()"
        >
          <lucide-icon [name]="ICONS.PLUS" [size]="18" />
        </button>
        <button
          class="icon-btn"
          matTooltip="Bezaras"
          (click)="closePanel.emit()"
        >
          <lucide-icon [name]="ICONS.X" [size]="18" />
        </button>
      </div>
    </header>

    <!-- Contact bar -->
    <div class="contact-bar" (click)="toggleContactExpanded()">
      <div class="contact-bar__header">
        <lucide-icon [name]="ICONS.PHONE" [size]="16" />
        <span class="contact-bar__name">Kapcsolat</span>
        <lucide-icon
          [name]="contactExpanded() ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN"
          [size]="16"
          class="contact-bar__chevron"
        />
      </div>
      @if (contactExpanded()) {
        <div class="contact-bar__details">
          <!-- Fotos (partner) szekció -->
          @if (hasContactInfo()) {
            <div class="contact-section">
              <span class="contact-section__title">Fotos</span>
              <div class="contact-item">
                <lucide-icon [name]="ICONS.USER" [size]="14" />
                <span>{{ project()?.partnerName }}</span>
              </div>
              @if (project()?.partnerPhone) {
                <a [href]="'tel:' + project()?.partnerPhone" class="contact-link"
                   (click)="$event.stopPropagation()">
                  <lucide-icon [name]="ICONS.PHONE" [size]="14" />
                  <span>{{ project()?.partnerPhone }}</span>
                </a>
              }
              @if (project()?.partnerEmail) {
                <button class="contact-link"
                        (click)="copyEmail(project()!.partnerEmail!); $event.stopPropagation()">
                  <lucide-icon [name]="ICONS.MAIL" [size]="14" />
                  <span>{{ project()?.partnerEmail }}</span>
                  <lucide-icon [name]="ICONS.COPY" [size]="12" class="copy-hint" />
                </button>
              }
            </div>
          }

          <!-- Tablokeszito szekció -->
          <div class="contact-section">
            <span class="contact-section__title">Tablokeszito</span>
            <div class="contact-item">
              <lucide-icon [name]="ICONS.USER" [size]="14" />
              <span>Nove Ferenc</span>
            </div>
            <a href="tel:+36706328131" class="contact-link"
               (click)="$event.stopPropagation()">
              <lucide-icon [name]="ICONS.PHONE" [size]="14" />
              <span>06 70 632 8131</span>
            </a>
            <button class="contact-link"
                    (click)="copyEmail('info@tablostudio.hu'); $event.stopPropagation()">
              <lucide-icon [name]="ICONS.MAIL" [size]="14" />
              <span>info&#64;tablostudio.hu</span>
              <lucide-icon [name]="ICONS.COPY" [size]="12" class="copy-hint" />
            </button>
          </div>
        </div>
      }
    </div>

    <!-- Messages -->
    <div class="chatbot-panel__messages" #messagesContainer>
      @if (!hasMessages()) {
        <!-- Empty state -->
        <div class="empty-state">
          <div class="empty-state__icon">
            <lucide-icon [name]="ICONS.HELP_CIRCLE" [size]="48" />
          </div>
          <h3>Miben segithetek?</h3>
          <p>Kerdezz barmit a TablioStudio mukodeserol!</p>

          <div class="suggested-questions">
            @for (question of suggestedQuestions; track question) {
              <button
                class="suggested-btn"
                (click)="sendMessage(question)"
              >
                {{ question }}
              </button>
            }
          </div>
        </div>
      } @else {
        @for (msg of messages(); track $index) {
          <app-chatbot-message
            [role]="msg.role"
            [content]="msg.content"
            [timestamp]="msg.timestamp"
          />
        }
      }

      <!-- Loading indicator -->
      @if (isLoading()) {
        <div class="typing-indicator">
          <div class="typing-indicator__avatar">
            <span class="avatar avatar--tabi">&#10022;</span>
          </div>
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      }

      <!-- Error message -->
      @if (errorMessage()) {
        <div class="error-msg">
          <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="16" />
          <span>{{ errorMessage() }}</span>
        </div>
      }
    </div>

    <!-- Input -->
    <footer class="chatbot-panel__input">
      <textarea
        class="chat-input"
        [value]="inputText()"
        (input)="inputText.set($any($event.target).value)"
        (keydown)="onKeyDown($event)"
        placeholder="Irj egy uzenetet..."
        rows="1"
        [disabled]="isLoading()"
      ></textarea>
      <button
        class="send-btn"
        [disabled]="!inputText().trim() || isLoading()"
        (click)="sendMessage()"
        matTooltip="Kuldes"
      >
        <lucide-icon [name]="ICONS.SEND" [size]="18" />
      </button>
    </footer>
  </div>
}
