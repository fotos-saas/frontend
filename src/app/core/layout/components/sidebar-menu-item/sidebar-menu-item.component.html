@if (item().children && item().children!.length > 0) {
  <!-- Section with children -->
  <div class="mx-2 mb-1">
    <!-- Parent button -->
    <button
      class="menu-item flex items-center w-full px-3 py-2.5
             text-slate-300 hover:bg-slate-800/60 hover:text-slate-200
             rounded-lg transition-all duration-200 ease-out
             focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500
             focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
      [ngClass]="{
        'justify-center': collapsed(),
        'justify-between': !collapsed(),
        'bg-slate-800/40': flyoutOpen()
      }"
      (click)="toggleSection($event)"
      [attr.title]="collapsed() ? item().label : null"
      [attr.aria-expanded]="collapsed() ? flyoutOpen() : isExpanded()"
      [attr.aria-controls]="'section-' + item().id"
      type="button"
    >
      <div class="flex items-center gap-3">
        @if (item().icon) {
          <lucide-icon
            [name]="item().icon!"
            [size]="20"
            class="flex-shrink-0"
          ></lucide-icon>
        }
        @if (!collapsed()) {
          <span class="text-sm font-medium truncate">{{ item().label }}</span>
        }
      </div>
      @if (!collapsed()) {
        <svg
          class="w-4 h-4 text-slate-500 transition-transform duration-200"
          [ngClass]="{'rotate-180': isExpanded()}"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      }
    </button>

    <!-- Flyout panel (collapsed módban, fixed pozíció) -->
    @if (collapsed() && flyoutOpen()) {
      <div
        [id]="'section-' + item().id"
        class="flyout-panel"
        role="menu"
        [attr.aria-label]="item().label + ' almenü'"
        [style.top.px]="flyoutPosition().top"
        [style.left.px]="flyoutPosition().left"
      >
        <div class="flyout-header">{{ item().label }}</div>
        @for (child of item().children; track child.id; let i = $index) {
          <a
            [routerLink]="child.route"
            routerLinkActive="flyout-item--active"
            #rla="routerLinkActive"
            class="flyout-item"
            [ngClass]="{
              'opacity-50 pointer-events-none': child.disabled
            }"
            role="menuitem"
            (click)="onFlyoutNavigate()"
            [style.animation-delay]="(i * 0.03) + 's'"
          >
            {{ child.label }}
            @if (child.badge) {
              <span
                class="child-badge ml-2 w-5 h-5 text-xs font-bold
                       bg-amber-500 text-slate-900 rounded-full
                       inline-flex items-center justify-center"
              >
                {{ child.badge }}
              </span>
            }
          </a>
        }
      </div>
    }

    <!-- Children (expanded módban, nem collapsed) -->
    @if (!collapsed() && isExpanded()) {
      <div
        [id]="'section-' + item().id"
        class="ml-4 mt-1 space-y-0.5 border-l border-slate-700/50 pl-3"
      >
        @for (child of item().children; track child.id; let i = $index) {
          <a
            [routerLink]="child.route"
            routerLinkActive="child-active"
            #rla="routerLinkActive"
            class="child-item block px-3 py-2 text-sm rounded-lg
                   transition-all duration-200
                   focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500
                   focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
            [ngClass]="{
              'text-slate-300 hover:bg-slate-800/60 hover:text-slate-200': !rla.isActive,
              'bg-gradient-to-r from-purple-600/20 to-pink-500/20 text-white border-l-2 -ml-[2px] border-purple-500': rla.isActive,
              'opacity-50 pointer-events-none': child.disabled
            }"
            [style.animation-delay]="(i * 0.05) + 's'"
          >
            {{ child.label }}
            @if (child.badge) {
              <span
                class="child-badge ml-2 w-5 h-5 text-xs font-bold
                       bg-amber-500 text-slate-900 rounded-full
                       inline-flex items-center justify-center"
              >
                {{ child.badge }}
              </span>
            }
          </a>
        }
      </div>
    }
  </div>
} @else {
  <!-- Simple item (no children) -->
  <div class="mx-2 mb-1">
    <a
      [routerLink]="item().route"
      routerLinkActive="item-active"
      #rla="routerLinkActive"
      class="menu-item flex items-center gap-3 px-3 py-2.5
             rounded-lg transition-all duration-200 ease-out
             focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500
             focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900"
      [ngClass]="{
        'justify-center': collapsed(),
        'text-slate-300 hover:bg-slate-800/60 hover:text-slate-200': !rla.isActive && !isPending(),
        'bg-gradient-to-r from-purple-600/20 to-pink-500/20 text-white border-l-2 border-purple-500': rla.isActive && !isPending(),
        'opacity-50 pointer-events-none': item().disabled,
        'menu-item--pending': isPending()
      }"
      [attr.title]="collapsed() ? item().label : null"
      (click)="onMenuClick($event, rla.isActive)"
    >
      @if (item().icon) {
        <lucide-icon
          [name]="item().icon!"
          [size]="20"
          class="flex-shrink-0"
        ></lucide-icon>
      }
      @if (!collapsed()) {
        <span class="text-sm truncate">{{ item().label }}</span>
      }
      @if (item().badge && !collapsed()) {
        <span
          class="ml-auto px-2 py-0.5 text-xs font-medium
                 bg-red-500/20 text-red-400 rounded-full flex-shrink-0"
        >
          {{ item().badge }}
        </span>
      }
    </a>
  </div>
}
