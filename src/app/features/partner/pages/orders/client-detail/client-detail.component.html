<div class="partner-client-detail page-card">
  <!-- Loading -->
  @if (state.loading()) {
    <div class="animate-pulse">
      <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-4"></div>
      <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-8"></div>
      <div class="h-32 bg-gray-200 dark:bg-gray-700 rounded"></div>
    </div>
  }

  @if (!state.loading() && state.client()) {
    <!-- Header Component -->
    <app-client-header
      [client]="state.client()!"
      (edit)="onEdit()"
      (delete)="onDelete()"
      (disableCode)="onDisableCode()"
    />

    <!-- Access Code Component -->
    <app-client-access-code
      [client]="state.client()!"
      [extendingCode]="state.extendingCode()"
      [generatingCode]="state.generatingCode()"
      (copyCode)="onCopyCode()"
      (generateCode)="onGenerateCode()"
      (extendExpiry)="onExtendExpiry($event)"
      (expiryDateChange)="onExpiryDateChange($event)"
    />

    <!-- Album List Component -->
    <app-client-album-list
      [albums]="state.client()!.albums"
      [extendingAlbumId]="state.extendingAlbumId()"
      [togglingAlbumId]="state.togglingAlbumId()"
      [togglingDownloadId]="state.togglingDownloadId()"
      (createAlbum)="onCreateAlbum()"
      (activateAlbum)="onActivateAlbum($event)"
      (deactivateAlbum)="onDeactivateAlbum($event)"
      (reopenAlbum)="onReopenAlbum($event)"
      (toggleDownload)="onToggleDownload($event)"
      (extendAlbumExpiry)="onExtendAlbumExpiry($event)"
    />
  }
</div>

<!-- Edit Modal -->
@if (state.editDialog.isOpen()) {
  <app-dialog-wrapper
    variant="edit"
    headerStyle="flat"
    theme="blue"
    [icon]="ICONS.USER"
    title="Ügyfél szerkesztése"
    size="md"
    [closable]="true"
    [isSubmitting]="state.saving()"
    (closeEvent)="state.closeEditModal()"
    (submitEvent)="updateClient()"
  >
    <div dialogBody>
      <ps-input
        label="Név"
        [required]="true"
        [(ngModel)]="state.editForm.name"
        name="name"
      />

      <ps-input
        label="Email"
        type="email"
        [(ngModel)]="state.editForm.email"
        name="email"
      />

      <ps-input
        label="Telefonszám"
        type="tel"
        [(ngModel)]="state.editForm.phone"
        name="phone"
      />

      <ps-textarea
        label="Megjegyzés"
        [(ngModel)]="state.editForm.note"
        name="note"
        [rows]="3"
      />

      <!-- Regisztráció engedélyezése -->
      <div class="pt-4 mt-2 border-t border-gray-200 dark:border-gray-700">
        <ps-checkbox
          label="Regisztráció engedélyezése"
          hint="Az ügyfél email/jelszóval regisztrálhat. Ezután csak azzal léphet be, a kód inaktív lesz."
          [(ngModel)]="state.editForm.allowRegistration"
          name="allowRegistration"
        />
      </div>
    </div>

    <div dialogFooter>
      <button
        type="button"
        (click)="state.closeEditModal()"
        class="btn btn--outline"
      >
        Mégsem
      </button>
      <button
        type="submit"
        [disabled]="!state.editForm.name || state.saving()"
        class="btn btn--primary"
      >
        Mentés
      </button>
    </div>
  </app-dialog-wrapper>
}

<!-- Create Album Modal -->
@if (state.albumDialog.isOpen()) {
  <app-dialog-wrapper
    variant="create"
    headerStyle="flat"
    theme="blue"
    [icon]="ICONS.FOLDER_PLUS"
    title="Új album"
    size="md"
    [closable]="true"
    [isSubmitting]="state.saving()"
    (closeEvent)="state.closeAlbumModal()"
    (submitEvent)="createAlbum()"
  >
    <div dialogBody>
      <ps-input
        label="Album neve"
        [required]="true"
        [(ngModel)]="state.albumForm.name"
        name="name"
        placeholder="pl. Esküvői fotók"
      />

      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Album típusa <span class="text-red-500">*</span>
        </label>
        <div class="grid grid-cols-2 gap-3">
          <button
            type="button"
            (click)="state.albumForm.type = 'selection'"
            class="p-4 border-2 rounded-lg text-left transition-colors"
            [class]="state.albumForm.type === 'selection' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-600 hover:border-gray-300'"
          >
            <lucide-icon [name]="ICONS.GRID" [size]="24" class="text-primary-600 dark:text-primary-400 mb-2" />
            <h3 class="font-medium text-gray-900 dark:text-white">Képválasztás</h3>
            <p class="text-sm text-gray-500 mt-1">Egyszerű képválasztás</p>
          </button>
          <button
            type="button"
            (click)="state.albumForm.type = 'tablo'"
            class="p-4 border-2 rounded-lg text-left transition-colors"
            [class]="state.albumForm.type === 'tablo' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-200 dark:border-gray-600 hover:border-gray-300'"
          >
            <lucide-icon [name]="ICONS.FRAME" [size]="24" class="text-primary-600 dark:text-primary-400 mb-2" />
            <h3 class="font-medium text-gray-900 dark:text-white">Tablókép</h3>
            <p class="text-sm text-gray-500 mt-1">Teljes workflow</p>
          </button>
        </div>
      </div>

      @if (state.albumForm.type === 'selection') {
        <div class="grid grid-cols-2 gap-4">
          <ps-input
            label="Min. kiválasztás"
            type="number"
            [(ngModel)]="state.albumForm.min_selections"
            name="min_selections"
            min="1"
          />
          <ps-input
            label="Max. kiválasztás"
            type="number"
            [(ngModel)]="state.albumForm.max_selections"
            name="max_selections"
            min="1"
          />
        </div>
      }

      @if (state.albumForm.type === 'tablo') {
        <ps-input
          label="Max. retusálandó kép"
          type="number"
          [(ngModel)]="state.albumForm.max_retouch_photos"
          name="max_retouch_photos"
          min="1"
          max="20"
          placeholder="5"
        />
      }
    </div>

    <div dialogFooter>
      <button
        type="button"
        (click)="state.closeAlbumModal()"
        class="btn btn--outline"
      >
        Mégsem
      </button>
      <button
        type="submit"
        [disabled]="!state.albumForm.name || !state.albumForm.type || state.saving()"
        class="btn btn--primary"
      >
        Létrehozás
      </button>
    </div>
  </app-dialog-wrapper>
}

<!-- Disable Code Confirm Dialog -->
@if (state.disableCodeDialog.isOpen()) {
  <app-confirm-dialog
    title="Belépési kód inaktiválása"
    [message]="'Biztosan inaktiválni szeretnéd a belépési kódot? Az ügyfél nem fog tudni belépni ezzel a kóddal.'"
    confirmText="Inaktiválás"
    confirmType="warning"
    (resultEvent)="onDisableCodeResult($event)"
  />
}

<!-- Delete Confirm Dialog -->
@if (state.deleteDialog.isOpen()) {
  <app-confirm-dialog
    title="Ügyfél törlése"
    [message]="'Biztosan törölni szeretnéd a(z) ' + state.client()!.name + ' ügyfelet? Ez a művelet nem visszavonható.'"
    confirmText="Törlés"
    confirmType="danger"
    (resultEvent)="onDeleteResult($event)"
  />
}

<!-- Reopen Album Confirm Dialog -->
@if (state.reopenDialog.isOpen() && state.albumToReopen()) {
  <app-confirm-dialog
    title="Album újranyitása"
    [message]="'Biztosan újra szeretnéd nyitni a(z) ' + state.albumToReopen()!.name + ' albumot? Az ügyfél folytathatja a képválasztást.'"
    confirmText="Újranyitás"
    confirmType="primary"
    (resultEvent)="onReopenResult($event)"
  />
}
