<app-dialog-wrapper
  headerStyle="flat"
  theme="blue"
  [icon]="ICONS.LINK"
  [title]="'Tanár összekapcsolás'"
  [description]="'Válaszd ki mely tanárok ugyanazt a személyt jelölik. Az összekapcsolt tanárok megmaradnak, de a rendszer tudni fogja, hogy azonosak.'"
  size="lg"
  [isSubmitting]="isSubmitting()"
  [errorMessage]="errorMessage()"
  (closeEvent)="closeEvent.emit()"
  (submitEvent)="onSubmit()"
>
  <ng-container dialogBody>
    <!-- Kiindulási tanár -->
    <div class="source-teacher">
      <div class="source-teacher__avatar">
        @if (teacher().photoThumbUrl) {
          <img [src]="teacher().photoThumbUrl" [alt]="teacher().fullDisplayName"  loading="lazy" />
        } @else {
          <lucide-icon [name]="ICONS.GRADUATION_CAP" [size]="18" />
        }
      </div>
      <div class="source-teacher__info">
        <span class="source-teacher__name">{{ teacher().fullDisplayName }}</span>
        @if (teacher().schoolName) {
          <span class="source-teacher__school">{{ teacher().schoolName }}</span>
        }
      </div>
    </div>

    <!-- Kereső -->
    <ps-input
      placeholder="Tanár keresése név vagy iskola alapján..."
      [ngModel]="searchQuery()"
      (ngModelChange)="onSearchChange($event)"
    />

    <!-- Tanár lista -->
    <div class="teacher-list">
      <div class="teacher-list__header">
        <label class="teacher-list__label">
          Kapcsolandó tanárok:
          @if (selectedIds().size > 0) {
            <span class="teacher-list__count">({{ selectedIds().size }} kijelölve)</span>
          }
        </label>
        @if (filteredTeachers().length > 0) {
          <button type="button" class="select-all-btn" (click)="toggleAll()">
            {{ allSelected() ? 'Kijelölés törlése' : 'Mind kijelölése' }}
          </button>
        }
      </div>

      @if (searchLoading()) {
        <p class="teacher-list__empty">Keresés...</p>
      } @else if (filteredTeachers().length === 0) {
        <p class="teacher-list__empty">
          @if (searchQuery()) {
            Nincs találat a keresésre.
          } @else {
            Nincs más tanár a partnerhez rendelve.
          }
        </p>
      } @else {
        <div class="teacher-list__scroll">
          @for (t of filteredTeachers(); track t.id) {
            <label
              class="teacher-item"
              [class.teacher-item--selected]="isSelected(t.id)"
              [class.teacher-item--current]="isCurrent(t.id)"
            >
              <input
                type="checkbox"
                [checked]="isSelected(t.id)"
                [disabled]="isCurrent(t.id)"
                (change)="toggleTeacher(t.id)"
                class="teacher-item__checkbox"
              />
              <div class="teacher-item__avatar">
                @if (t.photoThumbUrl) {
                  <img [src]="t.photoThumbUrl" [alt]="t.fullDisplayName"  loading="lazy" />
                } @else {
                  <lucide-icon [name]="ICONS.GRADUATION_CAP" [size]="14" />
                }
              </div>
              <div class="teacher-item__info">
                <span class="teacher-item__name">{{ t.fullDisplayName }}</span>
                @if (t.schoolName) {
                  <span class="teacher-item__school">{{ t.schoolName }}</span>
                }
              </div>
              @if (isCurrent(t.id)) {
                <span class="teacher-item__current-badge">Aktuális</span>
              } @else if (t.linkedGroup && t.linkedGroup !== teacher().linkedGroup) {
                <lucide-icon
                  [name]="ICONS.LINK"
                  [size]="14"
                  class="teacher-item__linked-icon"
                />
              }
            </label>
          }
        </div>
      }
    </div>

  </ng-container>

  <ng-container dialogFooter>
    @if (hasLinkedGroup()) {
      <button
        type="button"
        class="btn-photo-chooser"
        (click)="onOpenPhotoChooser()"
      >
        <lucide-icon [name]="ICONS.IMAGE" [size]="16" />
        Fotó egységesítés
      </button>
    }
    <span class="footer-spacer"></span>
    <button
      type="button"
      class="btn-secondary"
      [disabled]="isSubmitting()"
      (click)="closeEvent.emit()"
    >
      Mégse
    </button>
    <button
      type="button"
      class="btn-primary"
      [disabled]="!canSubmit() || isSubmitting()"
      (click)="onSubmit()"
    >
      @if (isSubmitting()) {
        <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
      }
      Összekapcsolás
    </button>
  </ng-container>
</app-dialog-wrapper>
