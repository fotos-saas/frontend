<!-- Loading skeleton -->
@if (state.loading()) {
  <div class="loading-state">
    <div class="skeleton-bar skeleton-shimmer"></div>
    <div class="skeleton-toolbar skeleton-shimmer"></div>
    @for (_ of [1,2,3,4,5]; track _) {
      <div class="skeleton-row skeleton-shimmer"></div>
    }
  </div>
}

@if (!state.loading()) {
  <!-- Stat csík -->
  @if (state.summary(); as s) {
    <div class="stat-bar">
      <div class="stat-item">
        <span class="stat-item__value">{{ s.totalPersons }}</span>
        <span class="stat-item__label">Összesen</span>
      </div>
      <span class="stat-divider"></span>
      <div class="stat-item stat-item--success">
        <span class="stat-item__value">{{ s.finalized }}</span>
        <span class="stat-item__label">Véglegesített</span>
      </div>
      <span class="stat-divider"></span>
      <div class="stat-item stat-item--info">
        <span class="stat-item__value">{{ s.inProgress }}</span>
        <span class="stat-item__label">Folyamatban</span>
      </div>
      <span class="stat-divider"></span>
      <div class="stat-item stat-item--muted">
        <span class="stat-item__value">{{ s.notOpened }}</span>
        <span class="stat-item__label">Nem kezdte el</span>
      </div>
      @if (s.staleCount > 0) {
        <span class="stat-divider"></span>
        <div class="stat-item stat-item--warning">
          <span class="stat-item__value">{{ s.staleCount }}</span>
          <span class="stat-item__label">Figyelmeztetés</span>
        </div>
      }
    </div>
  }

  <!-- Toolbar: szűrők + export -->
  <div class="toolbar">
    <div class="search-box">
      <lucide-icon class="search-icon" [name]="ICONS.SEARCH" [size]="14" />
      <input
        class="search-input"
        type="text"
        placeholder="Keresés..."
        [value]="state.searchQuery()"
        (input)="state.setSearchQuery(searchInput.value)"
        #searchInput
      />
      @if (state.searchQuery()) {
        <button class="clear-btn" (click)="state.setSearchQuery(''); searchInput.value = ''">
          <lucide-icon [name]="ICONS.X" [size]="12" />
        </button>
      }
    </div>

    <select
      class="filter-select"
      [value]="state.filterStatus()"
      (change)="onFilterChange($event)"
    >
      <option value="all">Mindenki</option>
      <option value="finalized">Véglegesített</option>
      <option value="in_progress">Folyamatban</option>
      <option value="not_started">Nem kezdte el</option>
      <option value="stale">Figyelmeztetés</option>
    </select>

    <div class="toolbar__spacer"></div>

    <div class="toolbar__actions">
      <button
        class="icon-btn"
        matTooltip="Excel export"
        [disabled]="state.exportingExcel() || state.persons().length === 0"
        (click)="onExportExcel()"
      >
        @if (state.exportingExcel()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="15" class="spin" />
        } @else {
          <lucide-icon [name]="ICONS.FILE_SPREADSHEET" [size]="15" />
        }
        <span class="icon-btn__label">Excel</span>
      </button>
      <button
        class="icon-btn"
        matTooltip="ZIP letöltés"
        [disabled]="state.exportingZip() || state.persons().length === 0"
        (click)="onOpenDownloadDialog()"
      >
        @if (state.exportingZip()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="15" class="spin" />
        } @else {
          <lucide-icon [name]="ICONS.ARCHIVE" [size]="15" />
        }
        <span class="icon-btn__label">ZIP</span>
      </button>
    </div>
  </div>

  <!-- Táblázat fejléc -->
  <div class="table-header">
    <span class="th th-name">Név</span>
    <span class="th th-type">Típus</span>
    <span class="th th-status">Státusz</span>
    <span class="th th-step">Lépés</span>
    <span class="th th-retouch">Retusálás</span>
    <span class="th th-activity">Utolsó aktivitás</span>
  </div>

  <!-- Sorok -->
  @if (state.filteredPersons().length > 0) {
    <div class="row-grid">
      @for (person of state.filteredPersons(); track person.personId; let i = $index) {
        <div
          class="list-row"
          [class.list-row--stale]="person.staleWarning"
          [class.list-row--expanded]="state.expandedPersonId() === person.personId"
          [class.list-row--clickable]="person.hasOpened"
          [style.animation-delay]="i * 0.03 + 's'"
          (click)="onToggleExpand(person)"
        >
          <span class="cell cell-name">
            @if (person.hasOpened) {
              <lucide-icon
                class="expand-icon"
                [class.expand-icon--open]="state.expandedPersonId() === person.personId"
                [name]="ICONS.CHEVRON_RIGHT"
                [size]="14"
              />
            }
            <span class="person-name">{{ person.name }}</span>
          </span>
          <span class="cell cell-type">
            <span class="type-badge" [class.type-badge--teacher]="person.type === 'teacher'">
              {{ person.type === 'student' ? 'Diák' : 'Tanár' }}
            </span>
          </span>
          <span class="cell cell-status">
            @if (person.workflowStatus === 'finalized') {
              <span class="status-badge status-badge--finalized">
                <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="13" />
                Véglegesített
              </span>
            } @else if (person.workflowStatus === 'in_progress') {
              <span class="status-badge status-badge--progress">
                <lucide-icon [name]="ICONS.LOADER" [size]="13" />
                Folyamatban
              </span>
            } @else {
              <span class="status-badge status-badge--not-started">
                <lucide-icon [name]="ICONS.CIRCLE" [size]="13" />
                Nem kezdte el
              </span>
            }
          </span>
          <span class="cell cell-step">
            {{ getStepLabel(person.currentStep) }}
          </span>
          <span class="cell cell-retouch">
            @if (person.retouchCount > 0) {
              {{ person.retouchCount }} kép
            } @else {
              -
            }
          </span>
          <span class="cell cell-activity">
            @if (person.staleWarning) {
              <span class="stale-warning" matTooltip="Több mint 5 napja inaktív">
                <lucide-icon [name]="ICONS.ALERT_TRIANGLE" [size]="13" />
                {{ person.daysSinceLastActivity }} napja
              </span>
            } @else if (person.lastActivityAt) {
              {{ formatDate(person.lastActivityAt) }}
            } @else {
              -
            }
          </span>
        </div>

        <!-- Kibontott részletező panel -->
        @if (state.expandedPersonId() === person.personId) {
          <div class="detail-panel">
            @if (state.loadingSelections()) {
              <div class="detail-loading">
                <div class="skeleton-detail skeleton-shimmer"></div>
                <div class="skeleton-detail skeleton-shimmer"></div>
              </div>
            } @else if (state.expandedSelections(); as sel) {
              @if (sel.claimed.length === 0 && sel.retouch.length === 0 && !sel.tablo) {
                <div class="detail-empty">
                  <lucide-icon [name]="ICONS.IMAGE" [size]="20" />
                  <span>Még nincs kiválasztott kép</span>
                </div>
              } @else {
                <!-- Saját képek -->
                @if (sel.claimed.length > 0) {
                  <div class="detail-group">
                    <div class="detail-group__header">
                      <lucide-icon [name]="ICONS.IMAGE" [size]="14" />
                      <span>Saját képek</span>
                      <span class="detail-group__count">{{ sel.claimed.length }} kép</span>
                    </div>
                    <app-photo-thumb-list
                      [photos]="sel.claimed"
                      size="sm"
                      (photoClick)="onThumbClick(sel.claimed, $event)"
                    />
                  </div>
                }

                <!-- Retusált képek -->
                @if (sel.retouch.length > 0) {
                  <div class="detail-group">
                    <div class="detail-group__header">
                      <lucide-icon [name]="ICONS.SPARKLES" [size]="14" />
                      <span>Retusálásra kiválasztott</span>
                      <span class="detail-group__count">{{ sel.retouch.length }} kép</span>
                    </div>
                    <app-photo-thumb-list
                      [photos]="sel.retouch"
                      size="sm"
                      (photoClick)="onThumbClick(sel.retouch, $event)"
                    />
                  </div>
                }

                <!-- Tablókép -->
                @if (sel.tablo) {
                  <div class="detail-group">
                    <div class="detail-group__header">
                      <lucide-icon [name]="ICONS.FRAME" [size]="14" />
                      <span>Tablókép</span>
                    </div>
                    <app-photo-thumb-list
                      [photos]="[sel.tablo]"
                      size="sm"
                      [highlight]="true"
                      (photoClick)="onThumbClick([sel.tablo], $event)"
                    />
                  </div>
                }
              }
            }
          </div>
        }
      }
    </div>
  } @else {
    <!-- Üres állapot -->
    <div class="empty-state">
      <lucide-icon class="empty-icon" [name]="ICONS.USERS" [size]="40" />
      <h3>Nincs találat</h3>
      <p>A keresési feltételeknek egyetlen személy sem felel meg.</p>
    </div>
  }
}

<!-- Lightbox (page-card-on kívül, backdrop-filter stacking context miatt) -->
@if (state.lightboxOpen()) {
  <app-media-lightbox
    [media]="state.lightboxMedia()"
    [currentIndex]="state.lightboxIndex()"
    (close)="onLightboxClose()"
    (navigate)="onLightboxNavigate($event)"
  />
}
