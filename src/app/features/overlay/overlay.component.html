<!-- Toolbar Wrap — fix pozíció -->
<div class="toolbar-wrap">

<!-- Toolbar -->
<div
  class="toolbar"
  [class.toolbar--has-collapse]="openSubmenu()"
  [class.toolbar--panel-open]="uploadPanelOpen()"
  (mouseenter)="onCollapseEnter()"
  (mouseleave)="onCollapseLeave()"
>
  <!-- Drag handle -->
  <div class="toolbar__drag">
    <lucide-icon [name]="ICONS.GRIP" [size]="14" />
  </div>

  <!-- Separator after drag -->
  <div class="toolbar__sep"></div>

  @if (isLoggedOut()) {
    <!-- Logged out: login gomb -->
    <button class="toolbar__btn toolbar__btn--login" (click)="showLogin()" data-tip="Bejelentkezés szükséges">
      <lucide-icon [name]="ICONS.LOG_IN" [size]="16" />
    </button>
    <span class="toolbar__login-label" (click)="showLogin()">Bejelentkezés</span>
    <div class="toolbar__spacer"></div>
  } @else {
    <!-- Toolbar groups -->
    @for (group of groups(); track group.id; let last = $last) {
      @for (item of group.items; track item.id) {
        <div class="toolbar__btn-wrap">
          <button
            class="toolbar__btn"
            [class.toolbar__btn--green]="item.accent === 'green'"
            [class.toolbar__btn--purple]="item.accent === 'purple'"
            [class.toolbar__btn--amber]="item.accent === 'amber'"
            [class.toolbar__btn--red]="item.accent === 'red'"
            [class.toolbar__btn--blue]="item.accent === 'blue'"
            [class.toolbar__btn--busy]="busyCommand() === item.id || (item.id === 'generate-sample' && generating() === 'sample') || (item.id === 'generate-final' && generating() === 'final')"
            [class.toolbar__btn--active]="openSubmenu() === item.id || (item.id === 'upload-photo' && uploadPanelOpen())"
            [disabled]="busyCommand() === item.id || (item.id === 'generate-sample' && generating() === 'sample') || (item.id === 'generate-final' && generating() === 'final')"
            (click)="onCommand(item.id)"
            [attr.data-tip]="item.tooltip || item.label"
          >
            @if (busyCommand() === item.id || (item.id === 'generate-sample' && generating() === 'sample') || (item.id === 'generate-final' && generating() === 'final')) {
              <span class="toolbar__spinner"></span>
            } @else {
              <lucide-icon [name]="item.icon" [size]="18" />
            }
          </button>

          <!-- Inline collapse: sync-photos opciók -->
          @if (item.id === 'sync-photos') {
            <div
              class="toolbar__inline-collapse"
              [class.toolbar__inline-collapse--open]="openSubmenu() === 'sync-photos'"
            >
              <div class="toolbar__inline-collapse-inner">
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--green" (click)="syncPhotos('missing')" data-tip="Csak hiányzó">
                  <lucide-icon [name]="ICONS.USER_X" [size]="15" />
                </button>
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--green" (click)="syncPhotos('all')" data-tip="Mind">
                  <lucide-icon [name]="ICONS.IMAGES" [size]="15" />
                </button>
                <div class="toolbar__collapse-sep"></div>
                <button
                  class="toolbar__btn toolbar__btn--sm"
                  [class.toolbar__btn--toggle-on]="syncWithBorder()"
                  (click)="toggleSyncBorder()"
                  [attr.data-tip]="syncWithBorder() ? 'Keret: BE' : 'Keret: KI'"
                >
                  <lucide-icon [name]="ICONS.FRAME" [size]="15" />
                </button>
              </div>
            </div>
          }

          <!-- Inline collapse: arrange-names text align + sortörés + gap opciók -->
          @if (item.id === 'arrange-names') {
            <div
              class="toolbar__inline-collapse toolbar__inline-collapse--wide"
              [class.toolbar__inline-collapse--open]="openSubmenu() === 'arrange-names'"
            >
              <div class="toolbar__inline-collapse-inner">
                <button class="toolbar__btn toolbar__btn--sm" (click)="arrangeNames('left')" data-tip="Balra">
                  <lucide-icon [name]="ICONS.ALIGN_START_V" [size]="15" />
                </button>
                <button class="toolbar__btn toolbar__btn--sm" (click)="arrangeNames('center')" data-tip="Középre">
                  <lucide-icon [name]="ICONS.ALIGN_CENTER_V" [size]="15" />
                </button>
                <button class="toolbar__btn toolbar__btn--sm" (click)="arrangeNames('right')" data-tip="Jobbra">
                  <lucide-icon [name]="ICONS.ALIGN_END_V" [size]="15" />
                </button>
                <div class="toolbar__collapse-sep"></div>
                <!-- Sortörés ciklikus: 0/1/2 szó után -->
                <button
                  class="toolbar__btn toolbar__btn--sm toolbar__btn--badge"
                  [class.toolbar__btn--toggle-on]="nameBreakAfter() > 0"
                  (click)="cycleBreakAfter(); $event.stopPropagation()"
                  [attr.data-tip]="nameBreakAfter() === 0 ? 'Sortörés: nincs' : 'Sortörés: ' + nameBreakAfter() + '. szó után'"
                >
                  <lucide-icon [name]="ICONS.TYPE" [size]="13" />
                  <span class="toolbar__badge">{{ nameBreakAfter() }}</span>
                </button>
                <div class="toolbar__collapse-sep"></div>
                <!-- Gap: -/érték/+ -->
                <button
                  class="toolbar__btn toolbar__btn--sm"
                  (click)="adjustGap(-0.1); $event.stopPropagation()"
                  data-tip="Rés csökkentése"
                >
                  <lucide-icon [name]="ICONS.MINUS" [size]="13" />
                </button>
                <span class="toolbar__gap-value" [attr.data-tip]="'Rés: ' + nameGapCm() + ' cm'">{{ nameGapCm() }}</span>
                <button
                  class="toolbar__btn toolbar__btn--sm"
                  (click)="adjustGap(0.1); $event.stopPropagation()"
                  data-tip="Rés növelése"
                >
                  <lucide-icon [name]="ICONS.PLUS" [size]="13" />
                </button>
              </div>
            </div>
          }

          <!-- Inline collapse: generate-sample beállítások + megerősítés -->
          @if (item.id === 'generate-sample') {
            <div
              class="toolbar__inline-collapse toolbar__inline-collapse--wide"
              [class.toolbar__inline-collapse--open]="openSubmenu() === 'generate-sample'"
            >
              <div class="toolbar__inline-collapse-inner">
                <!-- SD/HD toggle -->
                <button
                  class="toolbar__btn toolbar__btn--sm toolbar__btn--label"
                  [class.toolbar__btn--toggle-on]="sampleUseLargeSize()"
                  (click)="toggleSampleSize(); $event.stopPropagation()"
                  [attr.data-tip]="sampleUseLargeSize() ? 'HD (4000px)' : 'SD (2000px)'"
                >
                  <span class="toolbar__label-text">{{ sampleUseLargeSize() ? 'HD' : 'SD' }}</span>
                </button>
                <!-- Vízjel szín -->
                <button
                  class="toolbar__btn toolbar__btn--sm"
                  (click)="toggleWatermarkColor(); $event.stopPropagation()"
                  [attr.data-tip]="'Vízjel: ' + (sampleWatermarkColor() === 'white' ? 'fehér' : 'fekete')"
                >
                  <lucide-icon [name]="sampleWatermarkColor() === 'white' ? ICONS.SUN : ICONS.MOON" [size]="13" />
                </button>
                <!-- Opacity -->
                <button
                  class="toolbar__btn toolbar__btn--sm toolbar__btn--label"
                  (click)="cycleOpacity(); $event.stopPropagation()"
                  [attr.data-tip]="'Átlátszóság: ' + (sampleWatermarkOpacity() * 100) + '%'"
                >
                  <span class="toolbar__label-text">{{ (sampleWatermarkOpacity() * 100).toFixed(0) }}%</span>
                </button>
                <div class="toolbar__collapse-sep"></div>
                <!-- Indítás -->
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--green" (click)="confirmGenerate('sample')" data-tip="Indítás">
                  <lucide-icon [name]="ICONS.CHECK" [size]="15" />
                </button>
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--red" (click)="cancelGenerate()" data-tip="Mégsem">
                  <lucide-icon [name]="ICONS.X" [size]="15" />
                </button>
              </div>
            </div>
          }

          <!-- Inline collapse: generate-final megerősítés -->
          @if (item.id === 'generate-final') {
            <div
              class="toolbar__inline-collapse"
              [class.toolbar__inline-collapse--open]="openSubmenu() === 'generate-final'"
            >
              <div class="toolbar__inline-collapse-inner">
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--green" (click)="confirmGenerate('final')" data-tip="Igen">
                  <lucide-icon [name]="ICONS.CHECK" [size]="15" />
                </button>
                <button class="toolbar__btn toolbar__btn--sm toolbar__btn--red" (click)="cancelGenerate()" data-tip="Mégsem">
                  <lucide-icon [name]="ICONS.X" [size]="15" />
                </button>
              </div>
            </div>
          }
        </div>
      }
      @if (!last) {
        <div class="toolbar__sep"></div>
      }
    }

    <!-- Spacer -->
    <div class="toolbar__spacer"></div>

    <!-- Active document + selected layers + turbo -->
    @if (activeDocLabel()) {
      <button
        class="toolbar__doc"
        (click)="openActiveDocDir()"
        [attr.data-tip]="activeDoc().name"
      >
        <lucide-icon [name]="ICONS.FILE_TEXT" [size]="13" />
        <span class="toolbar__doc-name">{{ activeDocLabel() }}</span>
      </button>
      <span class="toolbar__info">
        <lucide-icon [name]="ICONS.LAYERS" [size]="12" />
        {{ selectedLayers() }}
      </span>
      <div class="toolbar__sep"></div>
    }

    <!-- Turbo gomb -->
    <button
      class="toolbar__btn"
      [class.toolbar__btn--turbo-active]="isTurbo()"
      (click)="toggleTurbo()"
      [attr.data-tip]="isTurbo() ? 'Turbo kikapcsolás' : 'Turbo polling'"
    >
      <lucide-icon [name]="ICONS.ZAPS" [size]="16" />
    </button>
  }

  <!-- Hide button -->
  <button class="toolbar__btn toolbar__btn--close" (click)="hide()" data-tip="Elrejtés (Ctrl+K)">
    <lucide-icon [name]="ICONS.X" [size]="16" />
  </button>
</div>

<!-- Upload Panel (toolbar FELETT, a flex flow-ban előtte) -->
@if (uploadPanelOpen()) {
<div class="upload-panel" [style.height.px]="panelHeight()">
  <div class="upload-panel__resize" (mousedown)="onResizeStart($event)"></div>
  <div class="upload-panel__header">
    <lucide-icon [name]="ICONS.CAMERA" [size]="14" />
    <span>Fotó feltöltés</span>
    @if (hasPsLayers()) {
      <button class="upload-panel__refresh" (click)="resetUploadState($event)" type="button" data-tip="Reset">
        <lucide-icon [name]="ICONS.UNDO" [size]="13" />
      </button>
      <button class="upload-panel__refresh" (click)="refreshPsLayers()" type="button" data-tip="Frissítés">
        <lucide-icon [name]="ICONS.REFRESH" [size]="13" />
      </button>
    }
    <button class="upload-panel__close" (click)="closeUploadPanel()" type="button">
      <lucide-icon [name]="ICONS.X" [size]="14" />
    </button>
  </div>

  <div class="upload-panel__body">
      <!-- v2: PS Layer mód (ha vannak kijelölt layerek slug---id formatummal) -->
      @if (hasPsLayers()) {
        <!-- Tallózás gomb -->
        <label class="upload-panel__browse">
          <lucide-icon [name]="ICONS.UPLOAD" [size]="14" />
          <span>Képek kiválasztása</span>
          <input type="file" accept="image/*" multiple (change)="onBatchFileSelect($event)" hidden />
        </label>

        <!-- Layer lista -->
        <div class="upload-panel__layer-list">
          @for (layer of psLayers(); track layer.personId; let i = $index) {
            <div
              class="upload-panel__layer-row"
              [class.upload-panel__layer-row--done]="layer.uploadStatus === 'done'"
              [class.upload-panel__layer-row--error]="layer.uploadStatus === 'error'"
              [class.upload-panel__layer-row--uploading]="layer.uploadStatus === 'uploading'"
              [class.upload-panel__layer-row--assignable]="selectedUnmatchedFile() && !layer.file && layer.uploadStatus !== 'done'"
              (click)="onLayerRowClick(i)"
            >
              <div class="upload-panel__layer-thumb">
                @if (layer.photoThumbUrl) {
                  <img [src]="layer.photoThumbUrl" [alt]="layer.personName || layer.slug" />
                } @else if (layer.file) {
                  <img [src]="getFilePreview(layer.file)" [alt]="layer.file.name" />
                } @else {
                  <lucide-icon [name]="ICONS.USER" [size]="12" />
                }
              </div>
              <span class="upload-panel__layer-name">{{ layer.personName || layer.slug }}</span>
              <span class="upload-panel__layer-file">
                @if (layer.file) {
                  {{ layer.file.name }}
                  @if (layer.uploadStatus === 'pending') {
                    <button class="upload-panel__layer-remove" (click)="removeFileFromLayer(i)" type="button">
                      <lucide-icon [name]="ICONS.X" [size]="10" />
                    </button>
                  }
                } @else {
                  <span class="upload-panel__layer-no-file">—</span>
                }
              </span>
              @if (layer.matchType === 'ambiguous') {
                <span class="upload-panel__layer-ambiguous" data-tip="Bizonytalan párosítás — ellenőrizd!">
                  <lucide-icon [name]="ICONS.ALERT_TRIANGLE" [size]="12" />
                </span>
              }
              <span class="upload-panel__layer-status">
                @if (layer.uploadStatus === 'done') {
                  <lucide-icon [name]="ICONS.CHECK" [size]="13" class="upload-panel__status--done" />
                } @else if (layer.uploadStatus === 'error') {
                  <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="13" class="upload-panel__status--error" />
                } @else if (layer.uploadStatus === 'uploading') {
                  <span class="upload-panel__spinner"></span>
                } @else {
                  <span class="upload-panel__status--pending">–</span>
                }
              </span>
            </div>
          }
        </div>

        <!-- Nem párosított fájlok -->
        @if (unmatchedFiles().length > 0) {
          <div class="upload-panel__unmatched">
            <span class="upload-panel__unmatched-label">Nem párosított ({{ unmatchedFiles().length }}):</span>
            <button class="upload-panel__unmatched-match" [disabled]="matching()" (click)="retrySmartMatch()" type="button" data-tip="Intelligens párosítás">
              @if (matching()) {
                <span class="upload-panel__spinner"></span>
              } @else {
                <lucide-icon [name]="ICONS.SPARKLES" [size]="11" />
              }
              Párosítás
            </button>
            <button class="upload-panel__unmatched-clear" (click)="clearUnmatchedFiles()" type="button" data-tip="Lista törlése">
              <lucide-icon [name]="ICONS.X" [size]="11" />
            </button>
            @for (file of unmatchedFiles(); track file.name; let fi = $index) {
              <button
                class="upload-panel__unmatched-file"
                [class.upload-panel__unmatched-file--selected]="selectedUnmatchedFile() === file"
                (click)="selectUnmatchedFile(file)"
                type="button"
              >
                <img class="upload-panel__unmatched-thumb" [src]="getFilePreview(file)" [alt]="file.name" />
                {{ file.name }}
              </button>
            }
            @if (selectedUnmatchedFile()) {
              <span class="upload-panel__unmatched-hint">Kattints egy layer sorra a hozzárendeléshez</span>
            }
          </div>
        }

        <!-- Akció gomb -->
        <div class="upload-panel__batch-actions">
          <button
            class="upload-panel__btn upload-panel__btn--green"
            [disabled]="batchUploading() || placing() || uploadableLayers().length === 0"
            (click)="uploadAndPlace()"
            type="button"
          >
            @if (batchUploading()) {
              <span class="upload-panel__spinner"></span>
              Feltöltés ({{ batchProgress().done }}/{{ batchProgress().total }})
            } @else if (placing()) {
              <span class="upload-panel__spinner"></span>
              Behelyezés PS-be...
            } @else {
              <lucide-icon [name]="ICONS.UPLOAD" [size]="14" />
              Feltöltés + Behelyezés ({{ uploadableLayers().length }})
            }
          </button>
        </div>

        @if (batchResult()) {
          <div class="upload-panel__result" [class.upload-panel__result--success]="batchResult()!.success" [class.upload-panel__result--error]="!batchResult()!.success">
            @if (batchResult()!.success) {
              <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="14" />
            } @else {
              <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="14" />
            }
            <span>{{ batchResult()!.message }}</span>
          </div>
        }

      } @else {
        <!-- v1 fallback: egyedi feltöltés (nincs PS layer) -->
        <div class="upload-panel__search">
          <lucide-icon [name]="ICONS.SEARCH" [size]="14" class="upload-panel__search-icon" />
          <input
            type="text"
            placeholder="Személy keresése..."
            [value]="searchQuery()"
            (input)="onSearchInput($event)"
            class="upload-panel__search-input"
          />
        </div>

        <div class="upload-panel__content">
          <div class="upload-panel__persons">
            @if (loadingPersons()) {
              <div class="upload-panel__loading">Betöltés...</div>
            } @else if (filteredPersons().length === 0) {
              <div class="upload-panel__loading">
                @if (searchQuery()) {
                  Nincs találat
                } @else {
                  Üres lista
                }
              </div>
            } @else {
              @for (person of filteredPersons(); track person.id) {
                <button
                  class="upload-panel__person"
                  [class.upload-panel__person--selected]="selectedPerson()?.id === person.id"
                  [class.upload-panel__person--has-photo]="person.hasPhoto"
                  (click)="selectPerson(person)"
                  type="button"
                >
                  <div class="upload-panel__avatar">
                    @if (person.photoThumbUrl) {
                      <img [src]="person.photoThumbUrl" [alt]="person.name" />
                    } @else {
                      <lucide-icon [name]="ICONS.USER" [size]="14" />
                    }
                  </div>
                  <span class="upload-panel__name">{{ person.name }}</span>
                  <span class="upload-panel__type">{{ person.type === 'teacher' ? 'T' : 'D' }}</span>
                  @if (person.hasPhoto) {
                    <lucide-icon [name]="ICONS.CHECK" [size]="12" class="upload-panel__check" />
                  }
                </button>
              }
            }
          </div>

          <div class="upload-panel__upload">
            @if (selectedPerson()) {
              <div class="upload-panel__selected">
                <lucide-icon [name]="ICONS.USER" [size]="12" />
                <span>{{ selectedPerson()!.name }}</span>
              </div>

              <div
                class="upload-panel__drop"
                [class.upload-panel__drop--drag-over]="dragOver()"
                [class.upload-panel__drop--has-file]="!!selectedFile()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)"
              >
                @if (selectedFile()) {
                  <lucide-icon [name]="ICONS.IMAGE" [size]="20" class="upload-panel__file-icon" />
                  <span class="upload-panel__file-name">{{ selectedFile()!.name }}</span>
                } @else {
                  <lucide-icon [name]="ICONS.UPLOAD" [size]="20" />
                  <span>Húzd ide</span>
                  <label class="upload-panel__file-label">
                    vagy válassz
                    <input type="file" accept="image/*" (change)="onFileSelect($event)" hidden />
                  </label>
                }
              </div>

              <button
                class="upload-panel__btn"
                [disabled]="!canUpload()"
                (click)="upload()"
                type="button"
              >
                @if (uploading()) {
                  <span class="upload-panel__spinner"></span>
                  Feltöltés...
                } @else {
                  <lucide-icon [name]="ICONS.UPLOAD" [size]="14" />
                  Feltöltés
                }
              </button>

              @if (uploadResult()) {
                <div class="upload-panel__result" [class.upload-panel__result--success]="uploadResult()!.success" [class.upload-panel__result--error]="!uploadResult()!.success">
                  @if (uploadResult()!.success) {
                    <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="14" />
                    <span>Sikeres!</span>
                  } @else {
                    <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="14" />
                    <span>{{ uploadResult()!.message }}</span>
                  }
                </div>
              }
            } @else {
              <div class="upload-panel__placeholder">
                <lucide-icon [name]="ICONS.USER" [size]="24" />
                <span>Válassz személyt a listából</span>
              </div>
            }
          </div>
        </div>
      }
  </div>
</div>
}

</div><!-- /toolbar-wrap -->
