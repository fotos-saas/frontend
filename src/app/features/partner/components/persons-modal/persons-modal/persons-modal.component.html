<app-dialog-wrapper
  variant="info"
  headerStyle="flat"
  theme="blue"
  [icon]="ICONS.USERS"
  [title]="'Személyek'"
  [description]="projectName()"
  size="lg"
  [closable]="true"
  (closeEvent)="close.emit()"
>
  <div dialogBody>
    <!-- Rövid projektnév (csak mobilon) -->
    <p class="mobile-desc">{{ shortProjectName() }}</p>

    <!-- Filter toggle gomb (csak mobilon látszik) -->
    <button type="button" class="filter-toggle" (click)="filtersOpen.set(!filtersOpen())">
      <lucide-icon [name]="ICONS.FILTER" [size]="14" />
      Szűrők
      @if (hasActiveFilter()) {
        <span class="filter-badge"></span>
      }
      <lucide-icon [name]="filtersOpen() ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN" [size]="14" class="filter-chevron" />
    </button>

    <!-- Szűrők (mobilon összecsukható) -->
    <div class="filters-collapsible" [class.filters-collapsible--open]="filtersOpen()">
      <!-- Search + Photo Filter -->
      <div class="search-section">
        <div class="search-row">
          <div class="search-box">
            <lucide-icon [name]="ICONS.SEARCH" class="search-icon" [size]="16" />
            <input
              type="text"
              placeholder="Keresés név alapján..."
              [ngModel]="searchQuery()"
              (ngModelChange)="searchQuery.set($event)"
              class="search-input"
            />
            @if (searchQuery()) {
              <button class="clear-btn" (click)="searchQuery.set('')">
                <lucide-icon [name]="ICONS.X" [size]="14" />
              </button>
            }
          </div>
          <ps-toggle
            [label]="'Kép nélkül' + (!loading() ? ' (' + withoutPhotoCount() + ')' : '')"
            labelPosition="after"
            [ngModel]="showOnlyWithoutPhoto()"
            (ngModelChange)="showOnlyWithoutPhoto.set($event)"
          />
        </div>
      </div>

      <!-- Type Filter Tabs -->
      <div class="filter-tabs" [class.filter-tabs--hidden]="!!searchQuery()">
        <button type="button" class="tab" [class.tab--active]="typeFilter() === 'student'" (click)="typeFilter.set('student')">
          Diákok
          @if (!loading()) {
            <span class="tab-count">({{ studentCount() }})</span>
          }
        </button>
        <button type="button" class="tab" [class.tab--active]="typeFilter() === 'teacher'" (click)="typeFilter.set('teacher')">
          Tanárok
          @if (!loading()) {
            <span class="tab-count">({{ teacherCount() }})</span>
          }
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="modal-content-wrap" [class.modal-content-wrap--scrolled]="isScrolledToBottom()">
    <div class="modal-content" (scroll)="onContentScroll($event)">
      @if (loading()) {
        <div class="skeleton-grid">
          @for (i of [1, 2, 3, 4, 5, 6]; track i) {
            <div class="skeleton-card skeleton-shimmer"></div>
          }
        </div>
      } @else if (filteredPersons().length === 0) {
        <div class="empty-state">
          <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="48" class="empty-icon" />
          <h3>{{ emptyStateTitle() }}</h3>
          <p>{{ emptyStateText() }}</p>
        </div>
      } @else {
        <div class="persons-grid">
          @for (person of filteredPersons(); track person.id; let i = $index) {
            <app-modal-person-card
              [person]="person"
              [animationDelay]="i * 0.05 + 's'"
              (cardClick)="openLightbox($event)"
              (resetOverride)="resetOverride($event)"
            />
          }
        </div>
      }
    </div>
    </div>

    <!-- Footer Stats -->
    @if (!loading() && allCount() > 0) {
      <div class="modal-footer">
        <div class="stats-row">
          <span class="stat"><strong>{{ filteredPersons().length }}</strong> találat</span>
          <span class="stat-separator">·</span>
          <span class="stat"><strong>{{ studentCount() }}</strong> diák</span>
          <span class="stat-separator">·</span>
          <span class="stat"><strong>{{ teacherCount() }}</strong> tanár</span>
          <span class="stat-separator">·</span>
          <span class="stat" [class.stat--danger]="withoutPhotoCount() > 0">
            <strong>{{ withoutPhotoCount() }}</strong> kép nélkül
          </span>
        </div>
        @if (withoutPhotoCount() > 0) {
          <button type="button" class="upload-btn" (click)="openUploadWizard.emit()">
            <lucide-icon [name]="ICONS.UPLOAD" [size]="18" />
            Tovább a fényképek feltöltéséhez
          </button>
        }
      </div>
    }
  </div>
</app-dialog-wrapper>

<!-- Lightbox -->
<app-photo-lightbox
  [person]="lightboxPerson()"
  [personsWithPhotos]="personsWithPhotos()"
  (close)="closeLightbox()"
  (navigate)="lightboxPerson.set($event)"
/>
