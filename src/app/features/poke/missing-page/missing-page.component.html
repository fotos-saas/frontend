<div class="poke-page page-card">
  <!-- Header -->
  <header class="poke-header">
    <div class="poke-header__content">
      <div class="poke-header__icon">
        <span class="emoji">ğŸ‘€</span>
      </div>
      <div>
        <h1 class="poke-header__title">hiÃ¡nyzÃ³k</h1>
        <p class="poke-header__subtitle">bÃ¶kj rÃ¡juk, hogy ne felejtsÃ©k el</p>
      </div>
    </div>

    <div class="poke-header__actions">
      <!-- Kapott bÃ¶kÃ©sek -->
      @if (unreadCount() > 0) {
        <button
          class="received-btn has-unread"
          (click)="openReceivedDialog()"
          [attr.data-count]="unreadCount()">
          <span class="emoji">ğŸ“¬</span>
          <span class="label">kapott</span>
          <span class="badge">{{ unreadCount() }}</span>
        </button>
      } @else {
        <button
          class="received-btn"
          (click)="openReceivedDialog()">
          <span class="emoji">ğŸ“­</span>
          <span class="label">kapott</span>
        </button>
      }

      <!-- Napi limit -->
      <app-daily-limit-badge [limit]="dailyLimit()" />
    </div>
  </header>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="skeleton-search"></div>
      <div class="skeleton-filters"></div>
      <div class="skeleton-tabs"></div>
      <div class="skeleton-cards">
        @for (i of [1,2,3,4,5]; track i) {
          <div class="skeleton-card"></div>
        }
      </div>
    </div>
  }

  <!-- Error -->
  @if (errorMessage()) {
    <div class="error-state">
      <span class="emoji">ğŸ˜µ</span>
      <p>{{ errorMessage() }}</p>
      <button class="retry-btn" (click)="refresh()">
        Ãºjra prÃ³bÃ¡lom
      </button>
    </div>
  }

  <!-- Content -->
  @if (!isLoading() && !errorMessage()) {
    <!-- No missing users -->
    @if (noMissing()) {
      <div class="empty-state">
        <span class="emoji float-animation">ğŸ‰</span>
        <h2>mindenki kÃ©sz!</h2>
        <p>senki sem hiÃ¡nyzik, mindenki megtette a dolgÃ¡t</p>
      </div>
    } @else {
      <!-- Search -->
      <div class="search-section">
        <ps-input
          placeholder="keresÃ©s nÃ©v szerint..."
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
        />
      </div>

      <!-- Category tabs -->
      <div class="category-tabs">
        <button
          class="category-tab"
          [class.active]="activeCategory() === 'photoshoot'"
          [class.disabled]="!hasPhotoshootMissing()"
          (click)="setCategory('photoshoot')"
          [disabled]="!hasPhotoshootMissing()">
          <span class="tab-emoji">ğŸ“¸</span>
          <span class="tab-label">fotÃ³zÃ¡s</span>
          <span class="tab-count">{{ photoshootCount() }}</span>
        </button>
        <button
          class="category-tab"
          [class.active]="activeCategory() === 'voting'"
          [class.disabled]="!hasVotingMissing()"
          (click)="setCategory('voting')"
          [disabled]="!hasVotingMissing()">
          <span class="tab-emoji">ğŸ—³ï¸</span>
          <span class="tab-label">szavazÃ¡s</span>
          <span class="tab-count">{{ votingCount() }}</span>
        </button>
        <button
          class="category-tab"
          [class.active]="activeCategory() === 'image_selection'"
          [class.disabled]="!hasImageSelectionMissing()"
          (click)="setCategory('image_selection')"
          [disabled]="!hasImageSelectionMissing()">
          <span class="tab-emoji">ğŸ–¼ï¸</span>
          <span class="tab-label">kÃ©pvÃ¡lasztÃ¡s</span>
          <span class="tab-count">{{ imageSelectionCount() }}</span>
        </button>
        <div class="tab-indicator"></div>
      </div>

      <!-- Person tabs (csak fotÃ³zÃ¡snÃ¡l) -->
      @if (showPersonTabs()) {
        <div class="person-tabs">
          <button
            class="person-tab"
            [class.active]="personTab() === 'student'"
            (click)="setPersonTab('student')">
            <span class="person-tab__emoji">ğŸ“</span>
            <span class="person-tab__label">diÃ¡kok</span>
            <span class="person-tab__count">{{ studentCount() }}</span>
          </button>
          <button
            class="person-tab person-tab--secondary"
            [class.active]="personTab() === 'teacher'"
            (click)="setPersonTab('teacher')">
            <span class="person-tab__emoji">ğŸ‘¨â€ğŸ«</span>
            <span class="person-tab__label">tanÃ¡rok</span>
            <span class="person-tab__count">{{ teacherCount() }}</span>
          </button>
        </div>
      }

      <!-- Results -->
      <div class="results-section">
        <!-- Results count -->
        <div class="results-header">
          @if (hasActiveFilters()) {
            <span class="results-count">
              {{ filteredCount() }} talÃ¡lat
              @if (showPersonTabs()) {
                <span class="of-total">/ {{ personTab() === 'student' ? studentCount() : teacherCount() }}</span>
              } @else {
                <span class="of-total">/ {{ activeCategoryData()?.count ?? 0 }}</span>
              }
            </span>
          } @else {
            <span class="results-count">
              {{ filteredCount() }} hiÃ¡nyzÃ³
              @if (showPersonTabs()) {
                {{ personTab() === 'student' ? 'diÃ¡k' : 'tanÃ¡r' }}
              }
            </span>
          }
        </div>

        <!-- User list -->
        @if (filteredUsers().length > 0) {
          <div class="user-list">
            @for (user of filteredUsers(); track trackByUserId($index, user); let i = $index) {
              <app-missing-user-card
                [user]="user"
                appStaggerAnimation
                [staggerIndex]="i"
                [staggerTotal]="filteredUsers().length"
                [staggerDelay]="30"
                (pokeClick)="onPokeClick($event)" />
            }
          </div>
        } @else {
          <!-- Empty search results -->
          <div class="empty-search-state">
            <span class="emoji">ğŸ”</span>
            @if (searchQuery()) {
              <p>nincs talÃ¡lat erre: <strong>â€{{ searchQuery() }}"</strong></p>
            } @else {
              <p>nincs ilyen szÅ±rÃ©si feltÃ©telnek megfelelÅ‘ hiÃ¡nyzÃ³</p>
            }
            <button class="clear-filters-btn" (click)="clearAllFilters()">
              szÅ±rÅ‘k tÃ¶rlÃ©se
            </button>
          </div>
        }
      </div>

      <!-- Summary -->
      @if (summary()) {
        <div class="summary">
          <span class="emoji">ğŸ“Š</span>
          <span class="text">Ã¶sszesen {{ summary()!.totalMissing }} hiÃ¡nyzÃ³</span>
        </div>
      }
    }
  }
</div>

<!-- Composer dialÃ³gus -->
@if (showComposer() && composerUser()) {
  <app-poke-composer
    [user]="composerUser()!"
    [category]="activeCategory()"
    (resultEvent)="onComposerResult($event)" />
}

<!-- Kapott bÃ¶kÃ©sek dialÃ³gus -->
@if (showReceivedDialog()) {
  <app-received-pokes-dialog
    [pokes]="receivedPokes()"
    (closeEvent)="closeReceivedDialog()"
    (reactionAddedEvent)="onReactionAdded($event)"
    (markAllReadEvent)="markAllAsRead()" />
}
