<div class="webshop-settings page-card">
  <div class="page-header">
    <h1><lucide-icon [name]="ICONS.STORE" [size]="24" /> Webshop beállítások</h1>
    <p class="subtitle">Fotónyomtatás rendelési rendszer konfigurálása</p>
  </div>

  @if (loading()) {
    <div class="skeleton-container">
      <div class="skeleton-row"></div>
      <div class="skeleton-row"></div>
      <div class="skeleton-row"></div>
    </div>
  } @else if (!settings()) {
    <!-- Nincs még inicializálva -->
    <div class="init-card">
      <lucide-icon [name]="ICONS.STORE" [size]="48" />
      <h2>Webshop bekapcsolása</h2>
      <p>A Webshop modul lehetővé teszi ügyfeleid számára, hogy fotónyomtatást rendeljenek online.</p>
      <p>Az aktiválás automatikusan létrehozza az alapértelmezett papírméreteket és típusokat.</p>
      <button class="btn btn-primary" (click)="initializeWebshop()" [disabled]="saving()">
        @if (saving()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" /> Inicializálás...
        } @else {
          <lucide-icon [name]="ICONS.PLUS" [size]="16" /> Webshop aktiválása
        }
      </button>
    </div>
  } @else {
    <!-- Általános beállítások -->
    <section class="settings-section">
      <h2>Általános</h2>

      <div class="form-group">
        <ps-toggle label="Webshop engedélyezve"
                   [ngModel]="settings()!.is_enabled"
                   (ngModelChange)="updateField('is_enabled', $event)" />
        <p class="help-text">Ha ki van kapcsolva, az ügyfelek nem tudnak rendelni.</p>
      </div>

      <ps-textarea label="Üdvözlő üzenet"
                   [rows]="3"
                   [ngModel]="settings()!.welcome_message ?? ''"
                   (ngModelChange)="updateField('welcome_message', $event)"
                   placeholder="Opcionális üzenet az ügyfelek számára..." />

      <ps-textarea label="ÁSZF szöveg"
                   [rows]="4"
                   [ngModel]="settings()!.terms_text ?? ''"
                   (ngModelChange)="updateField('terms_text', $event)"
                   placeholder="Általános Szerződési Feltételek..." />
    </section>

    <!-- Szállítás beállítások -->
    <section class="settings-section">
      <h2><lucide-icon [name]="ICONS.TRUCK" [size]="20" /> Szállítás</h2>

      <div class="form-row">
        <ps-toggle label="Személyes átvétel"
                   [ngModel]="settings()!.allow_pickup"
                   (ngModelChange)="updateField('allow_pickup', $event)" />
        <ps-toggle label="Házhozszállítás"
                   [ngModel]="settings()!.allow_shipping"
                   (ngModelChange)="updateField('allow_shipping', $event)" />
      </div>

      <div class="form-row">
        <ps-input label="Szállítási költség (Ft)" type="number" [min]="0"
                  [ngModel]="settings()!.shipping_cost_huf"
                  (ngModelChange)="updateField('shipping_cost_huf', $event)" />
        <ps-input label="Ingyenes szállítás felett (Ft)" type="number" [min]="0"
                  [ngModel]="settings()!.shipping_free_threshold_huf ?? ''"
                  (ngModelChange)="updateField('shipping_free_threshold_huf', $event || null)"
                  placeholder="Üres = nincs" />
      </div>

      <ps-input label="Minimum rendelési összeg (Ft)" type="number" [min]="0"
                [ngModel]="settings()!.min_order_amount_huf"
                (ngModelChange)="updateField('min_order_amount_huf', $event)" />
    </section>

    <div class="save-bar">
      <button class="btn btn-primary" (click)="saveSettings()" [disabled]="saving()">
        @if (saving()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" /> Mentés...
        } @else {
          <lucide-icon [name]="ICONS.CHECK" [size]="16" /> Beállítások mentése
        }
      </button>
    </div>

    <!-- Papírméretek -->
    <section class="settings-section">
      <div class="section-header">
        <h2>Papírméretek</h2>
        <button class="btn btn-sm btn-outline" (click)="showNewSizeForm.set(true)" matTooltip="Új méret">
          <lucide-icon [name]="ICONS.PLUS" [size]="16" />
        </button>
      </div>

      @if (showNewSizeForm()) {
        <div class="inline-form">
          <ps-input placeholder="Név (pl. 10x15)" size="md"
                    [ngModel]="newSize().name"
                    (ngModelChange)="newSize.set({...newSize(), name: $event})" />
          <ps-input type="number" placeholder="Szélesség (cm)" [min]="1" size="sm"
                    [ngModel]="newSize().width_cm"
                    (ngModelChange)="newSize.set({...newSize(), width_cm: $event})" />
          <ps-input type="number" placeholder="Magasság (cm)" [min]="1" size="sm"
                    [ngModel]="newSize().height_cm"
                    (ngModelChange)="newSize.set({...newSize(), height_cm: $event})" />
          <button class="btn btn-sm btn-primary" (click)="addPaperSize()">
            <lucide-icon [name]="ICONS.CHECK" [size]="14" />
          </button>
          <button class="btn btn-sm btn-ghost" (click)="showNewSizeForm.set(false)">
            <lucide-icon [name]="ICONS.X" [size]="14" />
          </button>
        </div>
      }

      <div class="items-list">
        @for (size of paperSizes(); track size.id) {
          <div class="item-row">
            @if (editingSizeId() === size.id) {
              <ps-input [(ngModel)]="size.name" size="sm" />
              <ps-input type="number" [(ngModel)]="size.width_cm" size="sm" />
              <span>x</span>
              <ps-input type="number" [(ngModel)]="size.height_cm" size="sm" />
              <span>cm</span>
              <button class="action-btn" (click)="updatePaperSize(size)" matTooltip="Mentés">
                <lucide-icon [name]="ICONS.CHECK" [size]="16" />
              </button>
              <button class="action-btn" (click)="editingSizeId.set(null)" matTooltip="Mégse">
                <lucide-icon [name]="ICONS.X" [size]="16" />
              </button>
            } @else {
              <span class="item-name">{{ size.name }}</span>
              <span class="item-detail">{{ size.width_cm }} x {{ size.height_cm }} cm</span>
              <span class="item-badge" [class.inactive]="!size.is_active">
                {{ size.is_active ? 'Aktív' : 'Inaktív' }}
              </span>
              <button class="action-btn" (click)="editingSizeId.set(size.id)" matTooltip="Szerkesztés">
                <lucide-icon [name]="ICONS.EDIT" [size]="16" />
              </button>
              <button class="action-btn danger" (click)="deletePaperSize(size)" matTooltip="Törlés">
                <lucide-icon [name]="ICONS.DELETE" [size]="16" />
              </button>
            }
          </div>
        } @empty {
          <p class="empty-text">Nincsenek papírméretek.</p>
        }
      </div>
    </section>

    <!-- Papírtípusok -->
    <section class="settings-section">
      <div class="section-header">
        <h2>Papírtípusok</h2>
        <button class="btn btn-sm btn-outline" (click)="showNewTypeForm.set(true)" matTooltip="Új típus">
          <lucide-icon [name]="ICONS.PLUS" [size]="16" />
        </button>
      </div>

      @if (showNewTypeForm()) {
        <div class="inline-form">
          <ps-input placeholder="Név (pl. Fényes)" size="md"
                    [ngModel]="newType().name"
                    (ngModelChange)="newType.set({...newType(), name: $event})" />
          <ps-input placeholder="Leírás (opcionális)" size="md"
                    [ngModel]="newType().description"
                    (ngModelChange)="newType.set({...newType(), description: $event})" />
          <button class="btn btn-sm btn-primary" (click)="addPaperType()">
            <lucide-icon [name]="ICONS.CHECK" [size]="14" />
          </button>
          <button class="btn btn-sm btn-ghost" (click)="showNewTypeForm.set(false)">
            <lucide-icon [name]="ICONS.X" [size]="14" />
          </button>
        </div>
      }

      <div class="items-list">
        @for (type of paperTypes(); track type.id) {
          <div class="item-row">
            @if (editingTypeId() === type.id) {
              <ps-input [(ngModel)]="type.name" size="sm" />
              <ps-input [(ngModel)]="type.description" size="sm" placeholder="Leírás" />
              <button class="action-btn" (click)="updatePaperType(type)" matTooltip="Mentés">
                <lucide-icon [name]="ICONS.CHECK" [size]="16" />
              </button>
              <button class="action-btn" (click)="editingTypeId.set(null)" matTooltip="Mégse">
                <lucide-icon [name]="ICONS.X" [size]="16" />
              </button>
            } @else {
              <span class="item-name">{{ type.name }}</span>
              <span class="item-detail">{{ type.description || '-' }}</span>
              <span class="item-badge" [class.inactive]="!type.is_active">
                {{ type.is_active ? 'Aktív' : 'Inaktív' }}
              </span>
              <button class="action-btn" (click)="editingTypeId.set(type.id)" matTooltip="Szerkesztés">
                <lucide-icon [name]="ICONS.EDIT" [size]="16" />
              </button>
              <button class="action-btn danger" (click)="deletePaperType(type)" matTooltip="Törlés">
                <lucide-icon [name]="ICONS.DELETE" [size]="16" />
              </button>
            }
          </div>
        } @empty {
          <p class="empty-text">Nincsenek papírtípusok.</p>
        }
      </div>
    </section>
  }
</div>

@if (showDeleteConfirm()) {
  <app-confirm-dialog
    title="Törlés megerősítése"
    [message]="deleteMessage()"
    confirmText="Törlés"
    (resultEvent)="onDeleteConfirmResult($event)"
  />
}
