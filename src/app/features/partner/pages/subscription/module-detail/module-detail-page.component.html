@if (loading() && !module()) {
  <div class="detail-page page-card">
    <div class="skeleton-hero"></div>
    <div class="skeleton-section"></div>
    <div class="skeleton-section"></div>
  </div>
} @else if (module(); as mod) {
  @if (content(); as c) {
    <div class="detail-page page-card">
      <!-- 1. Hero -->
      <div #heroSection>
        <app-detail-hero
          [module]="mod"
          [heroGradient]="c.heroGradient"
          [badge]="c.badge"
          (ctaClick)="activateModule()"
        />
      </div>

      <!-- 2. Előnyök -->
      @if (c.benefits.length) {
        <section appScrollReveal class="detail-section">
          <app-detail-benefits [benefits]="c.benefits" />
        </section>
      }

      <!-- 3. Hogyan működik -->
      @if (c.steps.length) {
        <section appScrollReveal [revealDelay]="100" class="detail-section">
          <app-detail-how-it-works [steps]="c.steps" />
        </section>
      }

      <!-- 4. Funkciók (inline) -->
      @if (c.features.length) {
        <section appScrollReveal [revealDelay]="150" class="detail-section">
          <h2 class="section-title">Funkciók</h2>
          <div class="features-grid">
            @for (feature of c.features; track feature.text) {
              <div class="feature-item">
                <lucide-icon [name]="ICONS.CHECK" [size]="16" />
                <span>{{ feature.text }}</span>
              </div>
            }
          </div>
        </section>
      }

      <!-- 5. Képernyőképek -->
      @if (c.screenshots.length) {
        <section appScrollReveal [revealDelay]="200" class="detail-section">
          <app-detail-screenshots [screenshots]="c.screenshots" (openLightbox)="screenshotLightboxIndex.set($event)" />
        </section>
      }

      <!-- 6. Ki használja? (inline) -->
      @if (c.useCases.length) {
        <section appScrollReveal [revealDelay]="200" class="detail-section">
          <h2 class="section-title">Ki használja?</h2>
          <div class="usecases-grid">
            @for (uc of c.useCases; track uc.persona) {
              <div class="usecase-card">
                <div class="usecase-icon">
                  <lucide-icon [name]="uc.icon" [size]="22" />
                </div>
                <h3>{{ uc.persona }}</h3>
                <p>{{ uc.description }}</p>
              </div>
            }
          </div>
        </section>
      }

      <!-- 7. Árazás -->
      <section appScrollReveal [revealDelay]="100" class="detail-section">
        <app-detail-pricing [module]="mod" (ctaClick)="activateModule()" />
      </section>

      <!-- 8. Kapcsolódó modulok (inline) -->
      @if (dependsOnModules().length || relatedModules().length) {
        <section appScrollReveal [revealDelay]="100" class="detail-section">
          <h2 class="section-title">Kapcsolódó modulok</h2>

          @if (dependsOnModules().length) {
            <p class="related-label">Ehhez szükséges:</p>
            <div class="related-grid">
              @for (dep of dependsOnModules(); track dep.key) {
                <a class="related-card related-card--dependency"
                   [routerLink]="['/partner/subscription/marketplace', dep.key]">
                  <div class="related-icon">
                    <lucide-icon [name]="dep.icon" [size]="18" />
                  </div>
                  <div class="related-text">
                    <span class="related-name">{{ dep.name }}</span>
                    <span class="related-tagline">{{ dep.tagline }}</span>
                  </div>
                </a>
              }
            </div>
          }

          @if (relatedModules().length) {
            <p class="related-label">Ezekkel jól működik:</p>
            <div class="related-grid">
              @for (rel of relatedModules(); track rel.key) {
                <a class="related-card"
                   [routerLink]="['/partner/subscription/marketplace', rel.key]">
                  <div class="related-icon">
                    <lucide-icon [name]="rel.icon" [size]="18" />
                  </div>
                  <div class="related-text">
                    <span class="related-name">{{ rel.name }}</span>
                    <span class="related-tagline">{{ rel.tagline }}</span>
                  </div>
                </a>
              }
            </div>
          }
        </section>
      }

      <!-- 9. GYIK -->
      @if (c.faq.length) {
        <section appScrollReveal [revealDelay]="100" class="detail-section">
          <app-detail-faq [faq]="c.faq" />
        </section>
      }
    </div>

    <!-- Sticky CTA (mobilon) -->
    @if (showStickyCta()) {
      <div class="sticky-cta">
        <div class="sticky-cta__content">
          <span class="sticky-cta__name">{{ mod.name }}</span>
          @if (!(['active', 'package', 'trial', 'free'].includes(mod.partner_status))) {
            <button class="sticky-cta__btn" (click)="activateModule()">
              {{ mod.cta_button || 'Feliratkozás' }}
            </button>
          } @else {
            <span class="sticky-cta__active">
              <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="14" />
              Aktív
            </span>
          }
        </div>
      </div>
    }

    <!-- Képernyőkép lightbox — page-card-on KÍVÜL (backdrop-filter stacking context) -->
    @if (screenshotLightboxIndex() !== null && c.screenshots[screenshotLightboxIndex()!]; as shot) {
      <div class="lightbox-overlay" (click)="screenshotLightboxIndex.set(null)">
        <div class="lightbox-content" (click)="$event.stopPropagation()">
          <button class="lightbox-close" (click)="screenshotLightboxIndex.set(null)">
            <lucide-icon [name]="ICONS.X" [size]="20" />
          </button>
          @if (c.screenshots.length > 1) {
            <button class="lightbox-nav lightbox-nav--prev" (click)="prevScreenshot(c.screenshots.length)">
              <lucide-icon [name]="ICONS.CHEVRON_LEFT" [size]="24" />
            </button>
            <button class="lightbox-nav lightbox-nav--next" (click)="nextScreenshot(c.screenshots.length)">
              <lucide-icon [name]="ICONS.CHEVRON_RIGHT" [size]="24" />
            </button>
          }
          @if (shot.src) {
            <img [src]="shot.src" [alt]="shot.alt" />
          } @else {
            <div class="lightbox-placeholder">
              <lucide-icon [name]="ICONS.IMAGE" [size]="48" />
              <span>Képernyőkép hamarosan</span>
            </div>
          }
          <p class="lightbox-caption">{{ shot.caption }}</p>
        </div>
      </div>
    }
  }
}
