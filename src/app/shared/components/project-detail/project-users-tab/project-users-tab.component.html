<!-- Szűrők -->
<div class="filters">
  <div class="search-box">
    <lucide-icon [name]="ICONS.SEARCH" [size]="16" class="search-icon" />
    <input
      type="text"
      class="search-input"
      placeholder="Keresés név vagy email alapján..."
      [(ngModel)]="search"
      (keyup.enter)="onSearch()"
    />
    @if (search) {
      <button class="clear-btn" (click)="clearSearch()">
        <lucide-icon [name]="ICONS.X" [size]="14" />
      </button>
    }
  </div>

  <select class="filter-select" [value]="activeFilter()" (change)="onFilterChange($any($event.target).value)">
    @for (f of filters; track f.value) {
      <option [value]="f.value">{{ f.label }}</option>
    }
  </select>
</div>

<!-- Loading -->
@if (loading()) {
  <div class="loading-state">
    @for (i of [1,2,3,4,5]; track i) {
      <div class="skeleton-row skeleton-shimmer"></div>
    }
  </div>
} @else if (sessions().length === 0) {
  <!-- Üres állapot -->
  <div class="empty-state">
    <div class="empty-icon">
      <lucide-icon [name]="ICONS.USERS" [size]="48" />
    </div>
    <h3>Nincsenek felhasználók</h3>
    <p>Még senki nem csatlakozott ehhez a projekthez.</p>
  </div>
} @else {
  <!-- Fejléc -->
  <div class="table-header users-grid">
    <span class="th">Név</span>
    <span class="th">Státusz</span>
    <span class="th">Rang</span>
    <span class="th">Utolsó aktivitás</span>
    <span class="th th-actions">Műveletek</span>
  </div>

  <!-- Lista -->
  <div class="row-grid">
    @for (session of sessions(); track session.id; let i = $index) {
      <div class="list-row users-grid" [style.animation-delay]="i * 0.03 + 's'">
        <div class="user-info">
          <span class="user-name">{{ session.guestName }}</span>
          @if (session.guestEmail) {
            <span class="user-email">{{ session.guestEmail }}</span>
          }
          @if (session.isCoordinator) {
            <span class="coordinator-badge" matTooltip="Kapcsolattartó">
              <lucide-icon [name]="ICONS.KEY" [size]="12" />
            </span>
          }
        </div>

        <div>
          <span [class]="getStatusBadgeClass(session)">
            {{ getStatusLabel(session) }}
          </span>
        </div>

        <div class="rank-info">
          <span class="rank-level">{{ session.rankName }}</span>
          <span class="rank-points">{{ session.points }} pont</span>
        </div>

        <div class="activity-date">
          @if (session.lastActivityAt) {
            {{ session.lastActivityAt | date:'yyyy.MM.dd HH:mm' }}
          } @else {
            <span class="text-gray-400">-</span>
          }
        </div>

        <div class="actions" style="margin: -2px;">
          <button
            class="action-btn"
            style="margin: 2px;"
            matTooltip="Szerkesztés"
            (click)="openEdit(session)"
          >
            <lucide-icon [name]="ICONS.EDIT" [size]="15" />
          </button>
          <button
            class="action-btn"
            style="margin: 2px;"
            [matTooltip]="session.isBanned ? 'Feloldás' : 'Tiltás'"
            (click)="toggleBan(session)"
          >
            <lucide-icon [name]="session.isBanned ? ICONS.CHECK_CIRCLE : ICONS.BAN" [size]="15" />
          </button>
          <button
            class="action-btn action-btn--danger"
            style="margin: 2px;"
            matTooltip="Törlés"
            (click)="confirmDelete(session)"
          >
            <lucide-icon [name]="ICONS.DELETE" [size]="15" />
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Pagination -->
  @if (lastPage() > 1) {
    <div class="pagination">
      <button
        class="page-btn"
        [disabled]="currentPage() <= 1"
        (click)="goToPage(currentPage() - 1)"
      >
        <lucide-icon [name]="ICONS.CHEVRON_LEFT" [size]="16" />
        Előző
      </button>
      <span class="page-info">
        {{ currentPage() }} / {{ lastPage() }}
        <span class="total-count">({{ total() }} felhasználó)</span>
      </span>
      <button
        class="page-btn"
        [disabled]="currentPage() >= lastPage()"
        (click)="goToPage(currentPage() + 1)"
      >
        Következő
        <lucide-icon [name]="ICONS.CHEVRON_RIGHT" [size]="16" />
      </button>
    </div>
  }
}

<!-- Edit dialog -->
@if (editingSession(); as session) {
  <app-guest-session-edit-dialog
    [projectId]="projectId()"
    [session]="session"
    (close)="closeEdit()"
    (saved)="onEditSaved()"
  />
}

<!-- Delete confirmation -->
@if (showDeleteConfirm()) {
  <div class="dialog-backdrop" (click)="cancelDelete()">
    <div class="dialog-panel max-w-sm p-5" (click)="$event.stopPropagation()">
      <div class="flex flex-col items-center text-center">
        <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mb-4">
          <lucide-icon [name]="ICONS.DELETE" [size]="28" class="text-red-500" />
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Felhasználó törlése</h3>
        <p class="text-sm text-gray-600 mb-5">
          Biztosan törölni szeretnéd <strong>{{ deletingSession()?.guestName }}</strong> felhasználót?
        </p>
      </div>
      <div class="flex" style="margin: -6px;">
        <button
          class="flex-1 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors"
          style="margin: 6px;"
          (click)="cancelDelete()"
        >Mégse</button>
        <button
          class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white font-medium rounded-lg transition-colors"
          style="margin: 6px;"
          (click)="deleteSession()"
          [disabled]="deleting()"
        >{{ deleting() ? 'Törlés...' : 'Törlés' }}</button>
      </div>
    </div>
  </div>
}
