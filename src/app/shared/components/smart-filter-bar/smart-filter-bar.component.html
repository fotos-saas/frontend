<div class="smart-filter-bar" role="search">
  <!-- Search box -->
  <div class="search-box-wrapper" [class.search-box-wrapper--active]="hasSearchText()">
    <ps-input
      class="search-box"
      prefix="search"
      [placeholder]="searchConfig().placeholder"
      [ngModel]="filterState().search()"
      (ngModelChange)="filterState().setSearch($event)"
      [helpItems]="searchHelpItems()"
      helpTitle="Keresési szintaxis"
    />
    @if (hasSearchText()) {
      <button
        type="button"
        class="search-clear-btn"
        matTooltip="Keresés törlése"
        (click)="clearSearch()"
      >
        <lucide-icon [name]="ICONS.X" [size]="14" />
      </button>
    }
    <!-- Mobil szűrő gomb -->
    @if (filterConfigs().length > 0 || searchableFilters().length > 0) {
      <button
        type="button"
        class="mobile-filter-toggle"
        [class.mobile-filter-toggle--active]="mobileFiltersOpen() || hasActiveFilters()"
        (click)="toggleMobileFilters()"
      >
        <lucide-icon [name]="ICONS.FILTER" [size]="16" />
        @if (activeFilterCount() > 0) {
          <span class="mobile-filter-badge">{{ activeFilterCount() }}</span>
        }
      </button>
    }
  </div>

  <!-- Searchable Select filters -->
  @for (sf of searchableFilters(); track sf.id) {
    <ps-searchable-select
      class="searchable-filter"
      [options]="sf.options"
      [value]="filterState().filters()[sf.id]"
      [placeholder]="sf.placeholder"
      [allLabel]="sf.allLabel"
      (valueChange)="onSearchableFilterChange(sf.id, $event)"
    />
  }

  <!-- Expandable Filters -->
  @if (filterConfigs().length > 0) {
    <div class="filter-controls">
      <app-expandable-filters
        [filters]="filterConfigs()"
        [values]="filterState().filters()"
        [visibleCount]="visibleFilterCount()"
        [size]="filterSize()"
        (filterChange)="onFilterChange($event)"
      />
    </div>
  }

  <ng-content select="[filterBarExtra]" />
</div>

<!-- Mobil szűrők (összecsukható) -->
@if (mobileFiltersOpen()) {
  <div class="mobile-filters-panel">
    @for (sf of searchableFilters(); track sf.id) {
      <ps-searchable-select
        [options]="sf.options"
        [value]="filterState().filters()[sf.id]"
        [placeholder]="sf.placeholder"
        [allLabel]="sf.allLabel"
        (valueChange)="onSearchableFilterChange(sf.id, $event)"
      />
    }
    @if (filterConfigs().length > 0) {
      <app-expandable-filters
        [filters]="filterConfigs()"
        [values]="filterState().filters()"
        [visibleCount]="99"
        (filterChange)="onFilterChange($event)"
      />
    }
  </div>
}

<!-- Mobile sort bar (640px alatt) -->
@if (sortConfig(); as sort) {
  @if (sort.showMobileSort !== false) {
    <div class="mobile-sort-bar">
      <div class="mobile-sort-group">
        <label class="mobile-sort-label">Rendezés:</label>
        <div class="mobile-sort-dropdown">
          <button
            type="button"
            class="mobile-sort-trigger"
            (click)="toggleMobileSortDropdown()"
          >
            <span>{{ currentSortLabel() }}</span>
            <lucide-icon [name]="ICONS.CHEVRON_DOWN" [size]="16" />
          </button>
          @if (mobileSortOpen()) {
            <div class="mobile-sort-options">
              @for (opt of sort.options; track opt.value) {
                <button
                  type="button"
                  class="mobile-sort-option"
                  [class.mobile-sort-option--active]="filterState().sortBy() === opt.value"
                  (click)="selectMobileSortOption(opt.value)"
                >
                  @if (filterState().sortBy() === opt.value) {
                    <lucide-icon [name]="ICONS.CHECK" [size]="14" />
                  }
                  {{ opt.label }}
                </button>
              }
            </div>
          }
        </div>
        <button
          type="button"
          class="mobile-sort-dir-btn"
          (click)="toggleMobileSortDir()"
          [attr.aria-label]="filterState().sortDir() === 'asc' ? 'Növekvő sorrend' : 'Csökkenő sorrend'"
        >
          <lucide-icon [name]="filterState().sortDir() === 'asc' ? ICONS.ARROW_UP : ICONS.ARROW_DOWN" [size]="16" />
        </button>
      </div>
    </div>
  }
}
