<div class="project-tablo-editor page-card page-card--narrow">
  <!-- Loading -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-16">
      <div class="w-10 h-10 border-3 border-gray-200 border-t-primary rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-500">Betöltés...</p>
    </div>
  } @else if (projectData()) {
    <!-- Fejléc -->
    <app-project-detail-header
      [project]="projectData()"
      (back)="goBack()"
    />

    <!-- Tablószerkesztő mód jelző -->
    <div class="editor-mode-badge">
      <lucide-icon [name]="ICONS.LAYERS" [size]="16" />
      Tablószerkesztő mód
    </div>

    <!-- Tab navigáció -->
    <nav class="tab-nav" role="tablist">
      <button
        class="tab-nav__item"
        [class.tab-nav__item--active]="activeTab() === 'commands'"
        (click)="activeTab.set('commands')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'commands'"
      >
        <lucide-icon [name]="ICONS.PLAY" [size]="16" />
        Parancsok
      </button>
      <button
        class="tab-nav__item"
        [class.tab-nav__item--active]="activeTab() === 'settings'"
        (click)="activeTab.set('settings')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'settings'"
      >
        <lucide-icon [name]="ICONS.SETTINGS" [size]="16" />
        Beállítások
      </button>
      <button
        class="tab-nav__item"
        [class.tab-nav__item--active]="activeTab() === 'debug'"
        (click)="activeTab.set('debug')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'debug'"
      >
        <lucide-icon [name]="ICONS.BUG" [size]="16" />
        Debug
      </button>
    </nav>

    <!-- ============ Parancsok tab ============ -->
    @if (activeTab() === 'commands') {
      <div class="tab-content" role="tabpanel">
        <!-- Photoshop státusz (rövid) -->
        <div class="ps-status" [class.ps-status--ok]="isConfigured()" [class.ps-status--warn]="!isConfigured()">
          @if (checking()) {
            <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
            <span>Photoshop keresése...</span>
          } @else if (isConfigured()) {
            <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="16" />
            <span>Photoshop konfigurálva</span>
            <button
              class="btn btn--sm btn--primary"
              [disabled]="launching()"
              (click)="launchPs()"
            >
              @if (launching()) {
                <lucide-icon [name]="ICONS.LOADER" [size]="14" class="spin" />
              } @else {
                <lucide-icon [name]="ICONS.PLAY" [size]="14" />
              }
              Indítás
            </button>
          } @else {
            <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="16" />
            <span>Photoshop nincs beállítva</span>
            <button class="btn btn--sm btn--outline" (click)="activeTab.set('settings')">
              Beállítás
            </button>
          }
        </div>

        <!-- Tabló generálása -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.FILE_PLUS" [size]="20" />
            <div>
              <h3 class="command-card__title">Tabló generálása</h3>
              <p class="command-card__desc">Üres PSD fájl generálása mappastruktúrával (200 DPI, RGB).</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else if (loadingSizes()) {
            <div class="command-card__loading">
              <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
              Méretek betöltése...
            </div>
          } @else if (tabloSizes().length === 0) {
            <div class="command-card__empty">
              <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="16" />
              Nincsenek beállított tablóméretek.
            </div>
          } @else {
            <div class="size-grid">
              @for (size of tabloSizes(); track size.value) {
                <button
                  class="size-card"
                  [class.size-card--selected]="selectedSize()?.value === size.value"
                  (click)="selectSize(size)"
                >
                  <span class="size-card__label">{{ size.label }}</span>
                  <span class="size-card__pixels">{{ getSizePixels(size) }}</span>
                </button>
              }
            </div>

            <button
              class="btn btn--primary btn--generate"
              [disabled]="!selectedSize() || generating()"
              (click)="generatePsd()"
            >
              @if (generating()) {
                <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
                Generálás...
              } @else {
                <lucide-icon [name]="ICONS.FILE_PLUS" [size]="16" />
                PSD generálás és megnyitás
              }
            </button>
          }
        </div>

        <!-- Rácsba rendezés (meglévő PSD-n) -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.GRID" [size]="20" />
            <div>
              <h3 class="command-card__title">Rácsba rendezés</h3>
              <p class="command-card__desc">A megnyitott PSD képeit rendezi rácsba a beállított gap és margó értékek alapján.</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else if (!selectedSize()) {
            <div class="command-card__disabled">
              Válassz méretet a fenti szekciónál.
            </div>
          } @else {
            <button
              class="btn btn--primary btn--generate"
              [disabled]="arranging()"
              (click)="arrangeGrid()"
            >
              @if (arranging()) {
                <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
                Rendezés...
              } @else {
                <lucide-icon [name]="ICONS.GRID" [size]="16" />
                Rácsba rendezés
              }
            </button>
          }
        </div>

        <!-- Nevek rendezése (meglévő PSD-n) -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.FILE_TEXT" [size]="20" />
            <div>
              <h3 class="command-card__title">Nevek rendezése</h3>
              <p class="command-card__desc">A név layereket a hozzájuk tartozó képek alá pozícionálja a beállított távolsággal.</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else {
            <button
              class="btn btn--primary btn--generate"
              [disabled]="arrangingNames()"
              (click)="arrangeNames()"
            >
              @if (arrangingNames()) {
                <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
                Rendezés...
              } @else {
                <lucide-icon [name]="ICONS.FILE_TEXT" [size]="16" />
                Nevek rendezése
              }
            </button>
          }
        </div>

        <!-- Pillanatképek (elrendezés mentés + visszaállítás) -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.HISTORY" [size]="20" />
            <div>
              <h3 class="command-card__title">Pillanatképek</h3>
              <p class="command-card__desc">Az aktuális elrendezés mentése és korábbi állapot visszaállítása.</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else if (!selectedSize()) {
            <div class="command-card__disabled">
              Válassz méretet a fenti szekciónál.
            </div>
          } @else {
            <div class="snapshot-actions">
              <button
                class="btn btn--primary"
                [disabled]="snapshotService.updatingSnapshot() || snapshotService.savingSnapshot()"
                (click)="updateSnapshot()"
              >
                @if (snapshotService.updatingSnapshot()) {
                  <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
                  Frissítés...
                } @else {
                  <lucide-icon [name]="ICONS.SAVE" [size]="16" />
                  Elrendezés frissítése
                }
              </button>
              <button
                class="btn btn--outline"
                [disabled]="snapshotService.savingSnapshot()"
                (click)="snapshotService.openSaveDialog()"
              >
                <lucide-icon [name]="ICONS.PLUS" [size]="16" />
                Új pillanatkép
              </button>
              <button
                class="btn btn--outline btn--sm"
                [disabled]="snapshotService.loadingSnapshots()"
                (click)="loadSnapshots()"
                matTooltip="Lista frissítése"
              >
                <lucide-icon [name]="ICONS.REFRESH" [size]="14" />
              </button>
            </div>

            @if (snapshotService.loadingSnapshots()) {
              <div class="command-card__loading">
                <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
                Pillanatképek betöltése...
              </div>
            } @else if (snapshotService.snapshots().length === 0) {
              <div class="snapshot-empty">
                <lucide-icon [name]="ICONS.HISTORY" [size]="20" />
                <p>Még nincsenek pillanatképek.</p>
                <p class="snapshot-empty__hint">Az "Elrendezés frissítése" gomb automatikusan létrehoz egyet.</p>
              </div>
            } @else {
              <div class="snapshot-list">
                @for (group of groupedSnapshots(); track group.original.fileName) {
                  <!-- Eredeti snapshot -->
                  <div class="snapshot-item">
                    @if (group.edited.length > 0) {
                      <button
                        class="snapshot-item__toggle"
                        (click)="toggleGroupCollapse(group.original.snapshotName)"
                        [matTooltip]="isGroupCollapsed(group.original.snapshotName) ? 'Szerkesztett verziók mutatása' : 'Szerkesztett verziók elrejtése'"
                      >
                        <lucide-icon
                          [name]="isGroupCollapsed(group.original.snapshotName) ? ICONS.CHEVRON_RIGHT : ICONS.CHEVRON_DOWN"
                          [size]="14"
                        />
                      </button>
                    }
                    <div class="snapshot-item__info">
                      @if (snapshotService.editingSnapshotPath() === group.original.filePath) {
                        <input
                          type="text"
                          class="snapshot-item__edit-input"
                          [value]="snapshotService.editingName()"
                          (input)="snapshotService.editingName.set($any($event.target).value)"
                          (keydown.enter)="commitSnapshotRename()"
                          (keydown.escape)="snapshotService.cancelEditing()"
                          (blur)="commitSnapshotRename()"
                        />
                      } @else {
                        <span
                          class="snapshot-item__name snapshot-item__name--editable"
                          (dblclick)="snapshotService.startEditing(group.original)"
                          matTooltip="Dupla kattintás az átnevezéshez"
                        >{{ group.original.snapshotName }}</span>
                      }
                      <span class="snapshot-item__meta">
                        {{ snapshotService.formatDate(group.original.createdAt) }}
                        · {{ group.original.personCount }} layer
                        @if (group.edited.length > 0) {
                          · <span class="snapshot-item__badge snapshot-item__badge--count">{{ group.edited.length }} szerkesztett</span>
                        }
                        @if (group.original.snapshotName.includes('(szerkesztett)')) {
                          · <span class="snapshot-item__badge">szerkesztett</span>
                        }
                      </span>
                    </div>
                    <div class="snapshot-item__actions">
                      <button
                        class="btn btn--sm btn--primary"
                        [disabled]="snapshotService.restoringSnapshotPath() !== null"
                        (click)="restoreSnapshot(group.original)"
                        matTooltip="Visszaállítás"
                      >
                        @if (snapshotService.restoringSnapshotPath() === group.original.filePath) {
                          <lucide-icon [name]="ICONS.LOADER" [size]="14" class="spin" />
                        } @else {
                          <lucide-icon [name]="ICONS.UNDO" [size]="14" />
                        }
                      </button>
                      <button
                        class="btn btn--sm btn--outline"
                        (click)="deleteSnapshot(group.original)"
                        matTooltip="Törlés"
                      >
                        <lucide-icon [name]="ICONS.DELETE" [size]="14" />
                      </button>
                    </div>
                  </div>

                  <!-- Szerkesztett verziók (behúzva, összecsukható) -->
                  @if (group.edited.length > 0 && !isGroupCollapsed(group.original.snapshotName)) {
                    @for (snap of group.edited; track snap.fileName) {
                      <div class="snapshot-item snapshot-item--child">
                        <div class="snapshot-item__indent"></div>
                        <div class="snapshot-item__info">
                          @if (snapshotService.editingSnapshotPath() === snap.filePath) {
                            <input
                              type="text"
                              class="snapshot-item__edit-input"
                              [value]="snapshotService.editingName()"
                              (input)="snapshotService.editingName.set($any($event.target).value)"
                              (keydown.enter)="commitSnapshotRename()"
                              (keydown.escape)="snapshotService.cancelEditing()"
                              (blur)="commitSnapshotRename()"
                            />
                          } @else {
                            <span
                              class="snapshot-item__name snapshot-item__name--editable"
                              (dblclick)="snapshotService.startEditing(snap)"
                              matTooltip="Dupla kattintás az átnevezéshez"
                            >{{ snap.snapshotName }}</span>
                          }
                          <span class="snapshot-item__meta">
                            {{ snapshotService.formatDate(snap.createdAt) }}
                            · {{ snap.personCount }} layer
                            · <span class="snapshot-item__badge">szerkesztett</span>
                          </span>
                        </div>
                        <div class="snapshot-item__actions">
                          <button
                            class="btn btn--sm btn--primary"
                            [disabled]="snapshotService.restoringSnapshotPath() !== null"
                            (click)="restoreSnapshot(snap)"
                            matTooltip="Visszaállítás"
                          >
                            @if (snapshotService.restoringSnapshotPath() === snap.filePath) {
                              <lucide-icon [name]="ICONS.LOADER" [size]="14" class="spin" />
                            } @else {
                              <lucide-icon [name]="ICONS.UNDO" [size]="14" />
                            }
                          </button>
                          <button
                            class="btn btn--sm btn--outline"
                            (click)="deleteSnapshot(snap)"
                            matTooltip="Törlés"
                          >
                            <lucide-icon [name]="ICONS.DELETE" [size]="14" />
                          </button>
                        </div>
                      </div>
                    }
                  }
                }
              </div>
            }
          }
        </div>

        <!-- Vizuális szerkesztő -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.MAXIMIZE_2" [size]="20" />
            <div>
              <h3 class="command-card__title">Vizuális szerkesztő</h3>
              <p class="command-card__desc">A pillanatkép alapján megjeleníti a tábló elrendezését. Elemek mozgatása, igazítása drag-and-drop-pal.</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else if (!selectedSize()) {
            <div class="command-card__disabled">
              Válassz méretet a fenti szekciónál.
            </div>
          } @else if (snapshotService.snapshots().length === 0) {
            <div class="command-card__disabled">
              Még nincs pillanatkép. Generálj PSD-t vagy mentsd az aktuális elrendezést.
            </div>
          } @else {
            <button
              class="btn btn--primary btn--generate"
              (click)="openLayoutDesigner()"
            >
              <lucide-icon [name]="ICONS.MAXIMIZE_2" [size]="16" />
              Vizuális szerkesztő megnyitása
            </button>
          }
        </div>

        <!-- Sablonok (globális elrendezés mentés + alkalmazás) -->
        <div class="command-card">
          <div class="command-card__header">
            <lucide-icon [name]="ICONS.LAYOUT_TEMPLATE" [size]="20" />
            <div>
              <h3 class="command-card__title">Sablonok</h3>
              <p class="command-card__desc">Elrendezés mentése újrafelhasználható sablonként, vagy meglévő sablon alkalmazása.</p>
            </div>
          </div>

          @if (!isConfigured()) {
            <div class="command-card__disabled">
              Először állítsd be a Photoshop-ot a Beállítások fülön.
            </div>
          } @else if (!selectedSize()) {
            <div class="command-card__disabled">
              Válassz méretet a fenti szekciónál.
            </div>
          } @else {
            <div class="snapshot-actions">
              <button
                class="btn btn--outline"
                [disabled]="templateService.savingTemplate()"
                (click)="templateService.openSaveDialog()"
              >
                <lucide-icon [name]="ICONS.SAVE" [size]="16" />
                Sablon mentése
              </button>
              <button
                class="btn btn--primary"
                [disabled]="templateService.applyingTemplate()"
                (click)="templateService.openApplyDialog()"
              >
                <lucide-icon [name]="ICONS.LAYOUT_TEMPLATE" [size]="16" />
                Sablon alkalmazása
              </button>
            </div>
          }
        </div>
      </div>
    }

    <!-- ============ Beállítások tab ============ -->
    @if (activeTab() === 'settings') {
      <div class="tab-content" role="tabpanel">
        <!-- Photoshop elérési út -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.FOLDER_OPEN" [size]="20" />
            <div>
              <h3 class="settings-card__title">Photoshop elérési út</h3>
              @if (isConfigured()) {
                <p class="settings-card__desc settings-card__desc--ok">
                  <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="14" />
                  {{ psPath() }}
                </p>
              } @else if (checking()) {
                <p class="settings-card__desc">Keresés...</p>
              } @else {
                <p class="settings-card__desc">Add meg a Photoshop alkalmazás elérési útját a számítógépeden.</p>
              }
            </div>
          </div>

          @if (!isConfigured() && !checking()) {
            <div class="settings-path">
              <div class="settings-path__empty">Nincs beállítva</div>
              <button class="btn btn--outline" (click)="selectPsPath()">
                <lucide-icon [name]="ICONS.FOLDER_OPEN" [size]="16" />
                Tallózás
              </button>
            </div>
          }
        </div>

        <!-- Tabló margó -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.RULER" [size]="20" />
            <div>
              <h3 class="settings-card__title">Tabló margó</h3>
              <p class="settings-card__desc">Guide-ok távolsága a PSD szélétől (cm). 0 = nincs guide.</p>
            </div>
          </div>

          <div class="settings-input-row">
            <input
              type="number"
              class="settings-input"
              [value]="marginCm()"
              min="0"
              max="10"
              step="0.5"
              (change)="setMarginValue($event)"
            />
            <span class="settings-input-unit">cm</span>
          </div>
        </div>

        <!-- Képméretek -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.IMAGE" [size]="20" />
            <div>
              <h3 class="settings-card__title">Képméretek</h3>
              <p class="settings-card__desc">Diák és tanár fotó layer mérete a tablón (cm). A Smart Object belső mérete változatlan marad.</p>
            </div>
          </div>

          <div class="settings-size-row">
            <div class="settings-size-field">
              <label class="settings-size-label">Diák</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="studentSizeCm()"
                  min="1"
                  max="30"
                  step="0.5"
                  (change)="setStudentSizeValue($event)"
                />
                <span class="settings-input-unit">cm</span>
              </div>
            </div>
            <div class="settings-size-field">
              <label class="settings-size-label">Tanár</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="teacherSizeCm()"
                  min="1"
                  max="30"
                  step="0.5"
                  (change)="setTeacherSizeValue($event)"
                />
                <span class="settings-input-unit">cm</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Képek közötti távolság -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.GRID" [size]="20" />
            <div>
              <h3 class="settings-card__title">Képek közötti távolság</h3>
              <p class="settings-card__desc">Vízszintes és függőleges rés a rácsban (cm). 0 = nincs rés.</p>
            </div>
          </div>

          <div class="settings-size-row">
            <div class="settings-size-field">
              <label class="settings-size-label">Vízszintes</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="gapHCm()"
                  min="0"
                  max="10"
                  step="0.5"
                  (change)="setGapHValue($event)"
                />
                <span class="settings-input-unit">cm</span>
              </div>
            </div>
            <div class="settings-size-field">
              <label class="settings-size-label">Függőleges</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="gapVCm()"
                  min="0"
                  max="10"
                  step="0.5"
                  (change)="setGapVValue($event)"
                />
                <span class="settings-input-unit">cm</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Nevek beállításai -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.FILE_TEXT" [size]="20" />
            <div>
              <h3 class="settings-card__title">Nevek beállításai</h3>
              <p class="settings-card__desc">Név layerek pozíciója és tördelése a tablón.</p>
            </div>
          </div>

          <div class="settings-size-row">
            <div class="settings-size-field">
              <label class="settings-size-label">Távolság kép aljától</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="nameGapCm()"
                  min="0"
                  max="5"
                  step="0.1"
                  (change)="setNameGapValue($event)"
                />
                <span class="settings-input-unit">cm</span>
              </div>
            </div>
            <div class="settings-size-field">
              <label class="settings-size-label">Tördelés</label>
              <div class="settings-input-row">
                <input
                  type="number"
                  class="settings-input"
                  [value]="nameBreakAfter()"
                  min="0"
                  max="5"
                  step="1"
                  (change)="setNameBreakAfterValue($event)"
                />
                <span class="settings-input-unit">szó</span>
              </div>
              <p class="settings-hint">3+ szavas neveknél ennyi szó után sortörés. Rövid prefixek (Dr.) nem számítanak.</p>
            </div>
          </div>
        </div>

        <!-- Igazítás -->
        <div class="settings-card">
          <div class="settings-card__header">
            <lucide-icon [name]="ICONS.ALIGN_CENTER" [size]="20" />
            <div>
              <h3 class="settings-card__title">Igazítás</h3>
              <p class="settings-card__desc">Nevek és képek igazítása a tablón.</p>
            </div>
          </div>

          <div class="settings-size-row">
            <div class="settings-size-field">
              <label class="settings-size-label">Nevek</label>
              <div class="align-toggle">
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="textAlign() === 'left'"
                  (click)="setTextAlignValue('left')"
                  matTooltip="Balra"
                >
                  <lucide-icon [name]="ICONS.ALIGN_LEFT" [size]="16" />
                </button>
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="textAlign() === 'center'"
                  (click)="setTextAlignValue('center')"
                  matTooltip="Középre"
                >
                  <lucide-icon [name]="ICONS.ALIGN_CENTER" [size]="16" />
                </button>
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="textAlign() === 'right'"
                  (click)="setTextAlignValue('right')"
                  matTooltip="Jobbra"
                >
                  <lucide-icon [name]="ICONS.ALIGN_RIGHT" [size]="16" />
                </button>
              </div>
            </div>
            <div class="settings-size-field">
              <label class="settings-size-label">Képek</label>
              <div class="align-toggle">
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="gridAlign() === 'left'"
                  (click)="setGridAlignValue('left')"
                  matTooltip="Balra"
                >
                  <lucide-icon [name]="ICONS.ALIGN_LEFT" [size]="16" />
                </button>
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="gridAlign() === 'center'"
                  (click)="setGridAlignValue('center')"
                  matTooltip="Középre"
                >
                  <lucide-icon [name]="ICONS.ALIGN_CENTER" [size]="16" />
                </button>
                <button
                  class="align-toggle__btn"
                  [class.align-toggle__btn--active]="gridAlign() === 'right'"
                  (click)="setGridAlignValue('right')"
                  matTooltip="Jobbra"
                >
                  <lucide-icon [name]="ICONS.ALIGN_RIGHT" [size]="16" />
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- ============ Debug tab ============ -->
    @if (activeTab() === 'debug') {
      <div class="tab-content" role="tabpanel">
        <div class="debug-actions">
          <button
            class="btn btn--primary"
            [disabled]="generating() || !selectedSize()"
            (click)="generatePsdDebug()"
          >
            @if (generating()) {
              <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
              Futtatás...
            } @else {
              <lucide-icon [name]="ICONS.BUG" [size]="16" />
              Debug futtatás
            }
          </button>
          <button
            class="btn btn--outline"
            [disabled]="debugLogs().length === 0"
            (click)="clearDebugLogs()"
          >
            <lucide-icon [name]="ICONS.DELETE" [size]="16" />
            Törlés
          </button>
        </div>

        @if (debugLogs().length === 0) {
          <div class="debug-empty">
            <lucide-icon [name]="ICONS.BUG" [size]="24" />
            <p>Nyomd meg a "Debug futtatás" gombot a PSD generálás diagnosztikájához.</p>
          </div>
        } @else {
          <div class="debug-log-list">
            @for (log of debugLogs(); track $index) {
              <div class="debug-log-entry" [class]="'debug-log-entry--' + log.status">
                <span class="debug-log-entry__time">{{ log.time }}</span>
                <span class="debug-log-entry__status">
                  @switch (log.status) {
                    @case ('ok') { <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="14" /> }
                    @case ('warn') { <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="14" /> }
                    @case ('error') { <lucide-icon [name]="ICONS.X_CIRCLE" [size]="14" /> }
                    @case ('info') { <lucide-icon [name]="ICONS.INFO" [size]="14" /> }
                  }
                </span>
                <span class="debug-log-entry__step">{{ log.step }}</span>
                <span class="debug-log-entry__detail">{{ log.detail }}</span>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Üzenetek -->
    @if (error()) {
      <div class="message message--error">
        <lucide-icon [name]="ICONS.X_CIRCLE" [size]="16" />
        {{ error() }}
      </div>
    }

    @if (successMessage()) {
      <div class="message message--success">
        <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="16" />
        {{ successMessage() }}
      </div>
    }
  } @else {
    <div class="text-center py-16">
      <div class="w-16 h-16 mx-auto mb-3 bg-red-100 rounded-full flex items-center justify-center">
        <lucide-icon [name]="ICONS.X_CIRCLE" [size]="32" class="text-red-500" />
      </div>
      <h3 class="mt-3 text-lg font-medium text-gray-900">Projekt nem található</h3>
      <div class="mt-4">
        <button
          class="px-4 py-2 text-primary hover:bg-primary-50 text-sm font-medium rounded-lg transition-colors"
          (click)="goBack()"
        >
          Vissza
        </button>
      </div>
    </div>
  }
</div>

<!-- Pillanatkép frissítés választó dialógus (page-card KÍVÜL) -->
@if (snapshotService.showUpdatePicker()) {
  <app-dialog-wrapper
    headerStyle="flat"
    theme="purple"
    [icon]="ICONS.SAVE"
    title="Melyik pillanatképet frissítsem?"
    description="Válaszd ki, melyik pillanatképet szeretnéd felülírni az aktuális elrendezéssel."
    size="sm"
    [isSubmitting]="snapshotService.updatingSnapshot()"
    (closeEvent)="snapshotService.closeUpdatePicker()"
  >
    <div dialogBody>
      <div class="snapshot-picker-list">
        @for (snap of snapshotService.snapshots(); track snap.fileName) {
          <button
            class="snapshot-picker-item"
            [disabled]="snapshotService.updatingSnapshot()"
            (click)="updateSnapshotWithPick(snap)"
          >
            <div class="snapshot-picker-item__info">
              <span class="snapshot-picker-item__name">{{ snap.snapshotName }}</span>
              <span class="snapshot-picker-item__meta">
                {{ snapshotService.formatDate(snap.createdAt) }}
                · {{ snap.personCount }} layer
              </span>
            </div>
            @if (snapshotService.updatingSnapshot()) {
              <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
            } @else {
              <lucide-icon [name]="ICONS.SAVE" [size]="16" />
            }
          </button>
        }
      </div>
    </div>

    <div dialogFooter >
      <button class="btn btn--outline" (click)="snapshotService.closeUpdatePicker()">
        Mégse
      </button>
    </div>
  </app-dialog-wrapper>
}

<!-- Pillanatkép mentés dialógus (page-card KÍVÜL) -->
@if (snapshotService.showSaveDialog()) {
  <app-dialog-wrapper
    headerStyle="flat"
    theme="purple"
    [icon]="ICONS.SAVE"
    title="Új pillanatkép"
    description="Add meg a pillanatkép nevét. Az aktuális Photoshop elrendezés kerül mentésre."
    size="sm"
    variant="create"
    [isSubmitting]="snapshotService.savingSnapshot()"
    (closeEvent)="snapshotService.closeSaveDialog()"
    (submitEvent)="snapshotService.snapshotName().trim() ? saveSnapshotFromDialog() : null"
  >
    <div dialogBody>
      <input
        type="text"
        class="snapshot-dialog__input"
        placeholder="pl. Első tervezet"
        [value]="snapshotService.snapshotName()"
        (input)="snapshotService.snapshotName.set($any($event.target).value)"
      />
    </div>

    <div dialogFooter >
      <button class="btn btn--outline" (click)="snapshotService.closeSaveDialog()">
        Mégse
      </button>
      <button
        class="btn btn--primary"
        [disabled]="!snapshotService.snapshotName().trim() || snapshotService.savingSnapshot()"
        (click)="saveSnapshotFromDialog()"
      >
        @if (snapshotService.savingSnapshot()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
          Mentés...
        } @else {
          <lucide-icon [name]="ICONS.SAVE" [size]="16" />
          Mentés
        }
      </button>
    </div>
  </app-dialog-wrapper>
}

<!-- Visszaállítás csoport-választó dialógus (page-card KÍVÜL) -->
@if (snapshotService.showRestoreDialog()) {
  <app-snapshot-restore-dialog
    [layers]="snapshotService.restoreDialogLayers()"
    [isRestoring]="snapshotService.restoringSnapshotPath() !== null"
    (closeEvent)="snapshotService.closeRestoreDialog()"
    (restoreEvent)="restoreWithGroups($event)"
  />
}

<!-- Sablon mentés dialógus (page-card KÍVÜL) -->
@if (templateService.showSaveDialog()) {
  <app-template-save-dialog
    [name]="templateService.templateName()"
    [isSaving]="templateService.savingTemplate()"
    (nameChange)="templateService.templateName.set($event)"
    (closeEvent)="templateService.closeSaveDialog()"
    (submitEvent)="saveTemplateFromDialog()"
  />
}

<!-- Vizuális szerkesztő (page-card KÍVÜL) -->
@if (showLayoutDesigner() && designerSnapshotPath() && designerPsdPath() && designerBoardConfig()) {
  <app-layout-designer
    [snapshotPath]="designerSnapshotPath()!"
    [psdPath]="designerPsdPath()!"
    [persons]="persons()"
    [boardConfig]="designerBoardConfig()!"
    (closeEvent)="closeLayoutDesigner()"
    (saveEvent)="onDesignerSave($event)"
  />
}

<!-- Sablon alkalmazás dialógus (page-card KÍVÜL) -->
@if (templateService.showApplyDialog()) {
  <app-template-apply-dialog
    [templates]="templateService.templates()"
    [isLoading]="templateService.loadingTemplates()"
    [isApplying]="templateService.applyingTemplate()"
    [currentPersonCount]="currentStudentCount"
    [editingId]="templateService.editingTemplateId()"
    [editingNameValue]="templateService.editingName()"
    (closeEvent)="templateService.closeApplyDialog()"
    (applyEvent)="applyTemplate($event)"
    (deleteTemplate)="deleteTemplate($event)"
    (startRename)="templateService.startEditing($event)"
    (commitRename)="commitTemplateRename()"
    (cancelRename)="templateService.cancelEditing()"
    (editingNameChange)="templateService.editingName.set($event)"
  />
}
