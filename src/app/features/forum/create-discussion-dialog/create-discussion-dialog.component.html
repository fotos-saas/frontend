<app-dialog-wrapper
  [variant]="mode() === 'edit' ? 'edit' : 'create'"
  headerStyle="hero"
  theme="purple"
  [icon]="ICONS.MESSAGE_CIRCLE"
  [title]="mode() === 'edit' ? 'Téma szerkesztése' : 'Új beszélgetés indítása'"
  [description]="mode() === 'edit' ? 'Módosítsd a téma címét és tartalmát.' : 'Indíts új témát az osztály fórumán. A beszélgetésben mindenki részt vehet.'"
  size="lg"
  [isSubmitting]="_isSubmitting()"
  [errorMessage]="_errorMessage()"
  (closeEvent)="close()"
>
  <!-- Body -->
  <ng-container dialogBody>
    <!-- Title field -->
    <div class="dialog__field">
      <label class="dialog__label" for="discussion-title">
        Téma címe <span class="dialog__required">*</span>
      </label>
      <input
        #titleInput
        type="text"
        id="discussion-title"
        class="dialog__input"
        [class.dialog__input--error]="errors.title"
        [(ngModel)]="title"
        (ngModelChange)="onInputChange()"
        placeholder="Pl.: Osztálykirándulás ötletek"
        [disabled]="_isSubmitting()"
        maxlength="255"
        autocomplete="off"
      />
      <div class="dialog__field-footer">
        @if (errors.title) {
          <span class="dialog__error">{{ errors.title }}</span>
        } @else {
          <span class="dialog__char-count">{{ titleCharCount() }}</span>
        }
      </div>
    </div>

    <!-- Content field -->
    <div class="dialog__field">
      <label class="dialog__label" for="discussion-content">
        Tartalom <span class="dialog__required">*</span>
      </label>

      <!-- Rich Text Editor -->
      @if (useRichEditor()) {
        <app-rich-text-editor
          [(ngModel)]="content"
          name="richContent"
          mode="standard"
          placeholder="Írd le részletesen, miről szól a téma..."
          [disabled]="_isSubmitting()"
          [minHeight]="150"
          [maxHeight]="300"
          (textLengthChangeEvent)="onContentTextLengthChange($event)"
        />
      } @else {
        <!-- Simple Textarea fallback -->
        <textarea
          id="discussion-content"
          class="dialog__textarea"
          [class.dialog__textarea--error]="errors.content"
          [(ngModel)]="content"
          (ngModelChange)="onInputChange()"
          placeholder="Írd le részletesen, miről szól a téma..."
          [disabled]="_isSubmitting()"
          maxlength="10000"
          rows="5"
        ></textarea>
      }

      <div class="dialog__field-footer">
        @if (errors.content) {
          <span class="dialog__error">{{ errors.content }}</span>
        } @else if (!useRichEditor()) {
          <span class="dialog__char-count">{{ contentCharCount() }}</span>
        } @else {
          <span class="dialog__char-count">{{ contentTextLength }} karakter</span>
        }
      </div>
    </div>

    <!-- Media Editor (edit módban) -->
    @if (mode() === 'edit' && editData()) {
      <div class="dialog__field">
        <label class="dialog__label">
          Képek <span class="dialog__optional">(opcionális)</span>
        </label>
        <app-media-editor
          [existingMedia]="existingMediaItems()"
          [maxFiles]="3"
          [maxSizeMB]="5"
          [acceptedTypes]="'image/jpeg,image/png,image/gif,image/webp'"
          [disabled]="_isSubmitting()"
          existingLabel="Meglévő képek"
          newLabel="Új képek hozzáadása"
          (newFilesChange)="onNewFilesChange($event)"
          (mediaToDeleteChange)="onMediaToDeleteChange($event)"
          (error)="onMediaError($event)"
        />
      </div>
    }

    <!-- Template selector (opcionális, csak create módban) -->
    @if (templates().length > 0 && mode() === 'create') {
      <div class="dialog__field">
        <label class="dialog__label" for="discussion-template">
          Kapcsolódó sablon <span class="dialog__optional">(opcionális)</span>
        </label>
        <select
          id="discussion-template"
          class="dialog__select"
          [(ngModel)]="templateId"
          (ngModelChange)="onInputChange()"
          [disabled]="_isSubmitting()"
        >
          <option [ngValue]="null">— Nincs kapcsolódó sablon —</option>
          @for (template of templates(); track template.id) {
            <option [ngValue]="template.id">
              {{ template.name }}
            </option>
          }
        </select>
        <span class="dialog__hint">
          Ha a téma egy konkrét sablonhoz kapcsolódik, válaszd ki itt.
        </span>
      </div>
    }
  </ng-container>

  <!-- Footer -->
  <ng-container dialogFooter>
    <button
      type="button"
      class="btn btn--secondary"
      (click)="close()"
      [disabled]="_isSubmitting()"
    >
      Mégse
    </button>

    <button
      type="button"
      class="btn btn--purple"
      (click)="submit()"
      [disabled]="!isFormValid() || _isSubmitting()"
    >
      @if (_isSubmitting()) {
        <lucide-icon [name]="ICONS.LOADER" [size]="18" class="spin" />
      }
      <lucide-icon [name]="ICONS.SEND" [size]="18" />
      {{ _isSubmitting() ? (mode() === 'edit' ? 'Mentés...' : 'Létrehozás...') : (mode() === 'edit' ? 'Mentés' : 'Téma létrehozása') }}
    </button>
  </ng-container>
</app-dialog-wrapper>
