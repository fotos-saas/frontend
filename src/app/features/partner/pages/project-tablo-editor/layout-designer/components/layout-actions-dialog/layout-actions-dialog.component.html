<div class="dialog-backdrop"
  (mousedown)="backdropHandler.onMouseDown($event)"
  (click)="backdropHandler.onClick($event)">
  <div class="dialog-panel">
    <!-- Header -->
    <div class="dialog__header">
      <lucide-icon [name]="ICONS.WAND" [size]="18" />
      <h3 class="dialog__title">Akciok</h3>
      <button class="dialog__close" (click)="close.emit()">
        <lucide-icon [name]="ICONS.X" [size]="16" />
      </button>
    </div>

    <!-- Body -->
    <div class="dialog__body">

      <!-- Muvelet valaszto -->
      <div class="dialog__field">
        <label class="dialog__label">Muvelet</label>
        <ps-select
          [options]="actionOptions"
          [ngModel]="selectedAction()"
          (ngModelChange)="selectedAction.set($event)"
        />
      </div>

      <!-- Szemelyek kivalasztasa — CSAK upload-to-everyone modban -->
      @if (selectedAction() !== 'upload-individual') {
        <div class="dialog__field">
          <label class="dialog__label">
            Szemelyek ({{ selectedCount() }}/{{ persons().length }})
          </label>
          <div class="person-columns">
            <!-- Diakok -->
            @if (students().length > 0) {
              <div class="person-group">
                <div class="person-group__header">
                  <span class="person-group__title">
                    <lucide-icon [name]="ICONS.USERS" [size]="12" />
                    Diakok ({{ students().length }})
                  </span>
                  <button class="person-group__toggle" (click)="toggleAllStudents()">
                    {{ allStudentsSelected() ? 'Nincs' : 'Mind' }}
                  </button>
                </div>
                <div class="person-group__list">
                  @for (p of students(); track p.id) {
                    <label class="person-item" [class.person-item--selected]="isSelected(p.id)">
                      <span class="person-item__check">
                        @if (isSelected(p.id)) {
                          <lucide-icon [name]="ICONS.CHECK" [size]="12" />
                        }
                      </span>
                      <span class="person-item__name">{{ p.name }}</span>
                      <input type="checkbox" class="sr-only"
                        [checked]="isSelected(p.id)"
                        (change)="togglePerson(p.id)" />
                    </label>
                  }
                </div>
              </div>
            }

            <!-- Tanarok -->
            @if (teachers().length > 0) {
              <div class="person-group">
                <div class="person-group__header">
                  <span class="person-group__title">
                    <lucide-icon [name]="ICONS.USER" [size]="12" />
                    Tanarok ({{ teachers().length }})
                  </span>
                  <button class="person-group__toggle" (click)="toggleAllTeachers()">
                    {{ allTeachersSelected() ? 'Nincs' : 'Mind' }}
                  </button>
                </div>
                <div class="person-group__list">
                  @for (p of teachers(); track p.id) {
                    <label class="person-item" [class.person-item--selected]="isSelected(p.id)">
                      <span class="person-item__check">
                        @if (isSelected(p.id)) {
                          <lucide-icon [name]="ICONS.CHECK" [size]="12" />
                        }
                      </span>
                      <span class="person-item__name">{{ p.name }}</span>
                      <input type="checkbox" class="sr-only"
                        [checked]="isSelected(p.id)"
                        (change)="togglePerson(p.id)" />
                    </label>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Akcio-specifikus form -->
      @switch (selectedAction()) {
        @case ('upload-to-everyone') {
          <app-upload-to-everyone-form #uploadForm />
        }
        @case ('upload-individual') {
          <app-upload-individual-form #individualForm [persons]="persons()" />
        }
      }

      <!-- Hiba uzenet -->
      @if (errorMessage(); as err) {
        <div class="dialog__error">
          <lucide-icon [name]="ICONS.X_CIRCLE" [size]="14" />
          {{ err }}
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="dialog__footer">
      <button class="dialog__btn dialog__btn--ghost" (click)="close.emit()">
        Megse
      </button>
      <button
        class="dialog__btn dialog__btn--primary"
        [disabled]="!canExecute()"
        (click)="onExecute()">
        @if (executing()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="14" class="spin" />
          Vegrehajtás...
        } @else {
          <lucide-icon [name]="ICONS.PLAY" [size]="14" />
          Vegrehajtas
        }
      </button>
    </div>
  </div>
</div>
