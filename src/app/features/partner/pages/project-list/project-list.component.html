<div class="project-list-page page-card page-card--wide">
  <header class="page-header">
    <div class="header-content">
      <h1>Projektek</h1>
      <p class="subtitle">
        Összes projekt: {{ projectLimits()?.current ?? totalProjects() }}@if (projectLimits()?.max !== null) { / {{ projectLimits()?.max }}}@if (totalProjects() !== (projectLimits()?.current ?? totalProjects())) {
          <span class="subtitle-filtered">(szűrve: {{ totalProjects() }})</span>
        }
      </p>
    </div>
    <div class="header-actions">
      @if (isDevPartner()) {
        <button
          type="button"
          class="btn-secondary btn-with-badge"
          [disabled]="syncing()"
          (click)="triggerSync()"
          [matTooltip]="pendingSyncCount() !== null && pendingSyncCount()! > 0
            ? pendingSyncCount() + ' új projekt szinkronizálható'
            : 'Megrendeléses projektek szinkronizálása a régi rendszerből'"
        >
          @if (syncing()) {
            <lucide-icon [name]="ICONS.LOADER" [size]="18" class="spin" />
          } @else {
            <lucide-icon [name]="ICONS.REFRESH" [size]="18" />
          }
          @if (pendingSyncCount() !== null && pendingSyncCount()! > 0) {
            Szinkronizálás indítása
            <span class="btn-badge">{{ pendingSyncCount() }}</span>
          } @else {
            Szinkronizálás
          }
        </button>
        <button
          type="button"
          class="btn-secondary btn-with-badge"
          (click)="openCreatePreliminaryModal()"
        >
          <lucide-icon [name]="ICONS.CLOCK" [size]="18" />
          Új előzetes
          @if (projectLimits()?.preliminary_count) {
            <span class="btn-badge">{{ projectLimits()!.preliminary_count }}</span>
          }
        </button>
      }
      <button
        type="button"
        class="btn-primary"
        [disabled]="projectLimits() && !projectLimits()!.can_create"
        [matTooltip]="projectLimits() && !projectLimits()!.can_create ? 'Elérted a csomagodban elérhető maximum projektszámot' : ''"
        (click)="openCreateModal()"
      >
        <lucide-icon [name]="ICONS.PLUS" [size]="18" />
        Új projekt
      </button>
    </div>
  </header>

  <!-- Keresés, szűrők és mobil rendezés -->
  <app-smart-filter-bar
    [filterState]="filterState"
    [searchConfig]="searchConfig"
    [filterConfigs]="filterConfigs()"
    [visibleFilterCount]="2"
    [sortConfig]="sortDef"
  >
    <button
      filterBarExtra
      type="button"
      class="sort-toggle-btn"
      [class.sort-toggle-btn--active]="filterState.sortBy() === 'last_content_update'"
      (click)="toggleContentSort()"
      [matTooltip]="filterState.sortBy() === 'last_content_update' ? 'Rendezés: legújabb fotó feltöltés' : 'Rendezés legújabb fotó feltöltés szerint'"
    >
      <lucide-icon [name]="ICONS.ARROW_UP_DOWN" [size]="16" />
      Legújabb fotó
    </button>
    <button
      filterBarExtra
      type="button"
      class="sort-toggle-btn"
      [class.sort-toggle-btn--active]="filterState.sortBy() === 'order_submitted_at'"
      (click)="toggleOrderSort()"
      [matTooltip]="filterState.sortBy() === 'order_submitted_at' ? 'Rendezés: leadás dátuma' : 'Rendezés leadás dátuma szerint'"
    >
      <lucide-icon [name]="ICONS.ARROW_UP_DOWN" [size]="16" />
      Leadva
    </button>
    <button
      filterBarExtra
      type="button"
      class="sort-toggle-btn"
      [class.sort-toggle-btn--active]="filterState.sortBy() === 'last_activity_at'"
      (click)="toggleActivitySort()"
      [matTooltip]="filterState.sortBy() === 'last_activity_at' ? 'Rendezés: utolsó módosítás' : 'Rendezés utolsó módosítás szerint'"
    >
      <lucide-icon [name]="ICONS.ARROW_UP_DOWN" [size]="16" />
      Módosítva
    </button>
  </app-smart-filter-bar>

  <!-- Lista -->
  @if (filterState.loading()) {
    <div class="loading-state">
      @for (i of [1, 2, 3, 4, 5, 6]; track i) {
        <div class="skeleton-card skeleton-shimmer"></div>
      }
    </div>
  } @else if (projects().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">
        <lucide-icon [name]="ICONS.FOLDER_OPEN" [size]="48" />
      </div>
      <h3>Nincs találat</h3>
      @if (filterState.search()) {
        <p>Próbálj más keresési feltételekkel!</p>
      } @else {
        <p>Még nincsenek projektek. Hozz létre egyet!</p>
        <button type="button" class="btn-primary mt-4" (click)="openCreateModal()">
          <lucide-icon [name]="ICONS.PLUS" [size]="18" />
          Új projekt létrehozása
        </button>
      }
    </div>
  } @else {
    <div [style.--table-cols]="gridTemplate">
    <!-- Asztali fejléc -->
    <app-table-header
      [columns]="tableCols"
      [sortBy]="filterState.sortBy()"
      [sortDir]="filterState.sortDir()"
      (sortChange)="filterState.setSortBy($event)"
    />

    <!-- Projekt sorok -->
    <div class="project-grid">
      @for (project of projects(); track project.id; let i = $index) {
        <app-partner-project-card
          [project]="project"
          [selected]="selectedProjectIds().has(project.id)"
          [style.animation-delay]="i * 0.05 + 's'"
          (cardClick)="onCardSelect($event.project, $event.event, i)"
          (samplesClick)="openSamplesModal($event)"
          (missingClick)="openMissingModal($event)"
          (qrClick)="openQrModal($event)"
          (awareClick)="toggleAware($event)"
          (photosUploadedClick)="togglePhotosUploaded($event)"
          (orderDataClick)="openOrderDataDialog($event)"
          (linkClick)="openLinkDialog($event)"
          (deleteClick)="confirmDeleteProject($event)"
          (statusChangeClick)="onStatusChange($event)"
        />
      }
    </div>
    </div>

    <!-- Paginálás -->
    <app-list-pagination
      [currentPage]="filterState.page()"
      [totalPages]="totalPages()"
      [totalItems]="totalProjects()"
      itemLabel="projekt"
      (pageChange)="filterState.setPage($event)"
    />
  }
</div>

<!-- Bulk akció sáv (multi-select) -->
@if (selectedProjectIds().size > 0) {
  <div class="bulk-action-bar">
    <div class="bulk-action-bar__info">
      <lucide-icon [name]="ICONS.CHECK" [size]="16" />
      <span>{{ selectedProjectIds().size }} projekt kijelölve</span>
    </div>
    @if (isElectron) {
      <div class="bulk-action-bar__actions">
        @if (canBulkGeneratePsd()) {
          <button type="button" class="bulk-btn" (click)="addSelectedToBatch('generate-psd')">
            PSD generálás
          </button>
        }
        @if (canBulkGenerateSample()) {
          <button type="button" class="bulk-btn" (click)="addSelectedToBatch('generate-sample')">
            Minta
          </button>
        }
        @if (canBulkFinalize()) {
          <button type="button" class="bulk-btn" (click)="addSelectedToBatch('finalize')">
            Végl.
          </button>
        }
      </div>
    }
    <button type="button" class="bulk-action-bar__close" (click)="clearSelection()">
      <lucide-icon [name]="ICONS.X" [size]="16" />
    </button>
  </div>
}

<!-- Samples Lightbox -->
@if (samplesLightboxIndex() !== null) {
  <app-samples-lightbox
    [samples]="lightboxSamples()"
    [currentIndex]="samplesLightboxIndex()!"
    (close)="closeSamplesLightbox()"
    (navigate)="samplesLightboxIndex.set($event)"
  />
}

<!-- Persons Modal -->
@if (showMissingModal()) {
  <app-persons-modal
    [projectId]="selectedProject()!.id"
    [projectName]="selectedProject()!.name"
    (close)="closeMissingModal()"
    (openUploadWizard)="openUploadWizardFromMissing($event)"
  />
}

<!-- Photo Upload Wizard -->
@if (showUploadWizard()) {
  <app-photo-upload-wizard
    [projectId]="selectedProject()!.id"
    [projectName]="selectedProject()!.name"
    [initialAlbum]="uploadWizardAlbum()"
    (close)="closeUploadWizard()"
    (completed)="onUploadWizardCompleted($event)"
  />
}

<!-- Create Project Modal -->
@if (showCreateModal()) {
  <app-create-project-modal
    (close)="closeCreateModal()"
    (projectCreated)="onProjectCreated($event)"
  />
}

<!-- QR Code Modal -->
@if (showQrModal()) {
  <app-shared-qr-code-modal
    [projectId]="selectedProject()!.id"
    [projectName]="selectedProject()!.name"
    [qrService]="qrService"
    (close)="closeQrModal()"
    (qrCodeChanged)="onQrCodeChanged()"
  />
}

<!-- Order Data Dialog Container -->
<ng-container #orderDataContainer></ng-container>

<!-- Delete Project Confirmation -->
@if (showDeleteConfirm()) {
  <app-confirm-dialog
    title="Projekt törlése"
    [message]="'Biztosan törölni szeretnéd a \'' + deletingProjectName() + '\' projektet? Ez a művelet nem visszavonható, minden adat (képek, galéria, fórum) véglegesen törlődik!'"
    confirmText="Végleges törlés"
    [isSubmitting]="isDeleting()"
    (resultEvent)="onDeleteResult($event)"
  />
}

<!-- Create Preliminary Modal -->
@if (showCreatePreliminaryModal()) {
  <app-create-preliminary-modal
    (close)="closeCreatePreliminaryModal()"
    (created)="onPreliminaryCreated()"
  />
}

<!-- Link Preliminary Dialog -->
@if (showLinkDialog() && linkingProject()) {
  <app-link-preliminary-dialog
    [project]="linkingProject()!"
    (close)="closeLinkDialog()"
    (linked)="onPreliminaryLinked()"
  />
}
