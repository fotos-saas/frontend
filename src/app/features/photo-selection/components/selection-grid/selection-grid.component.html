<!-- Header with selection info -->
@if (showHeader()) {
<div class="selection-grid__header">
  <div class="selection-grid__count">
    <span class="selection-grid__count-current">{{ selectedIds().length }}</span>
    @if (maxSelection()) {
      <span class="selection-grid__count-max"> / {{ maxSelection() }}</span>
    }
    <span class="selection-grid__count-label"> kiválasztva</span>
    <span class="selection-grid__count-total">({{ photos().length }} képből)</span>

    <!-- Auto-save status indicator -->
    @if (isSaving()) {
      <span class="selection-grid__save-status selection-grid__save-status--saving" role="status" aria-live="polite" aria-atomic="true">
        <span class="selection-grid__save-spinner"></span>
        Mentés...
      </span>
    } @else if (saveSuccess()) {
      <span class="selection-grid__save-status selection-grid__save-status--success" role="status" aria-live="polite" aria-atomic="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Mentve
      </span>
    }
  </div>

  @if (allowMultiple() && photos().length > 0 && !readonly()) {
    <div class="selection-grid__actions">
      @if (selectedIds().length < photos().length && !isMaxReached()) {
        <button
          type="button"
          class="selection-grid__action-btn"
          (click)="onSelectAll()"
        >
          Összes kijelölése
        </button>
      }
      @if (selectedIds().length > 0) {
        <button
          type="button"
          class="selection-grid__action-btn selection-grid__action-btn--secondary"
          (click)="onDeselectAll()"
        >
          Kijelölés törlése
        </button>
      }
    </div>
  }
</div>
}

<!-- US-008: Virtual Scroll vagy Pagination mód -->
@if (photos().length > 0 && !isLoading()) {
  @if (useVirtualScroll()) {
    <!-- Virtual Scroll Photo Grid (eredeti implementáció) -->
    <cdk-virtual-scroll-viewport
      class="selection-grid__viewport"
      [itemSize]="rowHeight()"
      [minBufferPx]="minBufferPx()"
      [maxBufferPx]="maxBufferPx()"
      [style.--grid-columns]="columnsCount()"
      role="listbox"
      [attr.aria-multiselectable]="allowMultiple()"
      [attr.aria-label]="'Képek kiválasztása. ' + photos().length + ' kép elérhető.'"
    >
      <div
        *cdkVirtualFor="let row of photoRows(); trackBy: trackRow"
        class="selection-grid__row"
      >
        @for (photo of row.photos; track photo.id; let localIdx = $index) {
          <ng-container *ngTemplateOutlet="photoItemTemplate; context: { $implicit: photo, index: row.startIndex + localIdx }" />
        }
      </div>
    </cdk-virtual-scroll-viewport>
  } @else {
    <!-- US-008: Pagination mód (fallback) -->
    <div
      class="selection-grid__pagination-container"
      role="listbox"
      [attr.aria-multiselectable]="allowMultiple()"
      [attr.aria-label]="'Képek kiválasztása. ' + photos().length + ' / ' + totalCount() + ' kép betöltve.'"
    >
      <div class="selection-grid__pagination-grid" [style.--grid-columns]="columnsCount()">
        @for (photo of photos(); track photo.id; let idx = $index) {
          <ng-container *ngTemplateOutlet="photoItemTemplate; context: { $implicit: photo, index: idx }" />
        }
      </div>

      <!-- "Több kép betöltése" gomb -->
      <app-load-more-button
        [loadedCount]="photos().length"
        [totalCount]="totalCount()"
        [isLoading]="isLoadingMore()"
        (loadMore)="onLoadMore()"
      />
    </div>
  }
}

<!-- Közös photo item template (DRY) -->
<ng-template #photoItemTemplate let-photo let-index="index">
  <div
    class="selection-grid__item"
    [class.selection-grid__item--selected]="isSelected(photo.id)"
    [class.selection-grid__item--disabled]="isDisabled(photo.id)"
    [class.selection-grid__item--readonly]="readonly()"
    [class.selection-grid__item--delete-mode]="deleteMode()"
    [class.selection-grid__item--delete-selected]="deleteMode() && isDeleteSelected(photo.id)"
    role="option"
    [attr.aria-selected]="isSelected(photo.id)"
    [attr.aria-disabled]="readonly() ? null : isDisabled(photo.id)"
    [tabindex]="0"
    (click)="onPhotoClick(photo, $event, index)"
    (keydown.enter)="onPhotoClick(photo, $event, index)"
    (keydown.space)="onPhotoClick(photo, $event, index); $event.preventDefault()"
  >
    <!-- Thumbnail image with explicit dimensions for CLS prevention -->
    <div class="selection-grid__image-container">
      <!-- US-005: Skeleton shimmer placeholder amíg kép töltődik -->
      <div
        class="selection-grid__image-skeleton skeleton-shimmer"
        [class.selection-grid__image-skeleton--hidden]="isImageLoaded(photo.id)"
        aria-hidden="true"
      ></div>

      <img
        [src]="photo.thumbnailUrl"
        [alt]="photo.filename"
        class="selection-grid__image"
        [class.selection-grid__image--loaded]="isImageLoaded(photo.id)"
        loading="lazy"
        decoding="async"
        width="300"
        height="300"
        (load)="onImageLoad(photo.id)"
        (error)="onImageError($event, photo.id)"
      />

      <!-- Selection overlay -->
      <div class="selection-grid__overlay">
        @if (isSelected(photo.id) && !deleteMode()) {
          <div class="selection-grid__check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" aria-hidden="true">
              <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        }
      </div>

      <!-- Delete button (overlay-en KÍVÜL, hogy kattintható legyen) -->
      @if (deleteMode()) {
        <button
          type="button"
          class="selection-grid__delete-btn"
          [class.selection-grid__delete-btn--selected]="isDeleteSelected(photo.id)"
          [attr.aria-label]="'Törlésre jelölés: ' + photo.filename"
          (click)="onDeleteBtnClick(photo, $event)"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      }

      <!-- Zoom button -->
      <button
        type="button"
        class="selection-grid__zoom"
        [attr.aria-label]="'Nagyítás: ' + photo.filename"
        (click)="onZoomClick(photo, index, $event)"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/>
        </svg>
      </button>
    </div>

    <!-- Selection indicator for single select -->
    @if (!allowMultiple()) {
      <div class="selection-grid__radio">
        <div
          class="selection-grid__radio-circle"
          [class.selection-grid__radio-circle--selected]="isSelected(photo.id)"
        >
          @if (isSelected(photo.id)) {
            <div class="selection-grid__radio-dot"></div>
          }
        </div>
      </div>
    }
  </div>
</ng-template>

<!-- Empty state - csak ha tényleg üres ÉS már betöltődött ÉS inicializálva van -->
@if (photos().length === 0 && !isLoading() && isInitialized()) {
  <div class="selection-grid__empty">
    <div class="selection-grid__empty-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M21 15l-5-5L5 21"/>
      </svg>
    </div>
    <p class="selection-grid__empty-text">{{ emptyMessage() }}</p>
    @if (emptyDescription()) {
      <p class="selection-grid__empty-description">{{ emptyDescription() }}</p>
    }
  </div>
}

<!-- Loading skeleton - same grid layout as actual photos for zero CLS -->
@if (isLoading()) {
  <div class="selection-grid__skeleton" [style.--skeleton-columns]="columnsCount()" aria-hidden="true">
    @for (i of skeletonItems(); track i) {
      <div class="selection-grid__skeleton-item skeleton-shimmer"></div>
    }
  </div>
}
