<div class="global-settings page-card">
  <div class="page-header">
    <lucide-icon [name]="ICONS.SETTINGS" [size]="24" />
    <h1>Beállítások</h1>
  </div>
  <p class="page-description">
    Az itt megadott értékek alapértelmezésként érvényesülnek minden projektedre.
    Egyedi felülírás a projekt Beállítások fülén lehetséges.
  </p>

  @if (loading()) {
    <div class="flex items-center justify-center py-16">
      <div class="w-8 h-8 border-3 border-gray-200 border-t-primary rounded-full animate-spin"></div>
    </div>
  } @else {
    <div class="settings-section">
      <div class="section-title">
        <lucide-icon [name]="ICONS.IMAGE" [size]="18" />
        <h2>Képválasztás</h2>
      </div>

      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">Retusálható képek száma</span>
            <span class="setting-description">
              Hány képet választhat ki egy diák retusálásra alapértelmezetten.
              Ez az érték érvényes minden projektre, ahol nincs egyedi beállítás.
            </span>
          </div>
          <div class="setting-control">
            <ps-input
              type="number"
              size="sm"
              suffix="kép"
              min="1"
              max="20"
              [ngModel]="maxRetouchPhotos()"
              (ngModelChange)="maxRetouchPhotos.set($event)"
            />
          </div>
        </div>
      </div>

      <!-- Módosítás díjszabás -->
      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">Fizetős módosítás</span>
            <span class="setting-description">
              Ha aktív, az ingyenes időablak lejárta után a diák módosításai díjkötelesek lesznek.
              Ha inaktív, a módosítás örökké ingyenes marad.
            </span>
          </div>
          <div class="setting-control">
            <ps-toggle
              [label]="billingEnabled() ? 'Aktív' : 'Inaktív'"
              [ngModel]="billingEnabled()"
              (ngModelChange)="billingEnabled.set($event)"
            />
          </div>
        </div>

        <!-- Ingyenes módosítási időablak (csak ha billing aktív) -->
        @if (billingEnabled()) {
          <div class="sub-setting">
            <div class="setting-row">
              <div class="setting-info">
                <span class="setting-label setting-label--sub">Ingyenes módosítási időablak</span>
                <span class="setting-description">
                  Mennyi ideig módosíthat a diák díjmentesen a véglegesítés után.
                  0 = nincs ingyenes időablak, azonnal fizetős.
                </span>
              </div>
              <div class="setting-control">
                <ps-input
                  type="number"
                  size="sm"
                  suffix="óra"
                  min="0"
                  max="168"
                  [ngModel]="freeEditWindowHours()"
                  (ngModelChange)="freeEditWindowHours.set($event)"
                />
              </div>
            </div>
          </div>
        }
      </div>

    </div>

    <!-- Elérhető tablóméretek szekció -->
    <div class="settings-section">
      <div class="section-title">
        <lucide-icon [name]="ICONS.RULER" [size]="18" />
        <h2>Elérhető tablóméretek</h2>
      </div>

      @if (sizesLoading()) {
        <div class="setting-card">
          <div class="flex items-center justify-center py-8">
            <div class="w-6 h-6 border-2 border-gray-200 border-t-primary rounded-full animate-spin"></div>
          </div>
        </div>
      } @else {
        <div class="setting-card">
          <div class="setting-info" style="margin-bottom: 12px">
            <span class="setting-description">
              A véglegesítésnél ezek közül a méretek közül lehet választani.
              @if (sizesIsDefault()) {
                Jelenleg az alapértelmezett méretek vannak beállítva.
              }
            </span>
          </div>

          <!-- Méretek listája -->
          <div class="sizes-list">
            @for (size of tabloSizes(); track size.value; let i = $index) {
              <div class="size-item">
                <span class="size-label">{{ size.label }}</span>
                <span class="size-value">{{ size.value }}</span>
                @if (isDefaultSize(size)) {
                  <span class="size-badge">alap</span>
                }
                <button
                  type="button"
                  class="size-remove"
                  (click)="removeSize(i)"
                >
                  <lucide-icon [name]="ICONS.X" [size]="12" />
                </button>
              </div>
            }
          </div>

          @if (tabloSizes().length === 0) {
            <p class="no-sizes-text">Nincs méret megadva. Adj hozzá legalább egyet, vagy állítsd vissza az alapértelmezéseket.</p>
          }

          <!-- Egyedi méret hozzáadása -->
          <div class="add-size-row">
            <ps-input
              size="sm"
              placeholder="Megnevezés (pl. 60×90 cm)"
              [ngModel]="newSizeLabel()"
              (ngModelChange)="newSizeLabel.set($event)"
            />
            <ps-input
              size="sm"
              placeholder="Érték (pl. 60x90)"
              [ngModel]="newSizeValue()"
              (ngModelChange)="newSizeValue.set($event)"
            />
            <button
              type="button"
              class="add-size-btn"
              (click)="addCustomSize()"
            >
              <lucide-icon [name]="ICONS.PLUS" [size]="14" />
              Hozzáadás
            </button>
          </div>

          <!-- Műveletek -->
          <div class="sizes-actions">
            <button
              type="button"
              class="reset-btn"
              (click)="resetToDefaults()"
            >
              <lucide-icon [name]="ICONS.REFRESH" [size]="14" />
              Alapértelmezés visszaállítása
            </button>
            <button
              class="save-btn"
              [disabled]="sizesSaving()"
              (click)="saveTabloSizes()"
            >
              @if (sizesSaving()) {
                <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              }
              Méretek mentése
            </button>
          </div>
        </div>
      }
    </div>

    <!-- Export beállítások szekció -->
    <div class="settings-section">
      <div class="section-title">
        <lucide-icon [name]="ICONS.DOWNLOAD" [size]="18" />
        <h2>Export beállítások</h2>
      </div>

      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">ZIP tartalom alapértelmezés</span>
            <span class="setting-description">
              Milyen képeket tartalmazzon a ZIP letöltés alapértelmezetten.
            </span>
          </div>
          <div class="setting-control">
            <ps-select
              size="md"
              [options]="zipContentOptions"
              [ngModel]="defaultZipContent()"
              (ngModelChange)="defaultZipContent.set($event)"
            />
          </div>
        </div>
      </div>

      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">Fájlnév stratégia</span>
            <span class="setting-description">
              Hogyan legyenek elnevezve a fájlok a letöltött ZIP-ben.
            </span>
          </div>
          <div class="setting-control">
            <ps-select
              size="md"
              [options]="fileNamingOptions"
              [ngModel]="defaultFileNaming()"
              (ngModelChange)="defaultFileNaming.set($event)"
            />
          </div>
        </div>
      </div>

      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">Mindig kérdezzen rá</span>
            <span class="setting-description">
              Ha aktív, ZIP letöltésnél mindig megjelenik a beállítás párbeszédablak.
              Ha inaktív, a fenti alapértelmezésekkel tölt le azonnal.
            </span>
          </div>
          <div class="setting-control">
            <ps-toggle
              [label]="exportAlwaysAsk() ? 'Aktív' : 'Inaktív'"
              [ngModel]="exportAlwaysAsk()"
              (ngModelChange)="exportAlwaysAsk.set($event)"
            />
          </div>
        </div>
      </div>

    </div>

    <div class="action-row">
      <button
        class="save-btn"
        [disabled]="saving()"
        (click)="save()"
      >
        @if (saving()) {
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
        }
        Mentés
      </button>
    </div>
  }
</div>
