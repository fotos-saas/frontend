<div class="bug-report-detail page-card">
  @if (loading()) {
    <div class="loading-skeleton">
      <div class="skeleton-bar skeleton-shimmer" style="width: 200px; height: 32px;"></div>
      <div class="skeleton-bar skeleton-shimmer" style="width: 100%; height: 120px; margin-top: 16px;"></div>
    </div>
  } @else if (report(); as r) {
    <!-- Vissza gomb + fejléc -->
    <div class="detail-header">
      <button class="back-btn" (click)="goBack()">
        <lucide-icon [name]="ICONS.ARROW_LEFT" [size]="18" />
        Vissza
      </button>
    </div>

    <div class="detail-title-row">
      <div class="title-with-id">
        <span class="report-id">#{{ r.id }}</span>
        <h1>{{ r.title }}</h1>
      </div>
      <div class="badges">
        <span class="badge" [class]="getStatusClass(r.status)">{{ r.status_label }}</span>
        <span class="badge" [class]="getPriorityClass(r.priority)">{{ r.priority_label }}</span>
      </div>
    </div>

    <p class="detail-meta">
      <lucide-icon [name]="ICONS.CLOCK" [size]="14" />
      Létrehozva: {{ r.created_at | date:'yyyy.MM.dd HH:mm' }}
    </p>

    <!-- Leírás -->
    <section class="detail-section">
      <h2>Leírás</h2>
      <div class="description-content" [innerHTML]="r.description | safeHtml"></div>
    </section>

    <!-- Mellékletek -->
    @if (r.attachments && r.attachments.length > 0) {
      <section class="detail-section">
        <h2>
          <lucide-icon [name]="ICONS.PAPERCLIP" [size]="16" />
          Mellékletek ({{ r.attachments.length }})
        </h2>
        <div class="attachments-grid">
          @for (att of r.attachments; track att.id) {
            <div class="attachment-card" (click)="openLightbox(att.url)">
              <img [src]="att.url" [alt]="att.original_filename" loading="lazy" />
              <span class="attachment-info">{{ att.original_filename }} ({{ att.formatted_size }})</span>
            </div>
          }
        </div>
      </section>
    }

    <!-- Státusz timeline -->
    @if (r.status_history && r.status_history.length > 0) {
      <section class="detail-section">
        <h2>
          <lucide-icon [name]="ICONS.CLOCK" [size]="16" />
          Előzmények
        </h2>
        <div class="timeline">
          @for (entry of r.status_history; track entry.id) {
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-status badge" [class]="getStatusClass(entry.new_status)">
                  {{ entry.new_status_label }}
                </span>
                @if (entry.changed_by) {
                  <span class="timeline-actor">{{ entry.changed_by.name }}</span>
                }
                <span class="timeline-date">{{ entry.created_at | date:'yyyy.MM.dd HH:mm' }}</span>
                @if (entry.note) {
                  <p class="timeline-note">{{ entry.note }}</p>
                }
              </div>
            </div>
          }
        </div>
      </section>
    }

    <!-- Kommentek -->
    <section class="detail-section">
      <h2>
        <lucide-icon [name]="ICONS.MESSAGE_CIRCLE" [size]="16" />
        Hozzászólások ({{ r.comments?.length || 0 }})
      </h2>

      @if (r.comments && r.comments.length > 0) {
        <div class="comments-list">
          @for (comment of r.comments; track comment.id) {
            <div class="comment-item">
              <div class="comment-header">
                <span class="comment-author">{{ comment.author.name }}</span>
                <span class="comment-date">{{ comment.created_at | date:'yyyy.MM.dd HH:mm' }}</span>
              </div>
              <div class="comment-body" [innerHTML]="comment.content | safeHtml"></div>
            </div>
          }
        </div>
      }

      <!-- Új komment -->
      <div class="new-comment">
        <app-rich-text-editor
          [ngModel]="newComment()"
          (ngModelChange)="newComment.set($event)"
          mode="basic"
          placeholder="Írd ide a hozzászólásodat..."
        />
        <button
          class="btn-comment"
          (click)="submitComment()"
          [disabled]="commentSubmitting() || !newComment().trim()"
        >
          @if (commentSubmitting()) {
            <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
            Küldés...
          } @else {
            <lucide-icon [name]="ICONS.SEND" [size]="16" />
            Küldés
          }
        </button>
      </div>
    </section>
  }
</div>

<!-- Lightbox -->
@if (lightboxImage()) {
  <div class="lightbox-backdrop" (click)="closeLightbox()">
    <img [src]="lightboxImage()" class="lightbox-image" (click)="$event.stopPropagation()" />
  </div>
}
