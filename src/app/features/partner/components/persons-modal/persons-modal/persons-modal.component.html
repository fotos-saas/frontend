<app-dialog-wrapper
  variant="info"
  headerStyle="flat"
  theme="blue"
  [icon]="ICONS.USERS"
  [title]="(typeFilter() === 'teacher' ? 'Tanár' : 'Diák') + ' személyek' + (!loading() && activeGroupWithoutPhotoCount() > 0 ? ' (' + activeGroupCount() + '/' + activeGroupWithoutPhotoCount() + ' hiányzik)' : '')"
  [description]="projectName()"
  size="lg"
  [closable]="true"
  (closeEvent)="close.emit()"
>
  <div dialogBody>
    <!-- Rövid projektnév (csak mobilon) -->
    <p class="mobile-desc">{{ shortProjectName() }}</p>

    <!-- Filter toggle gomb (csak mobilon látszik) -->
    <button type="button" class="filter-toggle" (click)="filtersOpen.set(!filtersOpen())">
      <lucide-icon [name]="ICONS.FILTER" [size]="14" />
      Szűrők
      @if (hasActiveFilter()) {
        <span class="filter-badge"></span>
      }
      <lucide-icon [name]="filtersOpen() ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN" [size]="14" class="filter-chevron" />
    </button>

    <!-- Szűrők (mobilon összecsukható) -->
    <div class="filters-collapsible" [class.filters-collapsible--open]="filtersOpen()">
      <!-- Search + Photo Filter -->
      <div class="search-section">
        <div class="search-row">
          <ps-input
            placeholder="Keresés név alapján..."
            suffix="search"
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
            class="search-input-field"
          />
          <button
            type="button"
            class="btn"
            [class.btn--outline]="!showOnlyWithoutPhoto()"
            [class.btn--primary]="showOnlyWithoutPhoto()"
            (click)="showOnlyWithoutPhoto.set(!showOnlyWithoutPhoto())"
          >
            <lucide-icon [name]="ICONS.EYE_OFF" [size]="14" />
            Kép nélkül
          </button>
        </div>
      </div>

      <!-- Type Filter Tabs + Edit gomb -->
      <div class="tabs-row" [class.tabs-row--hidden]="!!searchQuery()">
        @if (!hasInitialFilter()) {
          <div class="filter-tabs">
            <button type="button" class="tab" [class.tab--active]="typeFilter() === 'student'" (click)="typeFilter.set('student')">
              Diákok
              @if (!loading()) {
                <span class="tab-count">({{ studentCount() }})</span>
              }
            </button>
            <button type="button" class="tab" [class.tab--active]="typeFilter() === 'teacher'" (click)="typeFilter.set('teacher')">
              Tanárok
              @if (!loading()) {
                <span class="tab-count">({{ teacherCount() }})</span>
              }
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Content -->
    <div class="modal-content">
      @if (loading()) {
        <div class="skeleton-grid">
          @for (i of [1, 2, 3, 4, 5, 6]; track i) {
            <div class="skeleton-card skeleton-shimmer"></div>
          }
        </div>
      } @else if (filteredPersons().length === 0) {
        <div class="empty-state">
          <lucide-icon [name]="ICONS.CHECK_CIRCLE" [size]="48" class="empty-icon" />
          <h3>{{ emptyState().title }}</h3>
          <p>{{ emptyState().text }}</p>
        </div>
      } @else if (editMode()) {
        <!-- Szerkesztő lista nézet -->
        <div class="edit-list">
          @for (person of filteredPersons(); track person.id; let i = $index) {
            @let row = getEditRow(person.id);
            <div class="edit-row" [class.edit-row--dirty]="row?.dirty" [class.edit-row--saving]="row?.saving">
              <!-- Thumb + kamera feltöltés -->
              <div class="edit-thumb-wrap">
                <div class="edit-thumb" (click)="(person.photoUrl || person.photoThumbUrl) ? openLightbox(person) : null">
                  @if (person.photoThumbUrl) {
                    <img [src]="person.photoThumbUrl" [alt]="person.name" loading="lazy" />
                  } @else {
                    <div class="edit-thumb-placeholder">
                      <lucide-icon [name]="ICONS.USER_X" [size]="16" />
                    </div>
                  }
                </div>
                <!-- Kamera gomb — fotó feltöltés dialógus -->
                <button type="button" class="edit-thumb-camera" matTooltip="Kép feltöltése" (click)="openPhotoUploadDialog(person)">
                  <lucide-icon [name]="ICONS.CAMERA" [size]="12" />
                </button>
              </div>

              <!-- Mezők -->
              <div class="edit-fields">
                <div class="edit-fields-top">
                  <!-- Név input -->
                  <input
                    type="text"
                    class="edit-field edit-field--name"
                    placeholder="Név"
                    [value]="row?.name ?? person.name"
                    (input)="onEditFieldChange(person.id, 'name', $any($event.target).value)"
                    (keydown.enter)="saveRow(person.id)"
                  />
                  <!-- Title input (csak tanárnál) -->
                  @if (person.type === 'teacher') {
                    <input
                      type="text"
                      class="edit-field edit-field--title"
                      placeholder="Pozíció/tantárgy"
                      [value]="row?.title ?? (person.title || '')"
                      (input)="onEditFieldChange(person.id, 'title', $any($event.target).value)"
                      (keydown.enter)="saveRow(person.id)"
                    />
                  }
                </div>
                <!-- Megjegyzés -->
                <input
                  type="text"
                  class="edit-field edit-field--note"
                  placeholder="Megjegyzés..."
                  [value]="row?.note ?? (person.note || '')"
                  (input)="onEditFieldChange(person.id, 'note', $any($event.target).value)"
                  (keydown.enter)="saveRow(person.id)"
                />
              </div>

              <!-- Mentés gomb -->
              @if (row?.dirty) {
                <button
                  class="edit-save-btn"
                  (click)="saveRow(person.id)"
                  [disabled]="row?.saving"
                  matTooltip="Mentés"
                >
                  @if (row?.saving) {
                    <lucide-icon [name]="ICONS.LOADER" [size]="14" class="spin" />
                  } @else {
                    <lucide-icon [name]="ICONS.CHECK" [size]="14" />
                  }
                </button>
              }

              <!-- Törlés gomb -->
              <button
                class="edit-delete-btn"
                (click)="deletePerson(person)"
                matTooltip="Személy törlése"
              >
                <lucide-icon [name]="ICONS.DELETE" [size]="14" />
              </button>
            </div>
          }
        </div>

        <!-- Összes mentése gomb -->
        @if (hasDirtyEdits()) {
          <div class="save-all-bar">
            <button type="button" class="save-all-btn" (click)="saveAllDirty()">
              <lucide-icon [name]="ICONS.SAVE" [size]="16" />
              Összes módosítás mentése
            </button>
          </div>
        }
      } @else {
        <!-- Grid nézet -->
        <div class="persons-grid" (click)="$event">
          @for (person of filteredPersons(); track person.id; let i = $index) {
            @let isSelected = batchActions.selectedPersonIds().has(person.id);
            <div
              class="card-wrap"
              [class.card-wrap--selected]="isSelected"
              (click)="onCardClick(person, $event)"
            >
              @if (isSelected) {
                <div class="selection-checkbox">
                  <lucide-icon [name]="ICONS.CHECK" [size]="12" />
                </div>
              }
              <app-modal-person-card
                [person]="person"
                [animationDelay]="i * 0.05 + 's'"
                (cardClick)="$event"
                (linkClick)="openLinkDialog($event)"
                (photoChooserClick)="openPhotoChooser($event)"
              />
            </div>
          }
        </div>
      }

      <!-- Tanítottak még / Egyéb nevek szekció -->
      @if (!loading() && !searchQuery()) {
        @if (editMode()) {
          <div class="extra-names-section">
            <div class="extra-names-header">
              <label class="extra-names-label">
                <lucide-icon [name]="ICONS.LIST" [size]="14" />
                {{ typeFilter() === 'teacher' ? 'Tanítottak még' : 'Egyéb nevek' }}
              </label>
              <div class="extra-names-actions">
                <button type="button" class="en-action-btn" matTooltip="Névsor (magyar ábécé)" (click)="sortExtraNamesAbc()">
                  <lucide-icon [name]="ICONS.ARROW_DOWN_AZ" [size]="14" />
                </button>
                <button type="button" class="en-action-btn" [class.en-action-btn--active]="extraNamesInline()" matTooltip="Sorba (vesszővel)" (click)="setExtraNamesFormat(true)">
                  <lucide-icon [name]="ICONS.COLUMNS_3" [size]="14" />
                </button>
                <button type="button" class="en-action-btn" [class.en-action-btn--active]="!extraNamesInline()" matTooltip="Egymás alá" (click)="setExtraNamesFormat(false)">
                  <lucide-icon [name]="ICONS.ROWS_3" [size]="14" />
                </button>
                <button type="button" class="en-action-btn" [class.en-action-btn--success]="extraNamesCopied()" [matTooltip]="extraNamesCopied() ? 'Kimásolva!' : 'Másolás'" (click)="copyExtraNames()">
                  <lucide-icon [name]="extraNamesCopied() ? ICONS.CHECK : ICONS.COPY" [size]="14" />
                </button>
              </div>
            </div>
            <textarea
              class="extra-names-textarea"
              [placeholder]="typeFilter() === 'teacher' ? 'Hargitai György, Kiss Péter, ...' : 'További nevek, vesszővel elválasztva...'"
              [value]="currentExtraText()"
              (input)="onExtraNamesChange(typeFilter() === 'teacher' ? 'teachers' : 'students', $any($event.target).value)"
              rows="3"
            ></textarea>
            @if (extraNamesDirty()) {
              <button type="button" class="extra-names-save-btn" (click)="saveExtraNames()" [disabled]="extraNamesSaving()">
                <lucide-icon [name]="extraNamesSaving() ? ICONS.LOADER : ICONS.SAVE" [size]="14" [class.spin]="extraNamesSaving()" />
                Mentés
              </button>
            }
          </div>
        } @else if (currentExtraText()) {
          <div class="extra-names-section extra-names-section--readonly">
            <div class="extra-names-header">
              <span class="extra-names-label">
                <lucide-icon [name]="ICONS.LIST" [size]="14" />
                {{ typeFilter() === 'teacher' ? 'Tanítottak még' : 'Egyéb nevek' }}
              </span>
              <button type="button" class="en-action-btn" matTooltip="Másolás" (click)="copyExtraNames()">
                <lucide-icon [name]="ICONS.COPY" [size]="14" />
              </button>
            </div>
            <p class="extra-names-text">{{ currentExtraText() }}</p>
          </div>
        }
      }
    </div>
  </div>

  <!-- Footer -->
  @if (!loading()) {
    <div dialogFooter class="modal-footer">
      <div class="footer-actions">
        <button
          type="button"
          class="btn btn--primary"
          [matTooltip]="'Új ' + (typeFilter() === 'teacher' ? 'tanár' : 'diák') + ' hozzáadása'"
          (click)="addPersonsRequested.emit(typeFilter())"
        >
          <lucide-icon [name]="ICONS.PLUS" [size]="14" />
          Új {{ typeFilter() === 'teacher' ? 'tanár' : 'diák' }}
        </button>

        @if (isElectron && batchActions.selectedCount() > 0) {
          <button type="button" class="btn btn--ghost" (click)="startBatchPortrait()">
            <lucide-icon [name]="ICONS.SCAN_FACE" [size]="14" />
            Háttércsere ({{ batchActions.selectedCount() }})
          </button>
          <button type="button" class="btn btn--ghost" matTooltip="Kijelölés törlése" (click)="batchActions.resetSelection()">
            <lucide-icon [name]="ICONS.X" [size]="14" />
          </button>
        }

        @if (filteredPersons().length > 0) {
          <button
            type="button"
            class="btn btn--outline"
            (click)="toggleEditMode()"
          >
            <lucide-icon [name]="editMode() ? ICONS.X : ICONS.EDIT" [size]="14" />
            {{ editMode() ? 'Kész' : 'Szerkesztés' }}
          </button>
        }
      </div>

      @if (withoutPhotoCount() > 0 && !editMode()) {
        <button type="button" class="upload-btn" (click)="openUploadWizard.emit(typeFilter())">
          <lucide-icon [name]="ICONS.UPLOAD" [size]="18" />
          Tovább a fényképek feltöltéséhez
        </button>
      }
    </div>
  }
</app-dialog-wrapper>

<!-- Lightbox -->
<app-photo-lightbox
  [person]="lightboxPerson()"
  [personsWithPhotos]="personsWithPhotos()"
  [projectId]="projectId()"
  (close)="closeLightbox()"
  (navigate)="lightboxPerson.set($event)"
  (photoChanged)="onPhotoChanged($event)"
/>

<!-- Fotó feltöltés dialógus -->
@if (photoUploadPerson(); as uploadPerson) {
  <app-layout-photo-upload-dialog
    [person]="uploadPerson"
    [projectId]="projectId()"
    (close)="closePhotoUploadDialog()"
    (photoUploaded)="onPhotoUploaded($event)"
  />
}

<!-- Törlés megerősítő dialógus -->
@if (deleteConfirmPerson(); as person) {
  <app-confirm-dialog
    [title]="'Személy törlése'"
    [message]="'Biztosan törlöd: ' + person.name + '?'"
    confirmText="Törlés"
    confirmType="danger"
    (resultEvent)="$event.action === 'confirm' ? confirmDeletePerson() : cancelDeletePerson()"
  />
}

<!-- Batch portré háttércsere dialógus -->
@if (batchPortraitPersons(); as batchPersons) {
  <app-batch-portrait-dialog
    [persons]="batchPersons"
    [projectId]="projectId()"
    (close)="onBatchPortraitCompleted()"
  />
}

<!-- Tanár összekapcsolás dialógus -->
@if (showTeacherLinkDialog() && linkDialogTeacher()) {
  <app-teacher-link-dialog
    [teacher]="linkDialogTeacher()!"
    [allTeachers]="linkDialogAllTeachers()"
    (closeEvent)="showTeacherLinkDialog.set(false)"
    (savedEvent)="onTeacherLinked()"
    (photoChooserEvent)="onOpenPhotoChooserFromLink($event)"
  />
}

<!-- Fotó csere archívumból dialógus -->
@if (showPhotoChooserDialog() && photoChooserPhotos().length > 0) {
  <app-teacher-photo-chooser-dialog
    [photos]="photoChooserPhotos()"
    [linkedGroup]="photoChooserLinkedGroup()"
    (closeEvent)="showPhotoChooserDialog.set(false)"
    (savedEvent)="onPhotoChosen()"
  />
}
