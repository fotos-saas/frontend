<div class="gallery-detail page-card">
  <!-- Loading -->
  @if (state.loading()) {
    <div class="animate-pulse">
      <div class="h-8 bg-gray-200 rounded w-1/3 mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-1/2 mb-8"></div>
      <div class="grid grid-cols-4 gap-4">
        @for (_ of [1,2,3,4,5,6,7,8]; track _) {
          <div class="aspect-square bg-gray-200 rounded-lg"></div>
        }
      </div>
    </div>
  }

  @if (!state.loading() && state.gallery()) {
    <!-- Header -->
    <app-gallery-header
      [galleryName]="state.gallery()!.name"
      [photosCount]="state.gallery()!.photosCount"
      (back)="onBack()"
    />

    <!-- Tabs -->
    <app-gallery-tabs
      [activeTab]="state.activeTab()"
      (tabChange)="onTabChange($event)"
    />

    <!-- MONITORING TAB -->
    @if (state.activeTab() === 'monitoring') {
      <app-gallery-monitoring #monitoringRef [projectId]="projectId" [galleryName]="state.gallery()!.name" />
    }

    <!-- GALLERY TAB -->
    @if (state.activeTab() === 'gallery') {
    <!-- Info Bar -->
    <app-gallery-info-bar
      [photosCount]="state.gallery()!.photosCount"
      [totalSizeMb]="state.gallery()!.totalSizeMb"
      [viewMode]="state.viewMode()"
      [progress]="state.progress()"
      [deadline]="state.deadline()"
      [deadlineFormatted]="state.deadlineFormatted()"
      [settingDeadline]="state.settingDeadline()"
      [isDeadlineExpired]="state.isDeadlineExpired()"
      (viewModeChange)="state.viewMode.set($event)"
      (deadlineExtend)="onDeadlineExtend($event)"
    />

    <!-- Upload Section -->
    @if (!state.hasPhotos()) {
      <div class="mb-6">
        <app-drop-zone
          [uploading]="state.uploading()"
          [detailedProgress]="state.detailedUploadProgress()"
          accept=".jpg,.jpeg,.png,.webp,.zip"
          hint="JPG, PNG, WebP vagy ZIP"
          maxSize="max. 50MB/fájl"
          (filesSelected)="onFilesSelected($event)"
        />
      </div>
    } @else {
      @if (!state.dropZoneVisible()) {
        <button
          type="button"
          class="upload-toggle-btn"
          (click)="state.dropZoneVisible.set(true)"
        >
          <lucide-icon [name]="ICONS.UPLOAD" [size]="16" />
          Képek feltöltése
        </button>
      } @else {
        <div class="upload-section">
          <div class="upload-section__header">
            <span>Képek feltöltése</span>
            <button
              type="button"
              class="upload-section__close"
              (click)="state.dropZoneVisible.set(false)"
            >
              <lucide-icon [name]="ICONS.X" [size]="16" />
            </button>
          </div>
          <app-drop-zone
            [uploading]="state.uploading()"
            [detailedProgress]="state.detailedUploadProgress()"
            accept=".jpg,.jpeg,.png,.webp,.zip"
            hint="JPG, PNG, WebP vagy ZIP"
            maxSize="max. 50MB/fájl"
            (filesSelected)="onFilesSelected($event)"
          />
        </div>
      }
    }

    <!-- Delete mode toolbar -->
    @if (state.deleteSelectedIds().length > 0) {
      <div class="delete-toolbar">
        <span class="delete-toolbar__count">
          {{ state.deleteSelectedIds().length }} kép kijelölve törlésre
        </span>
        <div class="delete-toolbar__actions">
          <button
            type="button"
            class="delete-toolbar__btn delete-toolbar__btn--cancel"
            (click)="state.clearDeleteSelection()"
          >
            Mégsem
          </button>
          <button
            type="button"
            class="delete-toolbar__btn delete-toolbar__btn--delete"
            [disabled]="state.deletingPhotos()"
            (click)="onConfirmDeletePhotos()"
          >
            @if (state.deletingPhotos()) {
              <div class="spinner"></div>
            } @else {
              <lucide-icon [name]="ICONS.DELETE" [size]="16" />
            }
            Törlés
          </button>
        </div>
      </div>
    }

    <!-- Grid nézet -->
    @if (state.gallery()!.photos.length > 0 && state.viewMode() === 'grid') {
      <div class="selection-bar">
        <div class="selection-bar__actions">
          @if (state.allSelectedForDelete()) {
            <button
              type="button"
              class="selection-bar__btn"
              (click)="state.clearDeleteSelection()"
            >
              <lucide-icon [name]="ICONS.X_CIRCLE" [size]="14" />
              Kijelölés törlése
            </button>
          } @else {
            <button
              type="button"
              class="selection-bar__btn"
              (click)="state.selectAllForDelete()"
            >
              <lucide-icon [name]="ICONS.CHECK" [size]="14" />
              Összes kijelölése
            </button>
          }
        </div>
        <span class="selection-bar__hint">
          <lucide-icon [name]="ICONS.INFO" [size]="12" />
          Ctrl/Cmd + kattintás = egyenkénti kijelölés
        </span>
      </div>
      <app-selection-grid
        [photos]="state.gridPhotos()"
        [selectedIds]="[]"
        [deleteMode]="true"
        [deleteSelectedIds]="state.deleteSelectedIds()"
        [allowMultiple]="true"
        [maxSelection]="null"
        [isLoading]="false"
        [readonly]="true"
        [showHeader]="false"
        [emptyMessage]="'Nincsenek képek'"
        (zoomClick)="onZoomClick($event)"
        (deleteSelect)="onDeleteSelect($event)"
        (deleteSingleClick)="onSingleDeleteClick($event)"
      />
    }

    <!-- Lista nézet -->
    @if (state.gallery()!.photos.length > 0 && state.viewMode() === 'list') {
      <div class="selection-bar">
        <div class="selection-bar__actions">
          @if (state.allSelectedForDelete()) {
            <button
              type="button"
              class="selection-bar__btn"
              (click)="state.clearDeleteSelection()"
            >
              <lucide-icon [name]="ICONS.X_CIRCLE" [size]="14" />
              Kijelölés törlése
            </button>
          } @else {
            <button
              type="button"
              class="selection-bar__btn"
              (click)="state.selectAllForDelete()"
            >
              <lucide-icon [name]="ICONS.CHECK" [size]="14" />
              Összes kijelölése
            </button>
          }
        </div>
        <span class="selection-bar__hint">
          <lucide-icon [name]="ICONS.INFO" [size]="12" />
          Ctrl/Cmd + kattintás = egyenkénti kijelölés
        </span>
      </div>
      <app-gallery-photo-list
        [photos]="state.paginatedPhotos()"
        [deleteSelectedIds]="state.deleteSelectedIds()"
        [searchQuery]="state.searchQuery()"
        [currentPage]="state.currentPage()"
        [totalPages]="state.totalPages()"
        [filteredCount]="state.filteredPhotos().length"
        [totalCount]="state.gallery()!.photosCount"
        (searchChange)="state.setSearchQuery($event)"
        (pageChange)="state.goToPage($event)"
        (zoomClick)="onListZoomClick($event)"
        (deleteClick)="onListDeleteClick($event)"
        (listItemClick)="onListItemClick($event)"
      />
    }

    <!-- Üres állapot -->
    @if (state.gallery()!.photos.length === 0) {
      <div class="text-center py-12 bg-gray-50 rounded-lg">
        <lucide-icon [name]="ICONS.IMAGE" [size]="48" class="mx-auto text-gray-400 mb-4" />
        <p class="text-gray-600">Még nincsenek képek a galériában</p>
        <p class="text-sm text-gray-400 mt-1">Húzz ide képeket vagy kattints a feltöltő területre</p>
      </div>
    }
    } <!-- /gallery tab -->
  }
</div>

<!-- Dialógusok - page-card KÍVÜL a backdrop-filter stacking context miatt -->

<!-- Delete Photo Confirm -->
@if (state.photoToDelete()) {
  <app-confirm-dialog
    title="Kép törlése"
    message="Biztosan törölni szeretnéd ezt a képet?"
    confirmText="Törlés"
    confirmType="danger"
    (resultEvent)="onDeletePhotoResult($event)"
  />
}

<!-- Delete Multiple Photos Confirm -->
@if (state.deletePhotosDialog.isOpen()) {
  <app-confirm-dialog
    title="Képek törlése"
    [message]="'Biztosan törölni szeretnéd a kijelölt ' + state.deleteSelectedIds().length + ' képet? Ez a művelet nem visszavonható.'"
    confirmText="Törlés"
    confirmType="danger"
    (resultEvent)="onDeletePhotosResult($event)"
  />
}

<!-- Download dialog (monitoring) -->
@if (monitoringRef()?.state?.showDownloadDialog()) {
  <app-download-dialog
    [defaults]="monitoringRef()!.dialogDefaults()"
    (download)="monitoringRef()!.onDownloadZip($event)"
    (close)="monitoringRef()!.onCloseDownloadDialog()"
  />
}

<!-- Lightbox (galéria grid) -->
@defer (on idle) {
  @if (state.lightboxOpen()) {
    <app-media-lightbox
      [media]="state.lightboxMedia()"
      [currentIndex]="state.lightboxIndex()"
      (close)="state.closeLightbox()"
      (navigate)="onNavigateLightbox($event)"
    />
  }

  <!-- Lightbox (monitoring detail) -->
  @if (monitoringRef()?.state?.lightboxOpen()) {
    <app-media-lightbox
      [media]="monitoringRef()!.state.lightboxMedia()"
      [currentIndex]="monitoringRef()!.state.lightboxIndex()"
      (close)="monitoringRef()!.onLightboxClose()"
      (navigate)="monitoringRef()!.onLightboxNavigate($event)"
    />
  }
}
