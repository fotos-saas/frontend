<app-dialog-wrapper
  [variant]="mode() === 'edit' ? 'edit' : 'create'"
  headerStyle="hero"
  theme="purple"
  [icon]="ICONS.MESSAGE_CIRCLE"
  [title]="mode() === 'edit' ? 'Téma szerkesztése' : 'Új beszélgetés indítása'"
  [description]="mode() === 'edit' ? 'Módosítsd a téma címét és tartalmát.' : 'Indíts új témát az osztály fórumán. A beszélgetésben mindenki részt vehet.'"
  size="lg"
  [isSubmitting]="_isSubmitting()"
  [errorMessage]="_errorMessage()"
  (closeEvent)="close()"
>
  <!-- Body -->
  <ng-container dialogBody>
    <!-- Title field -->
    <div class="dialog__field">
      <ps-input
        label="Téma címe"
        [required]="true"
        [(ngModel)]="title"
        (ngModelChange)="onInputChange()"
        placeholder="Pl.: Osztálykirándulás ötletek"
        [disabled]="_isSubmitting()"
        [errorMessage]="errors.title || ''"
        autocomplete="off"
      />
      <div class="dialog__field-footer">
        @if (!errors.title) {
          <span class="dialog__char-count">{{ titleCharCount() }}</span>
        }
      </div>
    </div>

    <!-- Content field -->
    <div class="dialog__field">
      <label class="dialog__label" for="discussion-content">
        Tartalom <span class="dialog__required">*</span>
      </label>

      <!-- Rich Text Editor -->
      @if (useRichEditor()) {
        <app-rich-text-editor
          [(ngModel)]="content"
          name="richContent"
          mode="standard"
          placeholder="Írd le részletesen, miről szól a téma..."
          [disabled]="_isSubmitting()"
          [minHeight]="150"
          [maxHeight]="300"
          (textLengthChangeEvent)="onContentTextLengthChange($event)"
        />
      } @else {
        <!-- Simple Textarea fallback -->
        <ps-textarea
          [(ngModel)]="content"
          (ngModelChange)="onInputChange()"
          placeholder="Írd le részletesen, miről szól a téma..."
          [disabled]="_isSubmitting()"
          [maxLength]="10000"
          [rows]="5"
          [errorMessage]="errors.content || ''"
        />
      }

      <div class="dialog__field-footer">
        @if (errors.content) {
          <span class="dialog__error">{{ errors.content }}</span>
        } @else if (!useRichEditor()) {
          <span class="dialog__char-count">{{ contentCharCount() }}</span>
        } @else {
          <span class="dialog__char-count">{{ contentTextLength }} karakter</span>
        }
      </div>
    </div>

    <!-- Media Editor (edit módban) -->
    @if (mode() === 'edit' && editData()) {
      <div class="dialog__field">
        <label class="dialog__label">
          Képek <span class="dialog__optional">(opcionális)</span>
        </label>
        <app-media-editor
          [existingMedia]="existingMediaItems()"
          [maxFiles]="3"
          [maxSizeMB]="5"
          [acceptedTypes]="'image/jpeg,image/png,image/gif,image/webp'"
          [disabled]="_isSubmitting()"
          existingLabel="Meglévő képek"
          newLabel="Új képek hozzáadása"
          (newFilesChange)="onNewFilesChange($event)"
          (mediaToDeleteChange)="onMediaToDeleteChange($event)"
          (error)="onMediaError($event)"
        />
      </div>
    }

    <!-- Template selector (opcionális, csak create módban) -->
    @if (templates().length > 0 && mode() === 'create') {
      <div class="dialog__field">
        <ps-select
          label="Kapcsolódó sablon"
          emptyLabel="— Nincs kapcsolódó sablon —"
          [options]="templateSelectOptions()"
          [(ngModel)]="templateId"
          (ngModelChange)="onInputChange()"
          [disabled]="_isSubmitting()"
          hint="Ha a téma egy konkrét sablonhoz kapcsolódik, válaszd ki itt."
        />
      </div>
    }
  </ng-container>

  <!-- Footer -->
  <ng-container dialogFooter>
    <button
      type="button"
      class="btn btn--secondary"
      (click)="close()"
      [disabled]="_isSubmitting()"
    >
      Mégse
    </button>

    <button
      type="button"
      class="btn btn--purple"
      (click)="submit()"
      [disabled]="!isFormValid() || _isSubmitting()"
    >
      @if (_isSubmitting()) {
        <lucide-icon [name]="ICONS.LOADER" [size]="18" class="spin" />
      }
      <lucide-icon [name]="ICONS.SEND" [size]="18" />
      {{ _isSubmitting() ? (mode() === 'edit' ? 'Mentés...' : 'Létrehozás...') : (mode() === 'edit' ? 'Mentés' : 'Téma létrehozása') }}
    </button>
  </ng-container>
</app-dialog-wrapper>
