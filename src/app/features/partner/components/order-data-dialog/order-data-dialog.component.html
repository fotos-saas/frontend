<app-dialog-wrapper
  variant="info"
  headerStyle="flat"
  theme="blue"
  [icon]="ICONS.FILE_TEXT"
  title="Megrendelési adatok"
  [description]="orderData?.orderDate ? 'Leadva: ' + (orderData!.orderDate | date:'yyyy. MM. dd.') : ''"
  size="lg"
  (closeEvent)="close.emit()"
>
  <ng-container dialogBody>
    <!-- Tabok -->
    <div class="order-dialog__tabs">
      <button
        class="order-dialog__tab"
        [class.order-dialog__tab--active]="activeTab() === 'order'"
        (click)="activeTab.set('order')"
      >
        <lucide-icon [name]="ICONS.FILE_TEXT" [size]="14" />
        Megrendelési adatok
      </button>
      <button
        class="order-dialog__tab"
        [class.order-dialog__tab--active]="activeTab() === 'sync'"
        (click)="activeTab.set('sync')"
      >
        <lucide-icon [name]="ICONS.REFRESH" [size]="14" />
        Szinkronizálás
      </button>
    </div>

    <!-- Szinkronizálás tab -->
    @if (activeTab() === 'sync') {
      <app-order-sync-panel [projectId]="projectId()" />
    }

    <!-- Megrendelési adatok tab -->
    @if (activeTab() === 'order') {

    <!-- Névsor szinkronizáció banner -->
    @if (rosterSyncStatus() === 'processing') {
      <div class="order-dialog__sync-banner order-dialog__sync-banner--processing" role="status" aria-live="polite">
        <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
        <span>Névsor feldolgozása folyamatban...</span>
      </div>
    }
    @if (rosterSyncStatus() === 'completed' && rosterSyncResult()) {
      <div class="order-dialog__sync-banner order-dialog__sync-banner--completed" role="status" aria-live="polite">
        <lucide-icon [name]="ICONS.CHECK" [size]="16" />
        <span>Névsor szinkronizálva: {{ syncBannerText() }}</span>
        @if (rosterSyncResult()!.warnings.length > 0) {
          <ul class="order-dialog__sync-warnings">
            @for (warning of rosterSyncResult()!.warnings; track warning) {
              <li>{{ warning }}</li>
            }
          </ul>
        }
      </div>
    }
    @if (rosterSyncStatus() === 'failed') {
      <div class="order-dialog__sync-banner order-dialog__sync-banner--failed" role="alert" aria-live="assertive">
        <lucide-icon [name]="ICONS.ALERT_TRIANGLE" [size]="16" />
        <span>Névsor feldolgozás sikertelen</span>
      </div>
    }

    <!-- Loading -->
    @if (loading) {
      <div class="order-dialog__loading">
        <lucide-icon [name]="ICONS.LOADER" [size]="28" class="spin" />
        <p>Adatok betöltése...</p>
      </div>
    }

    <!-- Error -->
    @if (error && !loading) {
      <div class="order-dialog__error">
        <p>{{ error }}</p>
        <button class="btn btn--primary btn--sm" (click)="loadOrderData()">
          Újrapróbálkozás
        </button>
      </div>
    }

    <!-- Empty -->
    @if (!loading && !error && !orderData) {
      <div class="order-dialog__empty">
        <lucide-icon [name]="ICONS.FILE_TEXT" [size]="48" />
        <p>Még nincs leadott megrendelés</p>
      </div>
    }

    <!-- Content -->
    @if (!loading && !error && orderData) {
      <div class="order-dialog__content">
        <!-- Kapcsolattartó + Iskola -->
        <div class="order-dialog__row">
          @if (orderData.contactName || orderData.contactPhone || orderData.contactEmail) {
            <section class="order-dialog__section">
              <h3 class="order-dialog__section-title">Kapcsolattartó</h3>
              <div class="order-dialog__list">
                @if (orderData.contactName) {
                  <div class="order-dialog__item">
                    <span class="order-dialog__label">Név</span>
                    <span class="order-dialog__value">{{ orderData.contactName }}</span>
                  </div>
                }
                @if (orderData.contactPhone) {
                  <div class="order-dialog__item">
                    <span class="order-dialog__label">Telefon</span>
                    <span class="order-dialog__value">{{ orderData.contactPhone }}</span>
                  </div>
                }
                @if (orderData.contactEmail) {
                  <div class="order-dialog__item">
                    <span class="order-dialog__label">Email</span>
                    <span class="order-dialog__value">{{ orderData.contactEmail }}</span>
                  </div>
                }
              </div>
            </section>
          }

          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Iskola és osztály</h3>
            <div class="order-dialog__list">
              @if (orderData.schoolName) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Iskola</span>
                  <span class="order-dialog__value">{{ orderData.schoolName }}</span>
                </div>
              }
              @if (orderData.className || orderData.classYear) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Osztály</span>
                  <span class="order-dialog__value">
                    {{ orderData.className }}
                    @if (orderData.classYear) {
                      <span>({{ orderData.classYear }})</span>
                    }
                  </span>
                </div>
              }
              @if (orderData.studentCount || orderData.teacherCount) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Létszám</span>
                  <span class="order-dialog__value">
                    @if (orderData.studentCount) {
                      <span>{{ orderData.studentCount }} diák</span>
                    }
                    @if (orderData.studentCount && orderData.teacherCount) {
                      <span>, </span>
                    }
                    @if (orderData.teacherCount) {
                      <span>{{ orderData.teacherCount }} tanár</span>
                    }
                  </span>
                </div>
              }
            </div>
          </section>
        </div>

        <!-- Tabló beállítások -->
        @if (orderData.color || orderData.fontFamily || orderData.sortType) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Tabló beállítások</h3>
            <div class="order-dialog__grid">
              @if (orderData.color) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Szín</span>
                  <span class="order-dialog__value order-dialog__value--color">
                    <span class="order-dialog__color-swatch" [style.background-color]="orderData.color"></span>
                    {{ orderData.color }}
                  </span>
                </div>
              }
              @if (orderData.fontFamily) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Betűtípus</span>
                  <span class="order-dialog__value">{{ orderData.fontFamily }}</span>
                </div>
              }
              @if (orderData.sortType) {
                <div class="order-dialog__item">
                  <span class="order-dialog__label">Rendezés</span>
                  <span class="order-dialog__value">{{ orderData.sortType }}</span>
                </div>
              }
            </div>
          </section>
        }

        <!-- Leírás -->
        @if (orderData.description) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Leírás / Megjegyzések</h3>
            <div class="order-dialog__description" [innerHTML]="orderData.description | safeHtml"></div>
          </section>
        }

        <!-- Idézet -->
        @if (orderData.quote) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Idézet</h3>
            <blockquote class="order-dialog__quote">{{ orderData.quote }}</blockquote>
          </section>
        }

        <!-- Névsorok -->
        @if (orderData.studentDescription || orderData.teacherDescription) {
          <div class="order-dialog__row">
            @if (orderData.studentDescription) {
              <section class="order-dialog__section">
                <h3 class="order-dialog__section-title">Diákok névsora</h3>
                <div class="order-dialog__namelist" [innerHTML]="orderData.studentDescription | linkify"></div>
              </section>
            }
            @if (orderData.teacherDescription) {
              <section class="order-dialog__section">
                <h3 class="order-dialog__section-title">Tanárok névsora</h3>
                <div class="order-dialog__namelist" [innerHTML]="orderData.teacherDescription | linkify"></div>
              </section>
            }
          </div>
        }

        <!-- Jellemzők -->
        @if (hasTags) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Jellemzők</h3>
            <div class="order-dialog__tags">
              @for (tag of orderData!.tags; track tag) {
                <span class="order-dialog__tag">{{ tag }}</span>
              }
            </div>
          </section>
        }

        <!-- AI összefoglaló -->
        @if (orderData.aiSummary) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">AI összefoglaló</h3>
            <p class="order-dialog__summary">{{ orderData.aiSummary }}</p>
          </section>
        }

        <!-- Csatolmányok -->
        @if (hasAttachments) {
          <section class="order-dialog__section">
            <h3 class="order-dialog__section-title">Csatolmányok</h3>
            <div class="order-dialog__attachments">
              @if (orderData.backgroundUrl) {
                <div class="order-dialog__attachment">
                  <lucide-icon [name]="ICONS.IMAGE" [size]="16" />
                  <span class="order-dialog__attachment-name">Háttérkép</span>
                  <button class="order-dialog__attachment-btn" (click)="downloadFile(orderData.backgroundUrl!)">
                    <lucide-icon [name]="ICONS.DOWNLOAD" [size]="14" />
                    Letöltés
                  </button>
                </div>
              }
              @for (file of orderData.otherFiles; track file.url) {
                <div class="order-dialog__attachment">
                  <lucide-icon [name]="ICONS.PAPERCLIP" [size]="16" />
                  <span class="order-dialog__attachment-name">{{ file.filename }}</span>
                  <button class="order-dialog__attachment-btn" (click)="downloadFile(file.url)">
                    <lucide-icon [name]="ICONS.DOWNLOAD" [size]="14" />
                    Letöltés
                  </button>
                </div>
              }
            </div>
          </section>
        }
      </div>
    }
    }
  </ng-container>

  <ng-container dialogFooter>
    <button type="button" class="btn btn--outline" (click)="close.emit()">Bezárás</button>
    @if (orderData) {
      <button
        type="button"
        class="btn btn--primary"
        (click)="openPdf()"
        [disabled]="generatingPdf || loading"
      >
        @if (generatingPdf) {
          <lucide-icon [name]="ICONS.LOADER" [size]="16" class="spin" />
          Generálás...
        } @else {
          <lucide-icon [name]="ICONS.FILE_TEXT" [size]="16" />
          PDF letöltés
        }
      </button>
    }
  </ng-container>
</app-dialog-wrapper>
