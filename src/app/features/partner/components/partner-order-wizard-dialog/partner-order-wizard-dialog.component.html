<app-dialog-wrapper
  headerStyle="flat"
  [icon]="ICONS.FILE_TEXT"
  [title]="dialogTitle()"
  [description]="dialogDescription()"
  theme="purple"
  size="lg"
  variant="wizard"
  [isSubmitting]="submitting()"
  (closeEvent)="close.emit()"
>
  <!-- Body -->
  <div dialogBody>
    <!-- Stepper -->
    <div class="wizard-stepper">
      @for (step of steps; track $index) {
        <button
          class="wizard-stepper__step"
          [class.active]="currentStep() === $index"
          [class.completed]="$index < currentStep()"
          [class.clickable]="$index <= currentStep()"
          [disabled]="$index > currentStep()"
          (click)="goToStep($index)"
        >
          <span class="wizard-stepper__number">{{ $index + 1 }}</span>
          <span class="wizard-stepper__label">{{ step }}</span>
        </button>
        @if ($index < steps.length - 1) {
          <div class="wizard-stepper__line" [class.completed]="$index < currentStep()"></div>
        }
      }
    </div>

    <!-- Content -->
    <div class="wizard-content" #wizardContent>
      @if (loading()) {
        <div class="wizard-loading">
          <div class="spinner"></div>
          <p>Betöltés...</p>
        </div>
      } @else {
        @switch (currentStep()) {
          @case (0) {
            <app-contact-step
              [data]="formData().contact"
              [partnerMode]="true"
              (dataChange)="onContactChange($event)"
            />
          }
          @case (1) {
            <app-basic-info-step
              [data]="formData().basicInfo"
              [partnerMode]="true"
              (dataChange)="onBasicInfoChange($event)"
            />
          }
          @case (2) {
            <app-design-step
              [data]="formData().design"
              [backgroundFileName]="backgroundFileName()"
              [attachmentFileNames]="attachmentFileNames()"
              [uploadBackgroundFn]="uploadBackgroundFn"
              [uploadAttachmentFn]="uploadAttachmentFn"
              [deleteFileFn]="deleteFileFn"
              (dataChange)="onDesignChange($event)"
              (backgroundFileNameChange)="onBackgroundFileNameChange($event)"
              (attachmentFileNamesChange)="onAttachmentFileNamesChange($event)"
            />
          }
          @case (3) {
            <app-roster-step
              [data]="formData().roster"
              [partnerMode]="true"
              (dataChange)="onRosterChange($event)"
            />
          }
        }
      }
    </div>
  </div>

  <!-- Footer -->
  <div dialogFooter class="wizard-footer">
    <div class="wizard-footer__left">
      @if (currentStep() > 0) {
        <button class="btn btn--outline" (click)="prevStep()">
          <lucide-icon [name]="ICONS.CHEVRON_LEFT" [size]="16" />
          Előző
        </button>
      }
    </div>
    <div class="wizard-footer__right">
      @if (isEditMode() && canFinalize()) {
        <button
          class="btn btn--confirm"
          [disabled]="submitting()"
          (click)="finalize()"
        >
          @if (submitting()) {
            <div class="spinner spinner--small spin"></div>
            Mentés...
          } @else {
            <lucide-icon [name]="ICONS.CHECK" [size]="16" />
            Mentés
          }
        </button>
      }
      @if (currentStep() < steps.length - 1) {
        <button
          class="btn btn--purple"
          [disabled]="!isStepValid()"
          (click)="nextStep()"
        >
          Következő
          <lucide-icon [name]="ICONS.CHEVRON_RIGHT" [size]="16" />
        </button>
      } @else {
        <button
          class="btn btn--purple"
          [disabled]="!canFinalize() || submitting()"
          (click)="finalize()"
        >
          @if (submitting()) {
            <div class="spinner spinner--small spin"></div>
            Mentés...
          } @else {
            <lucide-icon [name]="ICONS.CHECK" [size]="16" />
            Megrendelés véglegesítése
          }
        </button>
      }
    </div>
  </div>
</app-dialog-wrapper>
