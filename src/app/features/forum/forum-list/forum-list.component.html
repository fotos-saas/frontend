<!-- Guest Name Dialog -->
@if (showGuestNameDialog()) {
  <app-guest-name-dialog
    [isSubmitting]="isGuestRegistering()"
    [errorMessage]="guestError()"
    [canClose]="false"
    (resultEvent)="onGuestNameResult($event)"
  />
}

<!-- Create Discussion Dialog -->
@if (showCreateDialog()) {
  <app-create-discussion-dialog
    (resultEvent)="onCreateDiscussionResult($event)"
  />
}

<div class="forum-list page-card">
  <!-- Header -->
  <header class="forum-list__header">
    <div class="forum-list__title-wrap">
      <h1 class="forum-list__title">Beszélgetések</h1>
      <p class="forum-list__subtitle">Az osztály közös fóruma</p>
    </div>

    <!-- Create button (kapcsolattartó) -->
    @if (hasFullAccess()) {
      <button
        class="forum-list__create-btn"
        (click)="createDiscussion()"
        aria-label="Új beszélgetés indítása"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Új téma
      </button>
    }
  </header>

  <!-- Search & Filters -->
  <app-forum-search
    [templates]="templates()"
    (filtersChange)="onFiltersChange($event)"
  />

  <!-- Loading Skeleton -->
  @if (isLoading()) {
    <div class="forum-list__skeleton" role="status" aria-live="polite" aria-label="Beszélgetések betöltése...">
      <!-- Skeleton Card 1 -->
      <div class="forum-list__skeleton-card" aria-hidden="true">
        <div class="forum-list__skeleton-header">
          <div class="forum-list__skeleton-template skeleton-shimmer"></div>
          <div class="forum-list__skeleton-meta">
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
          </div>
        </div>
        <div class="forum-list__skeleton-title skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-footer">
          <div class="forum-list__skeleton-author">
            <div class="forum-list__skeleton-avatar skeleton-shimmer"></div>
            <div class="forum-list__skeleton-name skeleton-shimmer"></div>
          </div>
          <div class="forum-list__skeleton-date skeleton-shimmer"></div>
        </div>
      </div>
      <!-- Skeleton Card 2 -->
      <div class="forum-list__skeleton-card" aria-hidden="true">
        <div class="forum-list__skeleton-header">
          <div class="forum-list__skeleton-template skeleton-shimmer"></div>
          <div class="forum-list__skeleton-meta">
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
          </div>
        </div>
        <div class="forum-list__skeleton-title skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-footer">
          <div class="forum-list__skeleton-author">
            <div class="forum-list__skeleton-avatar skeleton-shimmer"></div>
            <div class="forum-list__skeleton-name skeleton-shimmer"></div>
          </div>
          <div class="forum-list__skeleton-date skeleton-shimmer"></div>
        </div>
      </div>
      <!-- Skeleton Card 3 -->
      <div class="forum-list__skeleton-card" aria-hidden="true">
        <div class="forum-list__skeleton-header">
          <div class="forum-list__skeleton-template skeleton-shimmer"></div>
          <div class="forum-list__skeleton-meta">
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
            <div class="forum-list__skeleton-meta-item skeleton-shimmer"></div>
          </div>
        </div>
        <div class="forum-list__skeleton-title skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-preview skeleton-shimmer"></div>
        <div class="forum-list__skeleton-footer">
          <div class="forum-list__skeleton-author">
            <div class="forum-list__skeleton-avatar skeleton-shimmer"></div>
            <div class="forum-list__skeleton-name skeleton-shimmer"></div>
          </div>
          <div class="forum-list__skeleton-date skeleton-shimmer"></div>
        </div>
      </div>
    </div>
  }

  <!-- Error -->
  @if (errorMessage() && !isLoading()) {
    <div class="forum-list__error" role="alert">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <p>{{ errorMessage() }}</p>
      <button (click)="loadDiscussions()" aria-label="Beszélgetések újratöltése">Újrapróbálkozás</button>
    </div>
  }

  <!-- Main content with sidebar -->
  @if (!isLoading() && !errorMessage()) {
    <div class="forum-list__layout">
      <!-- Main content -->
      <div class="forum-list__main">
        <!-- Empty state -->
        @if (discussions().length === 0) {
          <div class="forum-list__empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
            <h3>Még nincsenek beszélgetések</h3>
            <p>Légy az első, aki témát indít!</p>
            @if (hasFullAccess()) {
              <button (click)="createDiscussion()" aria-label="Új beszélgetés indítása">
                Új téma létrehozása
              </button>
            }
          </div>
        }

        <!-- Discussions list -->
        @if (discussions().length > 0) {
          <div class="forum-list__content">
            <!-- Pinned discussions -->
            @if (pinnedDiscussions().length > 0) {
              <section class="forum-list__section">
                <h2 class="forum-list__section-title">
                  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                  </svg>
                  Kitűzött témák
                </h2>
                <div class="forum-list__discussions">
                  @for (discussion of pinnedDiscussions(); track discussion.id) {
                    <app-forum-card
                      [discussion]="discussion"
                      (click)="openDiscussion(discussion)"
                    />
                  }
                </div>
              </section>
            }

            <!-- Regular discussions -->
            @if (regularDiscussions().length > 0) {
              <section class="forum-list__section">
                @if (pinnedDiscussions().length > 0) {
                  <h2 class="forum-list__section-title">
                    Összes téma
                  </h2>
                }
                <div class="forum-list__discussions">
                  @for (discussion of regularDiscussions(); track discussion.id) {
                    <app-forum-card
                      [discussion]="discussion"
                      (click)="openDiscussion(discussion)"
                    />
                  }
                </div>
              </section>
            }
          </div>
        }
      </div>

    </div>
  }
</div>
