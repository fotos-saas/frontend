@if (isOpen()) {
  <div class="chatbot-panel" role="complementary" aria-label="Tabi segítő">
    <!-- Header -->
    <header class="chatbot-panel__header">
      <div class="header-left">
        <lucide-icon [name]="ICONS.MESSAGE_CIRCLE" [size]="20" />
        <h2>Tabi</h2>
      </div>
      <div class="header-actions">
        <button
          class="icon-btn"
          matTooltip="Új beszélgetés"
          (click)="startNewConversation()"
        >
          <lucide-icon [name]="ICONS.PLUS" [size]="18" />
        </button>
        <button
          class="icon-btn"
          matTooltip="Bezárás"
          (click)="closePanel.emit()"
        >
          <lucide-icon [name]="ICONS.X" [size]="18" />
        </button>
      </div>
    </header>

    <!-- Messages -->
    <div class="chatbot-panel__messages" #messagesContainer>
      @if (!hasMessages()) {
        <!-- Empty state -->
        <div class="empty-state">
          <h3>Miben segíthetek?</h3>
          <p>Kérdezz bármit a TablóStúdió működéséről!</p>

          <button class="contact-btn" (click)="contactDialogOpen.set(true)">
            <lucide-icon [name]="ICONS.PHONE" [size]="16" />
            Kapcsolat
          </button>

          <div class="suggested-questions">
            @for (question of suggestedQuestions(); track question) {
              <button
                class="suggested-btn"
                (click)="sendMessage(question)"
              >
                {{ question }}
              </button>
            }
          </div>
        </div>
      } @else {
        @for (msg of messages(); track msg.timestamp) {
          <app-chatbot-message
            [role]="msg.role"
            [content]="msg.content"
            [timestamp]="msg.timestamp"
          />
        }
      }

      <!-- Loading indicator -->
      @if (isLoading()) {
        <div class="typing-indicator">
          <div class="typing-indicator__avatar">
            <span class="avatar avatar--tabi">&#10022;</span>
          </div>
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      }

      <!-- Error message -->
      @if (errorMessage()) {
        <div class="error-msg">
          <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="16" />
          <span>{{ errorMessage() }}</span>
        </div>
      }
    </div>

    <!-- Contact link (chat közben is elérhető) -->
    @if (hasMessages()) {
      <button class="contact-inline-btn" (click)="contactDialogOpen.set(true)">
        <lucide-icon [name]="ICONS.PHONE" [size]="14" />
        Kapcsolat
      </button>
    }

    <!-- Input -->
    <footer class="chatbot-panel__input">
      <textarea
        class="chat-input"
        [value]="inputText()"
        (input)="inputText.set($any($event.target).value)"
        (keydown)="onKeyDown($event)"
        placeholder="Írj egy üzenetet..."
        rows="1"
        [disabled]="isLoading()"
      ></textarea>
      <button
        class="send-btn"
        [disabled]="!inputText().trim() || isLoading()"
        (click)="sendMessage()"
        matTooltip="Küldés"
      >
        <lucide-icon [name]="ICONS.SEND" [size]="18" />
      </button>
    </footer>
  </div>
}

<!-- Contact dialog -->
@if (contactDialogOpen()) {
  <div class="dialog-backdrop contact-dialog-backdrop" (mousedown)="backdropHandler.onMouseDown($event)"
       (click)="backdropHandler.onClick($event)">
    <div class="contact-dialog dialog-panel">
      <div class="contact-dialog__header">
        <h3>Kapcsolat</h3>
        <button class="contact-dialog__close" (click)="contactDialogOpen.set(false)">
          <lucide-icon [name]="ICONS.X" [size]="18" />
        </button>
      </div>

      <!-- Fotos (partner) szekció -->
      @if (hasContactInfo()) {
        <div class="contact-dialog__section">
          <span class="contact-dialog__label">Fotos</span>
          <div class="contact-dialog__item">
            <lucide-icon [name]="ICONS.USER" [size]="16" />
            <span>{{ project()?.partnerName }}</span>
          </div>
          @if (project()?.partnerPhone) {
            <a [href]="'tel:' + project()?.partnerPhone" class="contact-dialog__item contact-dialog__link">
              <lucide-icon [name]="ICONS.PHONE" [size]="16" />
              <span>{{ project()?.partnerPhone }}</span>
            </a>
          }
          @if (project()?.partnerEmail) {
            <button class="contact-dialog__item contact-dialog__link"
                    (click)="copyEmail(project()!.partnerEmail!)">
              <lucide-icon [name]="ICONS.MAIL" [size]="16" />
              <span>{{ project()?.partnerEmail }}</span>
              <lucide-icon [name]="ICONS.COPY" [size]="12" class="contact-dialog__copy" />
            </button>
          }
        </div>
      }

      <!-- Tablokeszito szekció -->
      <div class="contact-dialog__section">
        <span class="contact-dialog__label">Tablokeszito</span>
        <div class="contact-dialog__item">
          <lucide-icon [name]="ICONS.USER" [size]="16" />
          <span>Nove Ferenc</span>
        </div>
        <a href="tel:+36706328131" class="contact-dialog__item contact-dialog__link">
          <lucide-icon [name]="ICONS.PHONE" [size]="16" />
          <span>06 70 632 8131</span>
        </a>
        <button class="contact-dialog__item contact-dialog__link"
                (click)="copyEmail('info@tablostudio.hu')">
          <lucide-icon [name]="ICONS.MAIL" [size]="16" />
          <span>info&#64;tablostudio.hu</span>
          <lucide-icon [name]="ICONS.COPY" [size]="12" class="contact-dialog__copy" />
        </button>
      </div>
    </div>
  </div>
}
