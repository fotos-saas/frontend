<div class="subscriber-detail-page page-card">
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <button class="back-btn" (click)="goBack()" matTooltip="Vissza a listához">
        <lucide-icon [name]="ICONS.ARROW_LEFT" [size]="18" />
      </button>
      <div class="header-content">
        <h1>Előfizető részletei</h1>
        @if (subscriber(); as sub) {
          <p class="subtitle">{{ sub.name }} - {{ sub.email }}</p>
        }
      </div>
    </div>
  </header>

  @if (loading()) {
    <div class="loading-state">
      @for (i of [1, 2, 3]; track i) {
        <div class="skeleton-card skeleton-shimmer"></div>
      }
    </div>
  } @else if (error()) {
    <div class="error-state">
      <div class="error-state__icon">
        <lucide-icon [name]="ICONS.ALERT_CIRCLE" [size]="56" />
      </div>
      <h3 class="error-state__title">Hiba történt</h3>
      <p class="error-state__message">{{ error() }}</p>
      <p class="error-state__hint">Próbáld újra később, vagy lépj vissza a listához.</p>
      <div class="error-state__actions">
        <button class="btn-secondary" (click)="goBack()">
          <lucide-icon [name]="ICONS.ARROW_LEFT" [size]="18" />
          Vissza a listához
        </button>
        <button class="btn-primary" (click)="retryLoad()">
          <lucide-icon [name]="ICONS.REFRESH" [size]="18" />
          Újrapróbálás
        </button>
      </div>
    </div>
  } @else if (subscriber(); as sub) {
    <div class="content-grid">
      <!-- Partner adatok -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.USER" [size]="20" />
          Partner adatok
        </h2>
        <div class="data-grid">
          <div class="data-item">
            <span class="data-label">Név</span>
            <span class="data-value">{{ sub.name }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">Email</span>
            <span class="data-value">{{ sub.email }}</span>
          </div>
          @if (sub.companyName) {
            <div class="data-item">
              <span class="data-label">Cégnév</span>
              <span class="data-value">{{ sub.companyName }}</span>
            </div>
          }
          @if (sub.taxNumber) {
            <div class="data-item">
              <span class="data-label">Adószám</span>
              <span class="data-value">{{ sub.taxNumber }}</span>
            </div>
          }
          @if (sub.phone) {
            <div class="data-item">
              <span class="data-label">Telefon</span>
              <span class="data-value">{{ sub.phone }}</span>
            </div>
          }
        </div>
      </section>

      <!-- Számlázási cím -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.BUILDING" [size]="20" />
          Számlázási cím
        </h2>
        <div class="data-grid">
          @if (sub.billingCountry) {
            <div class="data-item">
              <span class="data-label">Ország</span>
              <span class="data-value">{{ sub.billingCountry }}</span>
            </div>
          }
          @if (sub.billingPostalCode) {
            <div class="data-item">
              <span class="data-label">Irányítószám</span>
              <span class="data-value">{{ sub.billingPostalCode }}</span>
            </div>
          }
          @if (sub.billingCity) {
            <div class="data-item">
              <span class="data-label">Város</span>
              <span class="data-value">{{ sub.billingCity }}</span>
            </div>
          }
          @if (sub.billingAddress) {
            <div class="data-item data-item--full">
              <span class="data-label">Cím</span>
              <span class="data-value">{{ sub.billingAddress }}</span>
            </div>
          }
          @if (!sub.billingCountry && !sub.billingCity && !sub.billingAddress) {
            <p class="empty-text">Nincs megadva számlázási cím.</p>
          }
        </div>
      </section>

      <!-- Előfizetés adatok -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.CREDIT_CARD" [size]="20" />
          Előfizetés
        </h2>
        <div class="data-grid">
          <div class="data-item">
            <span class="data-label">Csomag</span>
            <span class="data-value">
              <span class="plan-badge" [ngClass]="getPlanClass(sub.plan)">
                {{ sub.planName }}
              </span>
            </span>
          </div>
          <div class="data-item">
            <span class="data-label">Számlázási ciklus</span>
            <span class="data-value">{{ sub.billingCycle === 'yearly' ? 'Éves' : 'Havi' }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">Ár</span>
            <span class="data-value data-value--price" [class.data-value--strikethrough]="sub.activeDiscount">
              {{ formatPrice(sub.price, sub.billingCycle) }}
            </span>
          </div>
          @if (sub.activeDiscount) {
            <div class="data-item">
              <span class="data-label">Kedvezmény</span>
              <div class="discount-display">
                <span class="discount-badge">
                  <lucide-icon [name]="ICONS.PERCENT" [size]="14" />
                  {{ sub.activeDiscount.percent }}%
                </span>
                @if (sub.activeDiscount.validUntil) {
                  <span class="discount-until">{{ formatDate(sub.activeDiscount.validUntil) }}-ig</span>
                } @else {
                  <span class="discount-forever">örök</span>
                }
                @if (sub.activeDiscount.note) {
                  <lucide-icon
                    [name]="ICONS.INFO"
                    [size]="14"
                    [matTooltip]="sub.activeDiscount.note"
                    class="discount-note-icon"
                  />
                }
              </div>
            </div>
            <div class="data-item">
              <span class="data-label">Kedvezményes ár</span>
              <span class="data-value data-value--price data-value--discounted">
                {{ formatDiscountedPrice(sub) }}
              </span>
            </div>
          }
          <div class="data-item">
            <span class="data-label">Státusz</span>
            <span class="data-value">
              <span class="status-badge" [ngClass]="getStatusClass(sub.subscriptionStatus)">
                {{ getStatusLabel(sub.subscriptionStatus) }}
              </span>
              @if (sub.subscriptionStatus === 'trial' && sub.trialDaysRemaining !== null) {
                <span class="trial-remaining">({{ sub.trialDaysRemaining }} nap van hátra)</span>
              }
            </span>
          </div>
          <div class="data-item">
            <span class="data-label">Előfizetés kezdete</span>
            <span class="data-value">{{ formatDate(sub.subscriptionStartedAt) }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">Következő terhelés/lejárat</span>
            <span class="data-value">{{ formatDate(sub.subscriptionEndsAt) }}</span>
          </div>
        </div>
      </section>

      <!-- Stripe adatok -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.WALLET" [size]="20" />
          Stripe
        </h2>
        <div class="data-grid">
          <div class="data-item">
            <span class="data-label">Customer ID</span>
            @if (sub.stripeCustomerId) {
              <a [href]="getStripeCustomerUrl()" target="_blank" rel="noopener" class="stripe-link">
                {{ sub.stripeCustomerId }}
                <lucide-icon [name]="ICONS.EXTERNAL_LINK" [size]="14" />
              </a>
            } @else {
              <span class="data-value data-value--empty">Nincs</span>
            }
          </div>
          <div class="data-item">
            <span class="data-label">Subscription ID</span>
            @if (sub.stripeSubscriptionId) {
              <a [href]="getStripeSubscriptionUrl()" target="_blank" rel="noopener" class="stripe-link">
                {{ sub.stripeSubscriptionId }}
                <lucide-icon [name]="ICONS.EXTERNAL_LINK" [size]="14" />
              </a>
            } @else {
              <span class="data-value data-value--empty">Nincs</span>
            }
          </div>
        </div>
      </section>

      <!-- Csomag limitek -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.PACKAGE" [size]="20" />
          Csomag limitek
        </h2>
        <div class="data-grid">
          <div class="data-item">
            <span class="data-label">Tárhely limit</span>
            <span class="data-value">{{ sub.storageLimitGb ?? '-' }} GB</span>
          </div>
          <div class="data-item">
            <span class="data-label">Max. osztályok</span>
            <span class="data-value">{{ sub.maxClasses ?? 'Korlátlan' }}</span>
          </div>
          @if (sub.features && sub.features.length > 0) {
            <div class="data-item data-item--full">
              <span class="data-label">Funkciók</span>
              <div class="features-list">
                @for (feature of sub.features; track feature) {
                  <span class="feature-tag">{{ feature }}</span>
                }
              </div>
            </div>
          }
        </div>
      </section>

      <!-- Regisztráció -->
      <section class="card">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.CALENDAR" [size]="20" />
          Regisztráció
        </h2>
        <div class="data-grid">
          <div class="data-item">
            <span class="data-label">Regisztráció dátuma</span>
            <span class="data-value">{{ formatDateTime(sub.createdAt) }}</span>
          </div>
        </div>
      </section>

      <!-- Akció gombok -->
      <section class="card card--actions">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.SETTINGS" [size]="20" />
          Műveletek
        </h2>
        <div class="actions-grid">
          <button
            class="detail-btn detail-btn--primary"
            (click)="openChargeDialog()"
            [disabled]="!sub.stripeCustomerId"
            [matTooltip]="!sub.stripeCustomerId ? 'Nincs Stripe customer' : 'Manuális számla létrehozása'"
          >
            <lucide-icon [name]="ICONS.CREDIT_CARD" [size]="18" />
            Manuális terhelés
          </button>

          <button
            class="detail-btn detail-btn--secondary"
            (click)="openChangePlanDialog()"
            matTooltip="Csomag és számlázási ciklus módosítása"
          >
            <lucide-icon [name]="ICONS.PACKAGE" [size]="18" />
            Csomag váltás
          </button>

          <button
            class="detail-btn detail-btn--secondary"
            (click)="openDiscountDialog()"
            matTooltip="Egyedi kedvezmény beállítása"
          >
            <lucide-icon [name]="ICONS.PERCENT" [size]="18" />
            {{ sub.activeDiscount ? 'Kedvezmény módosítása' : 'Kedvezmény beállítása' }}
          </button>

          @if (sub.activeDiscount) {
            <button
              class="detail-btn detail-btn--danger-outline"
              (click)="openRemoveDiscountDialog()"
              matTooltip="Kedvezmény eltávolítása"
            >
              <lucide-icon [name]="ICONS.X" [size]="18" />
              Kedvezmény törlése
            </button>
          }

          @if (sub.subscriptionStatus !== 'canceled' && sub.subscriptionStatus !== 'canceling') {
            <button
              class="detail-btn detail-btn--danger"
              (click)="openCancelDialog(false)"
              matTooltip="Előfizetés törlése a periódus végén"
            >
              <lucide-icon [name]="ICONS.X_CIRCLE" [size]="18" />
              Törlés (periódus végén)
            </button>

            <button
              class="detail-btn detail-btn--danger-outline"
              (click)="openCancelDialog(true)"
              matTooltip="Előfizetés azonnali törlése"
            >
              <lucide-icon [name]="ICONS.DELETE" [size]="18" />
              Azonnali törlés
            </button>
          }
        </div>
      </section>

      <!-- Audit log -->
      <section class="card card--full-width audit-section">
        <h2 class="card__title">
          <lucide-icon [name]="ICONS.HISTORY" [size]="20" />
          Admin műveletek napló
        </h2>

        <!-- Filter sáv -->
        <div class="audit-filters">
          <ps-input
            size="md"
            placeholder="Keresés admin név alapján..."
            [ngModel]="auditSearch()"
            (ngModelChange)="setAuditSearch($event)"
          />
          <ps-select
            size="sm"
            emptyLabel="Összes művelet"
            [options]="auditActionOptions"
            [ngModel]="auditActionFilter()"
            (ngModelChange)="setAuditActionFilter($event)"
          />
          <ps-toggle
            label="Megtekintések"
            [ngModel]="auditShowViews()"
            (ngModelChange)="toggleShowViews()"
          />
        </div>

        @if (auditLogsLoading()) {
          <div class="loading-state">
            @for (i of [1, 2, 3]; track i) {
              <div class="skeleton-row skeleton-shimmer"></div>
            }
          </div>
        } @else if (auditLogs().length === 0) {
          <p class="empty-text">{{ auditSearch() || auditActionFilter() ? 'Nincs a szűrésnek megfelelő bejegyzés.' : 'Még nincs bejegyzés.' }}</p>
        } @else {
          <!-- Táblázat fejléc -->
          <div class="table-header audit-table-header">
            <span class="th">Művelet</span>
            <span class="th">Részletek</span>
            <span class="th">Admin</span>
            <span class="th th-sortable" (click)="toggleAuditSort()" matTooltip="Rendezés dátum szerint">
              Dátum
              <lucide-icon [name]="auditSortDir() === 'desc' ? ICONS.ARROW_DOWN : ICONS.ARROW_UP" [size]="14" />
            </span>
          </div>
          <!-- Táblázat sorok -->
          <div class="row-grid">
            @for (log of auditLogs(); track log.id; let i = $index) {
              <div class="list-row audit-row" [style.animation-delay]="i * 0.03 + 's'">
                <span class="audit-cell">
                  <span class="audit-badge" [ngClass]="getActionClass(log.action)">
                    {{ log.actionLabel }}
                  </span>
                </span>
                <span class="audit-cell audit-cell--details">
                  @if (log.action === 'charge' && log.details) {
                    {{ log.details['amount'] }} Ft - {{ log.details['description'] }}
                  } @else if (log.action === 'change_plan' && log.details) {
                    {{ log.details['old_plan'] }} → {{ log.details['new_plan'] }}
                  } @else if (log.action === 'set_discount' && log.details) {
                    {{ log.details['percent'] }}%{{ log.details['duration_months'] ? ' (' + log.details['duration_months'] + ' hónap)' : ' (örök)' }}
                  } @else if (log.action === 'remove_discount' && log.details) {
                    {{ log.details['old_percent'] }}% törölve
                  } @else if (log.action === 'cancel_subscription' && log.details) {
                    {{ log.details['immediate'] ? 'Azonnali' : 'Periódus végén' }}
                  } @else {
                    <span class="text-muted">-</span>
                  }
                </span>
                <span class="audit-cell audit-cell--admin">
                  {{ log.adminName }}
                  @if (log.ipAddress) {
                    <span class="audit-ip">{{ log.ipAddress }}</span>
                  }
                </span>
                <span class="audit-cell audit-cell--date">{{ formatDateTime(log.createdAt) }}</span>
              </div>
            }
          </div>

          <!-- Paginálás -->
          @if (auditTotalPages() > 1) {
            <div class="pagination">
              <button
                class="page-btn"
                [disabled]="auditPage() === 1"
                (click)="goToAuditPage(auditPage() - 1)"
              >
                <lucide-icon [name]="ICONS.CHEVRON_LEFT" [size]="16" />
                Előző
              </button>

              <div class="page-info">
                {{ auditPage() }} / {{ auditTotalPages() }} oldal
                <span class="total-count">({{ auditTotal() }} bejegyzés)</span>
              </div>

              <button
                class="page-btn"
                [disabled]="auditPage() === auditTotalPages()"
                (click)="goToAuditPage(auditPage() + 1)"
              >
                Következő
                <lucide-icon [name]="ICONS.CHEVRON_RIGHT" [size]="16" />
              </button>
            </div>
          }
        }
      </section>
    </div>
  }
</div>

<!-- Dialógusok - page-card KÍVÜL! -->
@if (showChargeDialog() && subscriber(); as sub) {
  <app-charge-subscriber-dialog
    [subscriberId]="sub.id"
    [subscriberName]="sub.name"
    (close)="closeChargeDialog()"
    (charged)="onChargeComplete()"
  />
}

@if (showChangePlanDialog() && subscriber(); as sub) {
  <app-change-plan-dialog
    [subscriberId]="sub.id"
    [subscriberName]="sub.name"
    [currentPlan]="sub.plan"
    [currentBillingCycle]="sub.billingCycle"
    (close)="closeChangePlanDialog()"
    (changed)="onPlanChangeComplete()"
  />
}

@if (showCancelDialog()) {
  <app-confirm-dialog
    [title]="cancelImmediate() ? 'Azonnali törlés' : 'Előfizetés törlése'"
    [message]="cancelImmediate()
      ? 'Biztosan azonnal törölni szeretnéd az előfizetést? Ez a művelet visszavonhatatlan!'
      : 'Az előfizetés a jelenlegi periódus végén fog megszűnni. Biztosan folytatod?'"
    [confirmText]="cancelImmediate() ? 'Azonnali törlés' : 'Törlés periódus végén'"
    cancelText="Mégse"
    [confirmType]="cancelImmediate() ? 'danger' : 'warning'"
    [isSubmitting]="isSubmitting()"
    (resultEvent)="onCancelConfirm($event)"
  />
}

@if (showDiscountDialog() && subscriber(); as sub) {
  <app-discount-dialog
    [subscriberId]="sub.id"
    [subscriberName]="sub.name"
    [currentDiscount]="sub.activeDiscount?.percent ?? null"
    (close)="closeDiscountDialog()"
    (saved)="onDiscountSaved($event)"
  />
}

@if (showRemoveDiscountDialog() && subscriber(); as sub) {
  <app-confirm-dialog
    title="Kedvezmény törlése"
    [message]="'Biztosan törölni szeretnéd a ' + sub.activeDiscount?.percent + '% kedvezményt? A következő számlázási ciklustól az eredeti ár kerül felszámításra.'"
    confirmText="Kedvezmény törlése"
    cancelText="Mégse"
    confirmType="danger"
    [isSubmitting]="isSubmitting()"
    (resultEvent)="onRemoveDiscountConfirm($event)"
  />
}
