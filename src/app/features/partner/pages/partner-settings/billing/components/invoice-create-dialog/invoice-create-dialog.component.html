<div
  class="dialog-backdrop"
  (mousedown)="backdropHandler.onMouseDown($event)"
  (click)="backdropHandler.onClick($event)"
>
  <div class="dialog-panel dialog-panel--lg">
    <div class="dialog-header">
      <h2>Új számla</h2>
      <button class="close-btn" (click)="close.emit()">
        <lucide-icon [name]="ICONS.X" [size]="18" />
      </button>
    </div>

    <div class="dialog-body">
      <!-- Típus -->
      <ps-select
        label="Számla típus"
        [options]="typeOptions"
        [ngModel]="type()"
        (ngModelChange)="type.set($event)" />

      <!-- Vevő adatok -->
      <div class="form-section">
        <h3 class="form-section-title">Vevő adatok</h3>
        <div class="form-row">
          <div class="form-group form-group--half">
            <ps-input
              label="Név"
              [required]="true"
              placeholder="Vevő neve"
              [ngModel]="customerName()"
              (ngModelChange)="customerName.set($event)" />
          </div>
          <div class="form-group form-group--half">
            <ps-input
              label="Email"
              type="email"
              placeholder="vevo@email.hu"
              [ngModel]="customerEmail()"
              (ngModelChange)="customerEmail.set($event)" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group form-group--half">
            <ps-input
              label="Adószám"
              placeholder="12345678-1-42"
              [ngModel]="customerTaxNumber()"
              (ngModelChange)="customerTaxNumber.set($event)" />
          </div>
          <div class="form-group form-group--half">
            <ps-input
              label="Cím"
              placeholder="1234 Budapest, Példa u. 1."
              [ngModel]="customerAddress()"
              (ngModelChange)="customerAddress.set($event)" />
          </div>
        </div>
      </div>

      <!-- Dátumok -->
      <div class="form-section">
        <h3 class="form-section-title">Dátumok</h3>
        <div class="form-row form-row--three">
          <div class="form-group">
            <ps-datepicker
              label="Kiállítás"
              [ngModel]="issueDate()"
              (ngModelChange)="issueDate.set($event)" />
          </div>
          <div class="form-group">
            <ps-datepicker
              label="Teljesítés"
              [ngModel]="fulfillmentDate()"
              (ngModelChange)="fulfillmentDate.set($event)" />
          </div>
          <div class="form-group">
            <ps-datepicker
              label="Fizetési határidő"
              [ngModel]="dueDate()"
              (ngModelChange)="dueDate.set($event)" />
          </div>
        </div>
      </div>

      <!-- Tételek -->
      <div class="form-section">
        <div class="form-section-header">
          <h3 class="form-section-title">Tételek</h3>
          <button class="add-item-btn" (click)="addItem()">
            <lucide-icon [name]="ICONS.PLUS" [size]="14" />
            Tétel hozzáadása
          </button>
        </div>

        @for (item of items(); track $index; let i = $index) {
          <div class="item-row">
            <div class="item-main">
              <input type="text" class="text-input item-name" [value]="item.name" (input)="updateItem(i, 'name', $any($event.target).value)" placeholder="Megnevezés *" />
              <input type="number" class="number-input item-qty" [value]="item.quantity" (input)="updateItem(i, 'quantity', +$any($event.target).value)" min="0.01" step="1" />
              <select class="select-input item-unit" [value]="item.unit" (change)="updateItem(i, 'unit', $any($event.target).value)">
                <option value="db">db</option>
                <option value="ora">óra</option>
                <option value="alkalom">alkalom</option>
                <option value="csomag">csomag</option>
              </select>
              <input type="number" class="number-input item-price" [value]="item.unitPrice" (input)="updateItem(i, 'unitPrice', +$any($event.target).value)" min="0" step="100" placeholder="Egységár" />
              <span class="item-total">{{ formatAmount(item.quantity * item.unitPrice) }}</span>
              @if (items().length > 1) {
                <button class="remove-item-btn" (click)="removeItem(i)">
                  <lucide-icon [name]="ICONS.DELETE" [size]="14" />
                </button>
              }
            </div>
          </div>
        }
      </div>

      <!-- Összesítő -->
      <div class="totals">
        <div class="total-row">
          <span>Nettó:</span>
          <span class="total-amount">{{ formatAmount(totals().net) }}</span>
        </div>
        <div class="total-row">
          <span>ÁFA ({{ vatPercentage }}%):</span>
          <span class="total-amount">{{ formatAmount(totals().vat) }}</span>
        </div>
        <div class="total-row total-row--gross">
          <span>Bruttó:</span>
          <span class="total-amount">{{ formatAmount(totals().gross) }}</span>
        </div>
      </div>

      <!-- Megjegyzés -->
      <ps-textarea
        label="Megjegyzés"
        [rows]="2"
        placeholder="Opcionális megjegyzés..."
        [ngModel]="comment()"
        (ngModelChange)="comment.set($event)" />

      <!-- Azonnali küldés -->
      <div class="sync-toggle">
        <ps-toggle
          [label]="syncImmediately() ? 'Azonnali kiállítás' : 'Piszkozatként mentés'"
          [ngModel]="syncImmediately()"
          (ngModelChange)="syncImmediately.set($event)" />
      </div>
    </div>

    <div class="dialog-footer">
      <button class="cancel-btn" (click)="close.emit()">Mégse</button>
      <button class="submit-btn" (click)="submit()" [disabled]="saving()">
        @if (saving()) {
          <lucide-icon [name]="ICONS.LOADER" [size]="16" class="animate-spin" />
        }
        {{ syncImmediately() ? 'Kiállítás' : 'Mentés' }}
      </button>
    </div>
  </div>
</div>
